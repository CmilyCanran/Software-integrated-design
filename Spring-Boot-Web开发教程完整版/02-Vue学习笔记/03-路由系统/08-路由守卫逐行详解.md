---
tags:
  - è·¯ç”±å®ˆå«
  - beforeEach
  - æƒé™æ§åˆ¶
  - å¯¼èˆªå®ˆå«
  - Vue Router
  - Vue3
created: 2025-11-18
modified: 2025-11-18
category: Vueæ ¸å¿ƒæ¦‚å¿µ
difficulty: advanced
---

# è·¯ç”±å®ˆå«é€è¡Œè¯¦è§£

> **å­¦ä¹ ç›®æ ‡**ï¼šå½»åº•ç†è§£è·¯ç”±å®ˆå«çš„å·¥ä½œåŸç†ã€å‚æ•°å«ä¹‰å’Œæƒé™æ§åˆ¶é€»è¾‘

## ğŸ¯ å›é¡¾ä½ çš„é¡¹ç›®ä¸­çš„è·¯ç”±å®ˆå«

åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œè·¯ç”±å®ˆå«æ˜¯è¿™æ ·å®ç°çš„ï¼š

```javascript
// router/index.js
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore()

  // éœ€è¦ç™»å½•çš„é¡µé¢
  if (to.meta.requiresAuth && !authStore.isLoggedIn) {
    next('/login')
    return
  }

  // å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•/æ³¨å†Œé¡µé¢ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
  if (to.meta.guest && authStore.isLoggedIn) {
    next('/dashboard')
    return
  }

  next()
})
```

è¿™æ®µä»£ç æ˜¯æ•´ä¸ªè·¯ç”±ç³»ç»Ÿçš„æƒé™æ§åˆ¶æ ¸å¿ƒï¼Œè®©æˆ‘ä»¬é€è¡Œæ·±å…¥è§£æã€‚

---

## ğŸ”§ beforeEach å®ˆå«è¯¦è§£

### ğŸ“‹ å®ˆå«å‡½æ•°ç­¾å

```typescript
// beforeEachçš„TypeScriptç±»å‹å®šä¹‰
router.beforeEach(
  guard: (to: RouteLocationNormalized, from: RouteLocationNormalized, next: NavigationGuardNext) => void
): () => void

// å‚æ•°è¯¦è§£ï¼š
interface RouteLocationNormalized {
  path: string              // ğŸ”¥ ç›®æ ‡è·¯å¾„
  fullPath: string          // ğŸ”¥ å®Œæ•´è·¯å¾„ï¼ˆåŒ…å«æŸ¥è¯¢å‚æ•°ï¼‰
  name?: string             // ğŸ”¥ è·¯ç”±åç§°
  params: Record<string, any>  // ğŸ”¥ è·¯ç”±å‚æ•°
  query: Record<string, any>   // ğŸ”¥ æŸ¥è¯¢å‚æ•°
  hash: string              // ğŸ”¥ å“ˆå¸Œå€¼
  meta: Record<string, any>    // ğŸ”¥ å…ƒæ•°æ®
  matched: RouteRecord[]    // ğŸ”¥ åŒ¹é…çš„è·¯ç”±è®°å½•
}

type NavigationGuardNext = (to?: any) => void
```

---

## ğŸ§© ç¬¬ä¸€è¡Œï¼šå®ˆå«å‡½æ•°å®šä¹‰

```javascript
router.beforeEach((to, from, next) => {
```

### ğŸ” é€å‚æ•°è§£æ

#### **1. `router` å¯¹è±¡**

```javascript
// routeræ˜¯æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„è·¯ç”±å®ä¾‹
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [...]
})

// routerå¯¹è±¡åŒ…å«ï¼š
// - history: å†å²ç®¡ç†å¯¹è±¡
// - currentRoute: å½“å‰è·¯ç”±çš„å“åº”å¼å¼•ç”¨
// - options: è·¯ç”±é…ç½®é€‰é¡¹
// - matcher: è·¯ç”±åŒ¹é…å™¨
// - å„ç§å¯¼èˆªæ–¹æ³•ï¼ˆpush, replace, goç­‰ï¼‰
```

#### **2. `beforeEach` æ–¹æ³•**

```javascript
// beforeEachæ˜¯å…¨å±€å‰ç½®å®ˆå«çš„æ³¨å†Œæ–¹æ³•
// ä½œç”¨ï¼šåœ¨æ¯æ¬¡å¯¼èˆªå‰æ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°

// æ–¹æ³•ç­¾åï¼š
router.beforeEach(guard: NavigationGuard): () => void

// è¿”å›å€¼ï¼šä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨å®ƒå¯ä»¥ç§»é™¤è¿™ä¸ªå®ˆå«
const removeGuard = router.beforeEach((to, from, next) => {
  console.log('å¯¼èˆªå®ˆå«æ‰§è¡Œ')
})

// ç§»é™¤å®ˆå«ï¼š
removeGuard()
```

**beforeEachçš„æ‰§è¡Œæ—¶æœºï¼š**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant R as Router
    participant G as å®ˆå«
    participant N as nextå‡½æ•°
    participant V as View

    U->>R: å¯¼èˆªåˆ° /dashboard
    R->>G: è°ƒç”¨ beforeEach å®ˆå«
    G->>G: æ‰§è¡Œæƒé™æ£€æŸ¥é€»è¾‘
    G->>N: è°ƒç”¨ next()
    N->>R: ç»§ç»­å¯¼èˆªæµç¨‹
    R->>V: æ›´æ–° router-view
    V->>U: æ˜¾ç¤ºæ–°é¡µé¢
```

#### **3. `(to, from, next) => {}` ç®­å¤´å‡½æ•°**

```javascript
// è¿™æ˜¯ä¸€ä¸ªES6ç®­å¤´å‡½æ•°
// ç­‰ä»·äºä¼ ç»Ÿçš„functionå†™æ³•ï¼š

// ç®­å¤´å‡½æ•°ï¼ˆä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨ï¼‰ï¼š
router.beforeEach((to, from, next) => {
  // å®ˆå«é€»è¾‘
})

// ä¼ ç»Ÿå‡½æ•°å†™æ³•ï¼š
router.beforeEach(function(to, from, next) {
  // å®ˆå«é€»è¾‘
})

// ä¸ºä»€ä¹ˆç”¨ç®­å¤´å‡½æ•°ï¼Ÿ
// 1. è¯­æ³•æ›´ç®€æ´
// 2. æ²¡æœ‰è‡ªå·±çš„thisç»‘å®š
// 3. æ›´é€‚åˆå‡½æ•°å¼ç¼–ç¨‹é£æ ¼
```

---

## ğŸ¯ å®ˆå«å‚æ•°æ·±åº¦è§£æ

### ğŸ“ `to` å‚æ•°ï¼šç›®æ ‡è·¯ç”±å¯¹è±¡

```javascript
// to å‚æ•°è¡¨ç¤ºç”¨æˆ·æƒ³è¦å¯¼èˆªåˆ°çš„ç›®æ ‡è·¯ç”±
// å®ƒåŒ…å«äº†ç›®æ ‡è·¯ç”±çš„æ‰€æœ‰ä¿¡æ¯

// ç¤ºä¾‹ï¼šç”¨æˆ·è®¿é—® /dashboard?id=123#section
const to = {
  path: '/dashboard',                    // ğŸ”¥ è·¯ç”±è·¯å¾„
  fullPath: '/dashboard?id=123#section', // ğŸ”¥ å®Œæ•´URL
  name: 'dashboard',                     // ğŸ”¥ è·¯ç”±åç§°ï¼ˆå¦‚æœå®šä¹‰äº†ï¼‰
  params: {},                            // ğŸ”¥ è·¯ç”±å‚æ•°ï¼ˆå¦‚ /user/:id ä¸­çš„ idï¼‰
  query: { id: '123' },                  // ğŸ”¥ æŸ¥è¯¢å‚æ•°ï¼ˆ?id=123ï¼‰
  hash: '#section',                      // ğŸ”¥ å“ˆå¸Œå€¼ï¼ˆ#sectionï¼‰
  meta: { requiresAuth: true },          // ğŸ”¥ å…ƒæ•°æ®
  matched: [                             // ğŸ”¥ åŒ¹é…çš„è·¯ç”±è®°å½•æ•°ç»„
    {
      path: '/dashboard',
      components: { default: DashboardComponent },
      meta: { requiresAuth: true }
    }
  ]
}
```

**toå‚æ•°çš„å®é™…åº”ç”¨ï¼š**

```javascript
// æ£€æŸ¥ç›®æ ‡è·¯ç”±æ˜¯å¦éœ€è¦è®¤è¯
if (to.meta.requiresAuth) {
  console.log('è¿™ä¸ªé¡µé¢éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®')
}

// è·å–è·¯ç”±å‚æ•°
if (to.params.id) {
  console.log('ç”¨æˆ·ID:', to.params.id)
}

// è·å–æŸ¥è¯¢å‚æ•°
if (to.query.redirect) {
  console.log('ç™»å½•åé‡å®šå‘åˆ°:', to.query.redirect)
}
```

### ğŸ“ `from` å‚æ•°ï¼šæ¥æºè·¯ç”±å¯¹è±¡

```javascript
// from å‚æ•°è¡¨ç¤ºç”¨æˆ·å½“å‰æ‰€åœ¨çš„è·¯ç”±
// å®ƒçš„ç»“æ„ä¸ to å‚æ•°å®Œå…¨ç›¸åŒ

// ç¤ºä¾‹ï¼šä» /login é¡µé¢å¯¼èˆªåˆ° /dashboard
const from = {
  path: '/login',
  fullPath: '/login?redirect=/dashboard',
  name: 'login',
  params: {},
  query: { redirect: '/dashboard' },
  hash: '',
  meta: { guest: true },
  matched: [
    {
      path: '/login',
      components: { default: LoginComponent },
      meta: { guest: true }
    }
  ]
}
```

**fromå‚æ•°çš„å®é™…åº”ç”¨ï¼š**

```javascript
// è®°å½•ç”¨æˆ·æ¥æº
console.log(`ç”¨æˆ·ä» ${from.path} å¯¼èˆªåˆ° ${to.path}`)

// æ ¹æ®æ¥æºæ‰§è¡Œä¸åŒé€»è¾‘
if (from.path === '/login' && to.path === '/dashboard') {
  console.log('ç”¨æˆ·æˆåŠŸç™»å½•')
}

// ä¿å­˜æ¥æºé¡µé¢ï¼ˆç”¨äºè¿”å›ï¼‰
const previousPage = from.fullPath
```

### ğŸ› ï¸ `next` å‚æ•°ï¼šå¯¼èˆªæ§åˆ¶å‡½æ•°

```javascript
// next æ˜¯æ§åˆ¶å¯¼èˆªæµç¨‹çš„å…³é”®å‡½æ•°
// å®ƒå†³å®šäº†å¯¼èˆªæ˜¯ç»§ç»­ã€ä¸­æ­¢è¿˜æ˜¯é‡å®šå‘

// next å‡½æ•°çš„ä¸‰ç§è°ƒç”¨æ–¹å¼ï¼š

// 1. next(): ç»§ç»­å¯¼èˆª
next()  // ç»§ç»­æ‰§è¡Œå¯¼èˆªæµç¨‹

// 2. next(false): ä¸­æ­¢å¯¼èˆª
next(false)  // å–æ¶ˆå½“å‰å¯¼èˆªï¼Œåœç•™åœ¨å½“å‰é¡µé¢

// 3. next('/path'): é‡å®šå‘åˆ°å…¶ä»–è·¯å¾„
next('/login')  // é‡å®šå‘åˆ°ç™»å½•é¡µ
next({ name: 'login' })  // ä¹Ÿå¯ä»¥ä½¿ç”¨è·¯ç”±å¯¹è±¡
```

**nextå‡½æ•°çš„è¯¦ç»†è¡Œä¸ºï¼š**

```javascript
// åœºæ™¯1ï¼šç»§ç»­å¯¼èˆª
router.beforeEach((to, from, next) => {
  if (to.path !== '/forbidden') {
    next()  // âœ… ç»§ç»­å¯¼èˆªåˆ°ç›®æ ‡é¡µé¢
  } else {
    next(false)  // âŒ å–æ¶ˆå¯¼èˆªï¼Œåœç•™åœ¨å½“å‰é¡µé¢
  }
})

// åœºæ™¯2ï¼šé‡å®šå‘å¯¼èˆª
router.beforeEach((to, from, next) => {
  if (to.meta.requiresAuth && !isLoggedIn) {
    next('/login')  // ğŸ”„ é‡å®šå‘åˆ°ç™»å½•é¡µ
  } else {
    next()  // âœ… ç»§ç»­å¯¼èˆª
  }
})

// åœºæ™¯3ï¼šä¼ é€’é”™è¯¯ä¿¡æ¯
router.beforeEach((to, from, next) => {
  if (hasError) {
    next(new Error('å¯¼èˆªå¤±è´¥'))  // âŒ å¯¼èˆªå¤±è´¥ï¼Œä¼ é€’é”™è¯¯
  } else {
    next()  // âœ… ç»§ç»­å¯¼èˆª
  }
})
```

---

## ğŸ›¡ï¸ ç¬¬äºŒè¡Œï¼šè·å–è®¤è¯çŠ¶æ€

```javascript
const authStore = useAuthStore()
```

### ğŸ” é€éƒ¨åˆ†è§£æ

#### **1. `useAuthStore` å‡½æ•°**

```javascript
// useAuthStore æ˜¯ Pinia çŠ¶æ€ç®¡ç†çš„é’©å­å‡½æ•°
// å®ƒè¿”å›è®¤è¯çŠ¶æ€ç®¡ç†çš„å®ä¾‹

// åœ¨ stores/auth.js ä¸­å®šä¹‰ï¼š
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    user: null,
    token: null,
    isLoggedIn: false
  }),

  actions: {
    login(credentials) {
      // ç™»å½•é€»è¾‘
    },
    logout() {
      // ç™»å‡ºé€»è¾‘
    }
  }
})
```

#### **2. `authStore` å¯¹è±¡**

```javascript
// authStore åŒ…å«äº†æ‰€æœ‰è®¤è¯ç›¸å…³çš„çŠ¶æ€å’Œæ–¹æ³•
const authStore = {
  // ğŸ”¥ çŠ¶æ€ï¼ˆå“åº”å¼ï¼‰
  user: {
    id: 1,
    username: 'å¼ ä¸‰',
    email: 'zhangsan@example.com',
    role: 'user'
  },
  token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  isLoggedIn: true,

  // ğŸ”¥ è®¡ç®—å±æ€§
  userInfo: computed(() => authStore.user),
  isAuthenticated: computed(() => authStore.isLoggedIn),

  // ğŸ”¥ æ–¹æ³•
  login: (credentials) => { /* ç™»å½•é€»è¾‘ */ },
  logout: () => { /* ç™»å‡ºé€»è¾‘ */ },
  updateProfile: (data) => { /* æ›´æ–°èµ„æ–™é€»è¾‘ */ }
}
```

**åœ¨å®ˆå«ä¸­ä½¿ç”¨authStoreçš„ä¼˜åŠ¿ï¼š**

```javascript
// 1. å“åº”å¼çŠ¶æ€
// å½“ç™»å½•çŠ¶æ€æ”¹å˜æ—¶ï¼Œå®ˆå«ä¼šè‡ªåŠ¨è·å–æœ€æ–°çŠ¶æ€

// 2. é›†ä¸­ç®¡ç†
// æ‰€æœ‰è®¤è¯é€»è¾‘éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œä¾¿äºç»´æŠ¤

// 3. ç±»å‹å®‰å…¨
// TypeScriptæ”¯æŒï¼Œå‡å°‘é”™è¯¯

// 4. æµ‹è¯•å‹å¥½
// å¯ä»¥è½»æ¾mock authStoreè¿›è¡Œå•å…ƒæµ‹è¯•
```

---

## ğŸ” ç¬¬ä¸‰è¡Œï¼šæƒé™æ£€æŸ¥é€»è¾‘

```javascript
// éœ€è¦ç™»å½•çš„é¡µé¢
if (to.meta.requiresAuth && !authStore.isLoggedIn) {
  next('/login')
  return
}
```

### ğŸ” é€éƒ¨åˆ†è§£æ

#### **1. æ¡ä»¶åˆ¤æ–­ï¼š`to.meta.requiresAuth && !authStore.isLoggedIn`**

```javascript
// è¿™æ˜¯ä¸€ä¸ªé€»è¾‘ä¸ï¼ˆANDï¼‰æ¡ä»¶
// ä¸¤ä¸ªæ¡ä»¶éƒ½å¿…é¡»ä¸ºtrueï¼Œæ•´ä¸ªè¡¨è¾¾å¼æ‰ä¸ºtrue

// æ¡ä»¶åˆ†è§£ï¼š
// æ¡ä»¶1: to.meta.requiresAuth
// æ¡ä»¶2: !authStore.isLoggedIn

// çœŸå€¼è¡¨ï¼š
// requiresAuth | isLoggedIn | !isLoggedIn | ç»“æœ
//     true     |    true     |   false     | false
//     true     |   false     |    true     | true
//     false    |    true     |   false     | false
//     false    |   false     |    true     | false
```

#### **2. `to.meta.requiresAuth` æ£€æŸ¥**

```javascript
// æ£€æŸ¥ç›®æ ‡è·¯ç”±æ˜¯å¦éœ€è¦è®¤è¯
// è¿™ä¸ªå€¼åœ¨è·¯ç”±é…ç½®ä¸­å®šä¹‰

// è·¯ç”±é…ç½®ç¤ºä¾‹ï¼š
const routes = [
  {
    path: '/dashboard',
    component: Dashboard,
    meta: {
      requiresAuth: true,  // ğŸ”¥ è¿™ä¸ªé¡µé¢éœ€è¦ç™»å½•
      title: 'ä»ªè¡¨æ¿'
    }
  },
  {
    path: '/login',
    component: Login,
    meta: {
      guest: true,         // ğŸ”¥ è¿™ä¸ªé¡µé¢åªå…è®¸æœªç™»å½•ç”¨æˆ·è®¿é—®
      title: 'ç™»å½•'
    }
  },
  {
    path: '/home',
    component: Home,
    meta: {
      title: 'é¦–é¡µ'        // ğŸ”¥ è¿™ä¸ªé¡µé¢æ²¡æœ‰requiresAuthï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®
    }
  }
]
```

**metaå­—æ®µçš„æ‰©å±•ä½¿ç”¨ï¼š**

```javascript
// æ›´å¤æ‚çš„æƒé™é…ç½®
{
  path: '/admin',
  component: AdminPanel,
  meta: {
    requiresAuth: true,    // éœ€è¦ç™»å½•
    roles: ['admin'],      // éœ€è¦ç®¡ç†å‘˜è§’è‰²
    permissions: ['read', 'write'],  // éœ€è¦è¯»å†™æƒé™
    title: 'ç®¡ç†å‘˜é¢æ¿'
  }
}
```

#### **3. `!authStore.isLoggedIn` æ£€æŸ¥**

```javascript
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœªç™»å½•
// ! æ˜¯é€»è¾‘éæ“ä½œç¬¦

// authStore.isLoggedIn çš„å¯èƒ½å€¼ï¼š
// true: ç”¨æˆ·å·²ç™»å½•
// false: ç”¨æˆ·æœªç™»å½•

// !authStore.isLoggedIn çš„ç»“æœï¼š
// !true = false  (ç”¨æˆ·å·²ç™»å½•)
// !false = true   (ç”¨æˆ·æœªç™»å½•)
```

**isLoggedInçŠ¶æ€çš„æ¥æºï¼š**

```javascript
// åœ¨ stores/auth.js ä¸­
export const useAuthStore = defineStore('auth', {
  state: () => ({
    token: null,
    user: null
  }),

  getters: {
    // ğŸ”¥ isLoggedIn æ˜¯ä¸€ä¸ªè®¡ç®—å±æ€§
    isLoggedIn: (state) => {
      return !!state.token && !!state.user
      // !! çš„ä½œç”¨ï¼šå°†å…¶ä»–ç±»å‹è½¬æ¢ä¸ºå¸ƒå°”å€¼
      // !!null = false
      // !!'string' = true
      // !!{} = true
    }
  },

  actions: {
    login(credentials) {
      // ç™»å½•æˆåŠŸå
      this.token = 'jwt_token_here'
      this.user = { id: 1, username: 'å¼ ä¸‰' }
      // æ­¤æ—¶ isLoggedIn ä¼šè‡ªåŠ¨å˜ä¸º true
    },

    logout() {
      // ç™»å‡ºæ—¶
      this.token = null
      this.user = null
      // æ­¤æ—¶ isLoggedIn ä¼šè‡ªåŠ¨å˜ä¸º false
    }
  }
})
```

#### **4. `next('/login')` é‡å®šå‘**

```javascript
// å½“æ¡ä»¶ä¸ºçœŸæ—¶æ‰§è¡Œé‡å®šå‘
// å°†ç”¨æˆ·å¯¼èˆªåˆ°ç™»å½•é¡µé¢

// é‡å®šå‘çš„è¯¦ç»†è¿‡ç¨‹ï¼š
// 1. å–æ¶ˆå½“å‰å¯¼èˆªï¼ˆå¦‚ /dashboardï¼‰
// 2. å¼€å§‹æ–°çš„å¯¼èˆªï¼ˆåˆ° /loginï¼‰
// 3. å†æ¬¡æ‰§è¡Œè·¯ç”±å®ˆå«
// 4. æ£€æŸ¥ /login çš„æƒé™ï¼ˆguest: trueï¼‰
// 5. å…è®¸è®¿é—®ç™»å½•é¡µé¢
```

#### **5. `return` è¯­å¥**

```javascript
// return çš„ä½œç”¨ï¼šç«‹å³é€€å‡ºå®ˆå«å‡½æ•°
// é˜²æ­¢æ‰§è¡Œåç»­ä»£ç 

// ä¸ºä»€ä¹ˆéœ€è¦ returnï¼Ÿ
if (to.meta.requiresAuth && !authStore.isLoggedIn) {
  next('/login')
  return  // ğŸ”¥ å¦‚æœæ²¡æœ‰ returnï¼Œä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç 
}

// æ²¡æœ‰ return çš„é—®é¢˜ï¼š
if (condition) {
  next('/login')  // é‡å®šå‘åˆ°ç™»å½•é¡µ
  // ç»§ç»­æ‰§è¡Œ...
}
next()  // è¿™è¡Œä¹Ÿä¼šæ‰§è¡Œï¼Œå¯¼è‡´æ··ä¹±
```

---

## ğŸ”„ ç¬¬å››è¡Œï¼šè®¿å®¢é¡µé¢æ£€æŸ¥

```javascript
// å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•/æ³¨å†Œé¡µé¢ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
if (to.meta.guest && authStore.isLoggedIn) {
  next('/dashboard')
  return
}
```

### ğŸ” é€éƒ¨åˆ†è§£æ

#### **1. æ¡ä»¶åˆ¤æ–­ï¼š`to.meta.guest && authStore.isLoggedIn`**

```javascript
// æ£€æŸ¥ç›®æ ‡é¡µé¢æ˜¯å¦åªå…è®¸è®¿å®¢è®¿é—®ï¼Œå¹¶ä¸”ç”¨æˆ·å·²ç»ç™»å½•

// æ¡ä»¶åˆ†è§£ï¼š
// æ¡ä»¶1: to.meta.guest (é¡µé¢æ˜¯å¦åªå…è®¸è®¿å®¢)
// æ¡ä»¶2: authStore.isLoggedIn (ç”¨æˆ·æ˜¯å¦å·²ç™»å½•)

// çœŸå€¼è¡¨ï¼š
// guest | isLoggedIn | ç»“æœ | è¡Œä¸º
// true  |    true     | true  | é‡å®šå‘åˆ°ä»ªè¡¨æ¿
// true  |   false     | false | å…è®¸è®¿é—®
// false |    true     | false | å…è®¸è®¿é—®
// false |   false     | false | å…è®¸è®¿é—®
```

#### **2. è®¿å®¢é¡µé¢çš„è®¾è®¡ç†å¿µ**

```javascript
// è®¿å®¢é¡µé¢ï¼ˆguest: trueï¼‰çš„è®¾è®¡ç›®çš„ï¼š
// 1. ç™»å½•é¡µé¢ - åªæœ‰æœªç™»å½•ç”¨æˆ·éœ€è¦çœ‹åˆ°
// 2. æ³¨å†Œé¡µé¢ - åªæœ‰æœªç™»å½•ç”¨æˆ·éœ€è¦çœ‹åˆ°
// 3. å¿˜è®°å¯†ç é¡µé¢ - åªæœ‰æœªç™»å½•ç”¨æˆ·éœ€è¦çœ‹åˆ°
// 4. æ¬¢è¿é¡µé¢ - å¯èƒ½åªå¯¹æœªç™»å½•ç”¨æˆ·æ˜¾ç¤º

// å·²ç™»å½•ç”¨æˆ·è®¿é—®è¿™äº›é¡µé¢æ²¡æœ‰æ„ä¹‰ï¼š
// - å·²ç»ç™»å½•äº†ï¼Œä¸éœ€è¦å†ç™»å½•
// - å·²ç»æœ‰è´¦å·äº†ï¼Œä¸éœ€è¦æ³¨å†Œ
// - åº”è¯¥ç›´æ¥è¿›å…¥åº”ç”¨çš„ä¸»è¦åŠŸèƒ½
```

#### **3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–**

```javascript
// è¿™ä¸ªæ£€æŸ¥æå‡äº†ç”¨æˆ·ä½“éªŒï¼š

// åœºæ™¯1ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œä½†æ‰‹åŠ¨è¾“å…¥ /login
// ç»“æœï¼šè‡ªåŠ¨é‡å®šå‘åˆ° /dashboard
// å¥½å¤„ï¼šé¿å…ç”¨æˆ·å›°æƒ‘ï¼Œç›´æ¥è¿›å…¥æœ‰ç”¨çš„é¡µé¢

// åœºæ™¯2ï¼šç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œæµè§ˆå™¨åé€€
// ç»“æœï¼šä¸ä¼šå›åˆ°ç™»å½•é¡µï¼Œè€Œæ˜¯ç•™åœ¨ä»ªè¡¨æ¿
// å¥½å¤„ï¼šé˜²æ­¢ç”¨æˆ·æ„å¤–"é€€å‡ºç™»å½•"

// åœºæ™¯3ï¼šç”¨æˆ·åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ç™»å½•é“¾æ¥
// ç»“æœï¼šå¦‚æœå·²ç»ç™»å½•ï¼Œç›´æ¥è¿›å…¥ä»ªè¡¨æ¿
// å¥½å¤„ï¼šæ— ç¼çš„ç”¨æˆ·ä½“éªŒ
```

---

## ğŸ ç¬¬äº”è¡Œï¼šç»§ç»­å¯¼èˆª

```javascript
next()
```

### ğŸ” é€éƒ¨åˆ†è§£æ

#### **1. `next()` çš„å«ä¹‰**

```javascript
// next() è¡¨ç¤ºï¼šç»§ç»­æ‰§è¡Œå¯¼èˆª
// è¿™æ˜¯å®ˆå«å‡½æ•°çš„"é€šè¡Œè¯"

// æ‰§è¡Œ next() åä¼šå‘ç”Ÿä»€ä¹ˆï¼š
// 1. è·¯ç”±ç³»ç»Ÿç»§ç»­å¤„ç†å¯¼èˆª
// 2. æ›´æ–°æµè§ˆå™¨URL
// 3. æ›´æ–° router.currentRoute
// 4. æ¸²æŸ“å¯¹åº”çš„ç»„ä»¶
// 5. æ‰§è¡Œ afterEach å®ˆå«ï¼ˆå¦‚æœæœ‰ï¼‰
```

#### **2. ä»€ä¹ˆæ—¶å€™ä¼šæ‰§è¡Œåˆ°è¿™ä¸€è¡Œï¼Ÿ**

```javascript
// åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‰ä¼šæ‰§è¡Œ next()ï¼š

// æƒ…å†µ1ï¼šä¸éœ€è¦æƒé™çš„é¡µé¢
// to.meta.requiresAuth = false
// ç»§ç»­æ‰§è¡Œåˆ° next()

// æƒ…å†µ2ï¼šéœ€è¦æƒé™ä½†ç”¨æˆ·å·²ç™»å½•
// to.meta.requiresAuth = true
// authStore.isLoggedIn = true
// ç»§ç»­æ‰§è¡Œåˆ° next()

// æƒ…å†µ3ï¼šè®¿å®¢é¡µé¢ä½†ç”¨æˆ·æœªç™»å½•
// to.meta.guest = true
// authStore.isLoggedIn = false
// ç»§ç»­æ‰§è¡Œåˆ° next()

// æƒ…å†µ4ï¼šæ™®é€šé¡µé¢ï¼ˆæ— ç‰¹æ®Šæƒé™è¦æ±‚ï¼‰
// ç»§ç»­æ‰§è¡Œåˆ° next()
```

#### **3. next() çš„å®‰å…¨æ€§**

```javascript
// next() æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºï¼š
// 1. å‰é¢çš„æ£€æŸ¥å·²ç»ç¡®ä¿äº†æƒé™æ­£ç¡®
// 2. ç”¨æˆ·è¢«å…è®¸è®¿é—®ç›®æ ‡é¡µé¢
// 3. è·¯ç”±ç³»ç»Ÿä¼šå¤„ç†æ‰€æœ‰å¿…è¦çš„æ›´æ–°

// å¦‚æœæ²¡æœ‰æƒé™æ£€æŸ¥ï¼Œç›´æ¥ next() çš„é£é™©ï¼š
router.beforeEach((to, from, next) => {
  // âŒ å±é™©ï¼šæ²¡æœ‰æƒé™æ£€æŸ¥
  // ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ä»»ä½•é¡µé¢
  next()
})
```

---

## ğŸ¯ å®Œæ•´çš„æƒé™æ§åˆ¶æµç¨‹

### ğŸ“‹ æ‰€æœ‰å¯èƒ½çš„è®¿é—®åœºæ™¯

```javascript
// åœºæ™¯1ï¼šæœªç™»å½•ç”¨æˆ·è®¿é—®ä»ªè¡¨æ¿
// è®¿é—®ï¼š/dashboard
// to.meta.requiresAuth = true
// authStore.isLoggedIn = false
// æ¡ä»¶1: true && true = true
// æ‰§è¡Œï¼šnext('/login') â†’ é‡å®šå‘åˆ°ç™»å½•é¡µ

// åœºæ™¯2ï¼šå·²ç™»å½•ç”¨æˆ·è®¿é—®ä»ªè¡¨æ¿
// è®¿é—®ï¼š/dashboard
// to.meta.requiresAuth = true
// authStore.isLoggedIn = true
// æ¡ä»¶1: true && false = false
// æ¡ä»¶2: false && true = false
// æ‰§è¡Œï¼šnext() â†’ å…è®¸è®¿é—®

// åœºæ™¯3ï¼šæœªç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µ
// è®¿é—®ï¼š/login
// to.meta.requiresAuth = false
// to.meta.guest = true
// authStore.isLoggedIn = false
// æ¡ä»¶1: false && false = false
// æ¡ä»¶2: true && false = false
// æ‰§è¡Œï¼šnext() â†’ å…è®¸è®¿é—®

// åœºæ™¯4ï¼šå·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µ
// è®¿é—®ï¼š/login
// to.meta.requiresAuth = false
// to.meta.guest = true
// authStore.isLoggedIn = true
// æ¡ä»¶1: false && false = false
// æ¡ä»¶2: true && true = true
// æ‰§è¡Œï¼šnext('/dashboard') â†’ é‡å®šå‘åˆ°ä»ªè¡¨æ¿

// åœºæ™¯5ï¼šè®¿é—®å…¬å…±é¡µé¢
// è®¿é—®ï¼š/home
// to.meta.requiresAuth = false
// to.meta.guest = false
// æ— è®ºç™»å½•çŠ¶æ€å¦‚ä½•
// æ‰§è¡Œï¼šnext() â†’ å…è®¸è®¿é—®
```

### ğŸ”„ æµç¨‹å›¾

```mermaid
graph TD
    A[ç”¨æˆ·è®¿é—®é¡µé¢] --> B{æ£€æŸ¥ to.meta.requiresAuth}
    B -->|true| C{ç”¨æˆ·å·²ç™»å½•?}
    B -->|false| D{æ£€æŸ¥ to.meta.guest}
    C -->|false| E[é‡å®šå‘åˆ° /login]
    C -->|true| D
    D -->|true| F{ç”¨æˆ·å·²ç™»å½•?}
    D -->|false| G[ç»§ç»­å¯¼èˆª]
    F -->|true| H[é‡å®šå‘åˆ° /dashboard]
    F -->|false| G
    E --> I[å¯¼èˆªç»“æŸ]
    H --> I
    G --> I
```

---

## ğŸ› ï¸ è¿›é˜¶ç”¨æ³•å’Œæœ€ä½³å®è·µ

### 1. ä¿å­˜é‡å®šå‘è·¯å¾„

```javascript
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore()

  if (to.meta.requiresAuth && !authStore.isLoggedIn) {
    // ğŸ”¥ ä¿å­˜ç”¨æˆ·æƒ³è¦è®¿é—®çš„é¡µé¢
    next({
      path: '/login',
      query: { redirect: to.fullPath }
    })
    return
  }

  // ç™»å½•æˆåŠŸåï¼Œé‡å®šå‘åˆ°ä¹‹å‰æƒ³è®¿é—®çš„é¡µé¢
  if (to.path === '/login' && to.query.redirect && authStore.isLoggedIn) {
    next(to.query.redirect)
    return
  }

  next()
})
```

### 2. è§’è‰²æƒé™æ§åˆ¶

```javascript
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore()

  // åŸºç¡€è®¤è¯æ£€æŸ¥
  if (to.meta.requiresAuth && !authStore.isLoggedIn) {
    next('/login')
    return
  }

  // è§’è‰²æƒé™æ£€æŸ¥
  if (to.meta.roles && authStore.isLoggedIn) {
    const hasRole = to.meta.roles.includes(authStore.user.role)
    if (!hasRole) {
      next('/unauthorized')  // æ— æƒé™é¡µé¢
      return
    }
  }

  next()
})
```

### 3. åŠ¨æ€æƒé™æ£€æŸ¥

```javascript
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()

  // å¼‚æ­¥æƒé™æ£€æŸ¥
  if (to.meta.permission) {
    try {
      const hasPermission = await checkPermission(to.meta.permission)
      if (!hasPermission) {
        next('/forbidden')
        return
      }
    } catch (error) {
      next('/error')
      return
    }
  }

  next()
})

async function checkPermission(permission) {
  // è°ƒç”¨APIæ£€æŸ¥æƒé™
  const response = await api.checkPermission(permission)
  return response.hasPermission
}
```

---

## ğŸ“‹ å­¦ä¹ æ£€æŸ¥æ¸…å•

### âœ… è·¯ç”±å®ˆå«ç†è§£

- [ ] ç†è§£beforeEachå®ˆå«çš„ä½œç”¨
- [ ] æŒæ¡ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰å’Œç”¨æ³•
- [ ] çŸ¥é“nextå‡½æ•°çš„ä¸‰ç§è°ƒç”¨æ–¹å¼
- [ ] ç†è§£å®ˆå«çš„æ‰§è¡Œæ—¶æœº

### âœ… æƒé™æ§åˆ¶é€»è¾‘

- [ ] ç†è§£requiresAuthçš„æ£€æŸ¥é€»è¾‘
- [ ] ç†è§£guestçš„æ£€æŸ¥é€»è¾‘
- [ ] æŒæ¡authStoreçš„ä½¿ç”¨æ–¹æ³•
- [ ] çŸ¥é“å¦‚ä½•å¤„ç†é‡å®šå‘

### âœ… å®é™…åº”ç”¨èƒ½åŠ›

- [ ] èƒ½å¤Ÿè®¾è®¡å¤æ‚çš„æƒé™æ§åˆ¶é€»è¾‘
- [ ] çŸ¥é“å¦‚ä½•ä¿å­˜é‡å®šå‘è·¯å¾„
- [ ] ç†è§£è§’è‰²æƒé™æ§åˆ¶
- [ ] èƒ½å¤Ÿå¤„ç†å¼‚æ­¥æƒé™æ£€æŸ¥

---

## ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ 

æŒæ¡äº†è·¯ç”±å®ˆå«åï¼Œç»§ç»­æ·±å…¥å­¦ä¹ ï¼š

- [[09-æƒé™æ§åˆ¶é€»è¾‘è¯¦è§£.md|æƒé™æ§åˆ¶è¿›é˜¶]]
- [[10-å¯¼å‡ºè¯­å¥å’Œæœ€ä½³å®è·µ.md|æœ€ä½³å®è·µæ€»ç»“]]
- [[../01-ç»„ä»¶ç³»ç»Ÿ/01-ç»„ä»¶åŸºç¡€æ¦‚å¿µè¯¦è§£.md|ç»„ä»¶ç³»ç»Ÿ]]

---

**è®°ä½ï¼šè·¯ç”±å®ˆå«æ˜¯Vue Routerçš„"é—¨å«ç³»ç»Ÿ"ï¼ŒæŒæ¡å®ƒå°±æŒæ¡äº†åº”ç”¨çš„è®¿é—®æ§åˆ¶æƒï¼** ğŸ‰

---

*è¿™ä¸ªç« èŠ‚è¯¦ç»†è§£é‡Šäº†è·¯ç”±å®ˆå«çš„æ¯ä¸€è¡Œä»£ç ï¼Œç¡®ä¿ä½ å¯¹æƒé™æ§åˆ¶æœ‰æ·±å…¥çš„ç†è§£ï¼Œèƒ½å¤Ÿæ„å»ºå®‰å…¨å¯é çš„åº”ç”¨ã€‚*