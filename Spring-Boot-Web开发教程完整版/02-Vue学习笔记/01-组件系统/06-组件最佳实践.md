---
tags:
  - Vueç»„ä»¶
  - æœ€ä½³å®è·µ
  - ç»„ä»¶è®¾è®¡
  - æ€§èƒ½ä¼˜åŒ–
  - å¼€å‘è§„èŒƒ
  - Vue3
created: 2025-11-18
modified: 2025-11-18
category: Vueæ ¸å¿ƒæ¦‚å¿µ
difficulty: advanced
---

# Vueç»„ä»¶æœ€ä½³å®è·µ

> **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡Vueç»„ä»¶å¼€å‘çš„è®¾è®¡åŸåˆ™ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§ã€ä»£ç è§„èŒƒï¼Œä»¥åŠæ„å»ºé«˜è´¨é‡ã€å¯ç»´æŠ¤ç»„ä»¶çš„æ–¹æ³•

## ğŸ¯ æœ¬ç« æ¦‚è§ˆ

| å†…å®¹ | é¢„è®¡æ—¶é—´ | éš¾åº¦ | çŠ¶æ€ |
|------|----------|------|------|
| ç»„ä»¶è®¾è®¡åŸåˆ™ | 20åˆ†é’Ÿ | â­â­â­ | â³ |
| æ€§èƒ½ä¼˜åŒ–å®è·µ | 25åˆ†é’Ÿ | â­â­â­ | â³ |
| ä»£ç è§„èŒƒçº¦å®š | 20åˆ†é’Ÿ | â­â­ | â³ |
| é”™è¯¯å¤„ç†æœºåˆ¶ | 20åˆ†é’Ÿ | â­â­â­ | â³ |
| æµ‹è¯•ä¸ç»´æŠ¤ | 15åˆ†é’Ÿ | â­â­ | â³ |

---

## ğŸ¨ ç»„ä»¶è®¾è®¡åŸåˆ™

### å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰

æ¯ä¸ªç»„ä»¶åº”è¯¥åªæœ‰ä¸€ä¸ªå¼•èµ·å˜åŒ–çš„åŸå› ï¼Œä¸“æ³¨äºå•ä¸€çš„åŠŸèƒ½ï¼š

```vue
<!-- âŒ é”™è¯¯ç¤ºä¾‹ï¼šèŒè´£æ··ä¹±çš„ç»„ä»¶ -->
<template>
  <div class="user-profile-card">
    <!-- ç”¨æˆ·ä¿¡æ¯å±•ç¤º -->
    <div class="user-info">
      <img :src="user.avatar" :alt="user.name">
      <h3>{{ user.name }}</h3>
      <p>{{ user.email }}</p>
    </div>

    <!-- ç”¨æˆ·æ•°æ®ç¼–è¾‘ -->
    <div class="user-edit">
      <input v-model="editForm.name" placeholder="å§“å">
      <input v-model="editForm.email" placeholder="é‚®ç®±">
      <button @click="saveUser">ä¿å­˜</button>
    </div>

    <!-- æƒé™ç®¡ç† -->
    <div class="permissions">
      <h4>æƒé™è®¾ç½®</h4>
      <label><input type="checkbox" v-model="permissions.read"> è¯»å–</label>
      <label><input type="checkbox" v-model="permissions.write"> å†™å…¥</label>
      <label><input type="checkbox" v-model="permissions.admin"> ç®¡ç†</label>
    </div>

    <!-- å®¡è®¡æ—¥å¿— -->
    <div class="audit-log">
      <h4>æ“ä½œè®°å½•</h4>
      <ul>
        <li v-for="log in auditLogs" :key="log.id">{{ log.action }} - {{ log.time }}</li>
      </ul>
    </div>
  </div>
</template>
```

```vue
<!-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šèŒè´£åˆ†ç¦»çš„ç»„ä»¶ -->

<!-- UserCard.vue - åªè´Ÿè´£å±•ç¤ºç”¨æˆ·ä¿¡æ¯ -->
<template>
  <div class="user-card">
    <div class="user-info">
      <img :src="user.avatar" :alt="user.name" class="avatar">
      <div class="details">
        <h3>{{ user.name }}</h3>
        <p>{{ user.email }}</p>
        <p class="role">{{ user.role }}</p>
      </div>
    </div>
    <div class="actions">
      <slot name="actions" :user="user">
        <button @click="$emit('edit', user)">ç¼–è¾‘</button>
      </slot>
    </div>
  </div>
</template>

<script setup>
const props = defineProps({
  user: {
    type: Object,
    required: true,
    validator: (user) => user.id && user.name
  }
})

const emit = defineEmits(['edit'])
</script>

<style scoped>
.user-card {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 20px;
  background: white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
}

.details h3 {
  margin: 0 0 5px 0;
  color: #333;
}

.details p {
  margin: 0;
  color: #666;
  font-size: 14px;
}

.role {
  font-weight: bold;
  color: #42b883;
}
</style>
```

```vue
<!-- UserEditForm.vue - åªè´Ÿè´£ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯ -->
<template>
  <div class="user-edit-form">
    <h3>ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</h3>
    <form @submit.prevent="handleSubmit">
      <div class="form-group">
        <label>å§“åï¼š</label>
        <input
          v-model="form.name"
          type="text"
          required
          :class="{ error: errors.name }"
        >
        <span v-if="errors.name" class="error-message">{{ errors.name }}</span>
      </div>

      <div class="form-group">
        <label>é‚®ç®±ï¼š</label>
        <input
          v-model="form.email"
          type="email"
          required
          :class="{ error: errors.email }"
        >
        <span v-if="errors.email" class="error-message">{{ errors.email }}</span>
      </div>

      <div class="form-actions">
        <button type="submit" :disabled="isSubmitting">
          {{ isSubmitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
        </button>
        <button type="button" @click="$emit('cancel')">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</template>

<script setup>
import { reactive, computed } from 'vue'

const props = defineProps({
  user: {
    type: Object,
    required: true
  }
})

const emit = defineEmits(['save', 'cancel'])

const form = reactive({
  name: props.user.name || '',
  email: props.user.email || ''
})

const isSubmitting = ref(false)

const errors = computed(() => {
  const errs = {}
  if (!form.name.trim()) errs.name = 'å§“åä¸èƒ½ä¸ºç©º'
  if (!form.email.trim()) errs.email = 'é‚®ç®±ä¸èƒ½ä¸ºç©º'
  if (form.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email)) {
    errs.email = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'
  }
  return errs
})

const isValid = computed(() => Object.keys(errors.value).length === 0)

async function handleSubmit() {
  if (!isValid.value) return

  isSubmitting.value = true
  try {
    await emit('save', { ...props.user, ...form })
  } finally {
    isSubmitting.value = false
  }
}
</script>

<style scoped>
.user-edit-form {
  padding: 20px;
  background: #f9f9f9;
  border-radius: 8px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.form-group input.error {
  border-color: #f44336;
}

.error-message {
  color: #f44336;
  font-size: 12px;
  margin-top: 5px;
}

.form-actions {
  display: flex;
  gap: 10px;
}
</style>
```

### å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰

ç»„ä»¶åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼š

```vue
<!-- âœ… è‰¯å¥½çš„æ‰©å±•æ€§è®¾è®¡ -->
<template>
  <div class="data-table">
    <div class="table-header">
      <h3>{{ title }}</h3>
      <div class="actions">
        <slot name="header-actions" :selected-items="selectedItems">
          <button @click="refresh">åˆ·æ–°</button>
        </slot>
      </div>
    </div>

    <div class="table-controls" v-if="showControls">
      <slot name="controls" :filters="filters" :sort="sort">
        <!-- é»˜è®¤æ§ä»¶ -->
        <input
          v-model="filters.search"
          placeholder="æœç´¢..."
          @input="debouncedRefresh"
        >
        <select v-model="sort.field" @change="refresh">
          <option value="name">æŒ‰åç§°æ’åº</option>
          <option value="date">æŒ‰æ—¥æœŸæ’åº</option>
        </select>
      </slot>
    </div>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th v-if="selectable">
              <input
                type="checkbox"
                :checked="isAllSelected"
                @change="toggleSelectAll"
              >
            </th>
            <th
              v-for="column in visibleColumns"
              :key="column.key"
              :style="{ width: column.width }"
            >
              {{ column.title }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="item in paginatedData"
            :key="item.id"
            :class="{ selected: selectedItems.includes(item.id) }"
          >
            <td v-if="selectable">
              <input
                type="checkbox"
                :checked="selectedItems.includes(item.id)"
                @change="toggleSelection(item.id)"
              >
            </td>
            <td
              v-for="column in visibleColumns"
              :key="column.key"
            >
              <!-- è‡ªå®šä¹‰å•å…ƒæ ¼æ¸²æŸ“ -->
              <slot
                :name="`cell-${column.key}`"
                :item="item"
                :value="item[column.key]"
                :column="column"
              >
                {{ formatCellValue(item[column.key], column) }}
              </slot>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="table-footer" v-if="showPagination">
      <slot name="pagination" :pagination="pagination" :set-page="setPage">
        <div class="pagination">
          <button
            :disabled="pagination.page === 1"
            @click="setPage(pagination.page - 1)"
          >
            ä¸Šä¸€é¡µ
          </button>
          <span>
            ç¬¬ {{ pagination.page }} é¡µï¼Œå…± {{ pagination.totalPages }} é¡µ
          </span>
          <button
            :disabled="pagination.page === pagination.totalPages"
            @click="setPage(pagination.page + 1)"
          >
            ä¸‹ä¸€é¡µ
          </button>
        </div>
      </slot>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'

const props = defineProps({
  // åŸºç¡€é…ç½®
  title: { type: String, required: true },
  data: { type: Array, required: true },
  columns: {
    type: Array,
    required: true,
    validator: (columns) => columns.every(col => col.key && col.title)
  },

  // åŠŸèƒ½å¼€å…³
  selectable: { type: Boolean, default: false },
  showControls: { type: Boolean, default: true },
  showPagination: { type: Boolean, default: true },

  // åˆ†é¡µé…ç½®
  pageSize: { type: Number, default: 10 },

  // å¯æ‰©å±•çš„è¿‡æ»¤å™¨
  initialFilters: { type: Object, default: () => ({}) },
  initialSort: { type: Object, default: () => ({ field: 'id', order: 'asc' })
})

const emit = defineEmits(['refresh', 'selection-change'])

// å“åº”å¼çŠ¶æ€
const filters = reactive({ ...props.initialFilters })
const sort = reactive({ ...props.initialSort })
const selectedItems = ref([])
const currentPage = ref(1)

// è®¡ç®—å±æ€§
const visibleColumns = computed(() => {
  return props.columns.filter(col => col.visible !== false)
})

const filteredData = computed(() => {
  let result = [...props.data]

  // æœç´¢è¿‡æ»¤
  if (filters.search) {
    const search = filters.search.toLowerCase()
    result = result.filter(item => {
      return Object.values(item).some(value =>
        String(value).toLowerCase().includes(search)
      )
    })
  }

  // è‡ªå®šä¹‰è¿‡æ»¤ï¼ˆå¯é€šè¿‡æ’æ§½æ‰©å±•ï¼‰
  return result
})

const sortedData = computed(() => {
  const result = [...filteredData.value]
  result.sort((a, b) => {
    const aVal = a[sort.field]
    const bVal = b[sort.field]
    const order = sort.order === 'desc' ? -1 : 1
    return (aVal > bVal ? 1 : -1) * order
  })
  return result
})

const paginatedData = computed(() => {
  if (!props.showPagination) return sortedData.value

  const start = (currentPage.value - 1) * props.pageSize
  const end = start + props.pageSize
  return sortedData.value.slice(start, end)
})

const pagination = computed(() => {
  const total = sortedData.value.length
  const totalPages = Math.ceil(total / props.pageSize)
  return {
    page: currentPage.value,
    totalPages,
    total,
    pageSize: props.pageSize
  }
})

const isAllSelected = computed(() => {
  return paginatedData.value.length > 0 &&
    paginatedData.value.every(item => selectedItems.value.includes(item.id))
})

// æ–¹æ³•
function refresh() {
  emit('refresh', { filters, sort, page: currentPage.value })
}

const debouncedRefresh = debounce(refresh, 300)

function toggleSelection(itemId) {
  const index = selectedItems.value.indexOf(itemId)
  if (index > -1) {
    selectedItems.value.splice(index, 1)
  } else {
    selectedItems.value.push(itemId)
  }
  emit('selection-change', selectedItems.value)
}

function toggleSelectAll() {
  if (isAllSelected.value) {
    // å–æ¶ˆé€‰æ‹©å½“å‰é¡µæ‰€æœ‰é¡¹
    const currentPageIds = paginatedData.value.map(item => item.id)
    selectedItems.value = selectedItems.value.filter(
      id => !currentPageIds.includes(id)
    )
  } else {
    // é€‰æ‹©å½“å‰é¡µæ‰€æœ‰é¡¹
    const newIds = paginatedData.value
      .map(item => item.id)
      .filter(id => !selectedItems.value.includes(id))
    selectedItems.value.push(...newIds)
  }
  emit('selection-change', selectedItems.value)
}

function setPage(page) {
  currentPage.value = page
}

function formatCellValue(value, column) {
  if (column.formatter && typeof column.formatter === 'function') {
    return column.formatter(value)
  }
  return value
}

// å·¥å…·å‡½æ•°
function debounce(func, wait) {
  let timeout
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout)
      func(...args)
    }
    clearTimeout(timeout)
    timeout = setTimeout(later, wait)
  }
}

// æš´éœ²ç»™çˆ¶ç»„ä»¶çš„æ–¹æ³•
defineExpose({
  refresh,
  clearSelection: () => { selectedItems.value = [] },
  getSelectedItems: () => selectedItems.value
})
</script>

<style scoped>
.data-table {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  overflow: hidden;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
  background: #fafafa;
}

.table-controls {
  padding: 15px 20px;
  border-bottom: 1px solid #e0e0e0;
  background: #f5f5f5;
}

.table-container {
  overflow-x: auto;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th,
.table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.table th {
  background: #f9f9f9;
  font-weight: bold;
}

.table tr:hover {
  background: #f5f5f5;
}

.table tr.selected {
  background: #e3f2fd;
}

.table-footer {
  padding: 15px 20px;
  border-top: 1px solid #e0e0e0;
  background: #fafafa;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
}
</style>
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–å®è·µ

### ç»„ä»¶æ‡’åŠ è½½

```vue
<!-- LazyComponentLoader.vue - æ™ºèƒ½ç»„ä»¶æ‡’åŠ è½½å™¨ -->
<template>
  <div class="lazy-component-loader">
    <!-- é”™è¯¯çŠ¶æ€ -->
    <div v-if="error" class="error-state">
      <div class="error-content">
        <h3>ç»„ä»¶åŠ è½½å¤±è´¥</h3>
        <p>{{ error }}</p>
        <button @click="retry">é‡è¯•</button>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-else-if="isLoading" class="loading-state">
      <slot name="loading">
        <div class="default-loading">
          <div class="spinner"></div>
          <p>ç»„ä»¶åŠ è½½ä¸­...</p>
        </div>
      </slot>
    </div>

    <!-- ç»„ä»¶å·²åŠ è½½ -->
    <div v-else-if="loadedComponent" class="loaded-component">
      <component
        :is="loadedComponent"
        v-bind="$attrs"
        @hook:mounted="onComponentMounted"
        @hook:error="onComponentError"
      />
    </div>

    <!-- å ä½ç¬¦ -->
    <div v-else class="placeholder">
      <slot name="placeholder">
        <div class="default-placeholder">
          <p>ç­‰å¾…åŠ è½½ç»„ä»¶...</p>
        </div>
      </slot>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'

const props = defineProps({
  // ç»„ä»¶åŠ è½½å™¨å‡½æ•°
  loader: {
    type: Function,
    required: true
  },
  // é¢„åŠ è½½å»¶è¿Ÿ
  delay: {
    type: Number,
    default: 200
  },
  // è¶…æ—¶æ—¶é—´
  timeout: {
    type: Number,
    default: 10000
  },
  // æ˜¯å¦è‡ªåŠ¨åŠ è½½
  autoLoad: {
    type: Boolean,
    default: true
  },
  // é”™è¯¯é‡è¯•æ¬¡æ•°
  retryCount: {
    type: Number,
    default: 3
  }
})

const emit = defineEmits(['loaded', 'error', 'retry'])

const loadedComponent = ref(null)
const isLoading = ref(false)
const error = ref('')
const retryAttempts = ref(0)
let loadTimeout = null
let componentPromise = null

// è®¡ç®—æ˜¯å¦å¯ä»¥é‡è¯•
const canRetry = computed(() => {
  return retryAttempts.value < props.retryCount
})

// åŠ è½½ç»„ä»¶
async function loadComponent() {
  if (componentPromise) {
    return componentPromise
  }

  isLoading.value = true
  error.value = ''

  componentPromise = new Promise(async (resolve, reject) => {
    try {
      // è®¾ç½®è¶…æ—¶
      loadTimeout = setTimeout(() => {
        reject(new Error(`ç»„ä»¶åŠ è½½è¶…æ—¶ï¼ˆ${props.timeout}msï¼‰`))
      }, props.timeout)

      // å»¶è¿ŸåŠ è½½
      if (props.delay > 0) {
        await new Promise(resolve => setTimeout(resolve, props.delay))
      }

      // åŠ è½½ç»„ä»¶
      const component = await props.loader()

      clearTimeout(loadTimeout)
      loadedComponent.value = component
      isLoading.value = false
      retryAttempts.value = 0

      emit('loaded', component)
      resolve(component)
    } catch (err) {
      clearTimeout(loadTimeout)
      error.value = err.message
      isLoading.value = false
      componentPromise = null

      emit('error', err)
      reject(err)
    }
  })

  return componentPromise
}

// é‡è¯•åŠ è½½
async function retry() {
  if (!canRetry.value) return

  retryAttempts.value++
  componentPromise = null
  emit('retry', retryAttempts.value)

  try {
    await loadComponent()
  } catch (err) {
    // é”™è¯¯å·²ç»åœ¨loadComponentä¸­å¤„ç†
  }
}

// é¢„åŠ è½½
function preload() {
  if (!loadedComponent.value && !isLoading.value) {
    loadComponent()
  }
}

// ç»„ä»¶åŠ è½½å®Œæˆå›è°ƒ
function onComponentMounted() {
  console.log('æ‡’åŠ è½½ç»„ä»¶å·²æŒ‚è½½')
}

// ç»„ä»¶é”™è¯¯å›è°ƒ
function onComponentError(err) {
  console.error('æ‡’åŠ è½½ç»„ä»¶å‘ç”Ÿé”™è¯¯ï¼š', err)
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  if (props.autoLoad) {
    // ä½¿ç”¨requestIdleCallbackåœ¨ç©ºé—²æ—¶åŠ è½½
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => {
        loadComponent()
      })
    } else {
      // é™çº§å¤„ç†
      setTimeout(() => {
        loadComponent()
      }, 0)
    }
  }
})

onUnmounted(() => {
  if (loadTimeout) {
    clearTimeout(loadTimeout)
  }
})

// æš´éœ²æ–¹æ³•
defineExpose({
  loadComponent,
  retry,
  preload,
  isLoading: readonly(isLoading),
  error: readonly(error),
  canRetry: readonly(canRetry)
})
</script>

<style scoped>
.lazy-component-loader {
  min-height: 100px;
}

.error-state,
.loading-state,
.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100px;
  padding: 20px;
}

.error-content {
  text-align: center;
  color: #f44336;
}

.loading-state .default-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.spinner {
  width: 30px;
  height: 30px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #42b883;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.placeholder .default-placeholder {
  text-align: center;
  color: #666;
}

.error-state button {
  margin-top: 10px;
  padding: 8px 16px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
</style>
```

### è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

```vue
<!-- VirtualScrollList.vue - é«˜æ€§èƒ½è™šæ‹Ÿæ»šåŠ¨åˆ—è¡¨ -->
<template>
  <div
    class="virtual-scroll-list"
    :style="{ height: containerHeight + 'px' }"
    @scroll="handleScroll"
    ref="containerRef"
  >
    <!-- æ»šåŠ¨æ¡å ä½ç©ºé—´ -->
    <div :style="{ height: totalHeight + 'px' }" class="scroll-spacer">
      <!-- å¯è§é¡¹ç›®æ¸²æŸ“åŒºåŸŸ -->
      <div
        class="visible-items"
        :style="{
          transform: `translateY(${offsetY}px)`,
          height: visibleHeight + 'px'
        }"
      >
        <div
          v-for="item in visibleItems"
          :key="item.index"
          :class="['virtual-item', itemClass]"
          :style="{
            height: itemHeight + 'px',
            ...itemStyle
          }"
          :data-index="item.index"
          :data-id="item.data.id"
        >
          <!-- ä½¿ç”¨æ’æ§½æ¸²æŸ“é¡¹ç›®å†…å®¹ -->
          <slot
            name="item"
            :item="item.data"
            :index="item.index"
            :is-visible="item.isVisible"
          >
            <div class="default-item">
              {{ item.data }}
            </div>
          </slot>
        </div>
      </div>
    </div>

    <!-- åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨ -->
    <div
      v-if="showLoadingMore"
      class="loading-more"
    >
      <slot name="loading-more">
        <div class="default-loading-more">
          <div class="spinner"></div>
          <span>åŠ è½½æ›´å¤š...</span>
        </div>
      </slot>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'

const props = defineProps({
  // æ•°æ®åˆ—è¡¨
  items: {
    type: Array,
    required: true
  },
  // é¡¹ç›®é«˜åº¦
  itemHeight: {
    type: Number,
    required: true
  },
  // å®¹å™¨é«˜åº¦
  containerHeight: {
    type: Number,
    required: true
  },
  // ç¼“å†²åŒºå¤§å°ï¼ˆé¢å¤–æ¸²æŸ“çš„é¡¹ç›®æ•°ï¼‰
  bufferSize: {
    type: Number,
    default: 5
  },
  // åŠ¨æ€é¡¹ç›®é«˜åº¦ï¼ˆæ”¯æŒä¸åŒé«˜åº¦çš„é¡¹ç›®ï¼‰
  dynamicHeight: {
    type: Boolean,
    default: false
  },
  // é¡¹ç›®CSSç±»å
  itemClass: {
    type: String,
    default: ''
  },
  // é¡¹ç›®æ ·å¼
  itemStyle: {
    type: Object,
    default: () => ({})
  },
  // æ˜¯å¦å¯ç”¨æ— é™æ»šåŠ¨
  infiniteScroll: {
    type: Boolean,
    default: false
  },
  // è§¦å‘åŠ è½½æ›´å¤šçš„é˜ˆå€¼
  loadMoreThreshold: {
    type: Number,
    default: 50
  }
})

const emit = defineEmits(['load-more', 'scroll', 'item-visible'])

const containerRef = ref(null)
const scrollTop = ref(0)
const itemHeights = ref(new Map())
const isLoadingMore = ref(false)
const hasScrolledToBottom = ref(false)

// è®¡ç®—æ€»é«˜åº¦
const totalHeight = computed(() => {
  if (!props.dynamicHeight) {
    return props.items.length * props.itemHeight
  }

  // åŠ¨æ€é«˜åº¦è®¡ç®—
  let height = 0
  for (let i = 0; i < props.items.length; i++) {
    height += itemHeights.value.get(i) || props.itemHeight
  }
  return height
})

// è®¡ç®—å¯è§é¡¹ç›®
const visibleItems = computed(() => {
  const start = getStartIndex()
  const end = getEndIndex(start)

  const items = []
  for (let i = start; i <= end; i++) {
    if (i < props.items.length) {
      const itemTop = getItemTop(i)
      const itemBottom = itemTop + (itemHeights.value.get(i) || props.itemHeight)
      const isVisible = itemBottom > scrollTop.value && itemTop < scrollTop.value + props.containerHeight

      items.push({
        index: i,
        data: props.items[i],
        top: itemTop,
        isVisible
      })
    }
  }

  return items
})

// è®¡ç®—åç§»é‡
const offsetY = computed(() => {
  return getItemTop(getStartIndex())
})

// è®¡ç®—å¯è§åŒºåŸŸé«˜åº¦
const visibleHeight = computed(() => {
  if (visibleItems.value.length === 0) return 0

  const firstItem = visibleItems.value[0]
  const lastItem = visibleItems.value[visibleItems.value.length - 1]
  return lastItem.top + (itemHeights.value.get(lastItem.index) || props.itemHeight) - firstItem.top
})

// æ˜¯å¦æ˜¾ç¤ºåŠ è½½æ›´å¤š
const showLoadingMore = computed(() => {
  return props.infiniteScroll && (isLoadingMore.value || hasScrolledToBottom.value)
})

// è·å–é¡¹ç›®é¡¶éƒ¨ä½ç½®
function getItemTop(index) {
  if (!props.dynamicHeight) {
    return index * props.itemHeight
  }

  let top = 0
  for (let i = 0; i < index; i++) {
    top += itemHeights.value.get(i) || props.itemHeight
  }
  return top
}

// è·å–å¼€å§‹ç´¢å¼•
function getStartIndex() {
  if (!props.dynamicHeight) {
    return Math.max(0, Math.floor(scrollTop.value / props.itemHeight) - props.bufferSize)
  }

  // åŠ¨æ€é«˜åº¦çš„äºŒåˆ†æŸ¥æ‰¾
  let start = 0
  let end = props.items.length - 1
  let targetIndex = 0

  while (start <= end) {
    const mid = Math.floor((start + end) / 2)
    const midTop = getItemTop(mid)

    if (midTop <= scrollTop.value) {
      targetIndex = mid
      start = mid + 1
    } else {
      end = mid - 1
    }
  }

  return Math.max(0, targetIndex - props.bufferSize)
}

// è·å–ç»“æŸç´¢å¼•
function getEndIndex(startIndex) {
  const visibleCount = Math.ceil(props.containerHeight / props.itemHeight)
  return Math.min(
    props.items.length - 1,
    startIndex + visibleCount + props.bufferSize * 2
  )
}

// å¤„ç†æ»šåŠ¨äº‹ä»¶
let scrollRAF = null
function handleScroll(event) {
  if (scrollRAF) return

  scrollRAF = requestAnimationFrame(() => {
    const { scrollTop: newScrollTop, scrollHeight, clientHeight } = event.target
    scrollTop.value = newScrollTop

    // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
    const distanceToBottom = scrollHeight - clientHeight - newScrollTop
    const isAtBottom = distanceToBottom <= props.loadMoreThreshold

    if (isAtBottom && props.infiniteScroll && !isLoadingMore.value) {
      hasScrolledToBottom.value = true
      loadMoreItems()
    } else if (!isAtBottom) {
      hasScrolledToBottom.value = false
    }

    emit('scroll', {
      scrollTop: newScrollTop,
      isAtBottom,
      scrollLeft: event.target.scrollLeft
    })

    // é€šçŸ¥å¯è§é¡¹ç›®å˜åŒ–
    visibleItems.value.forEach(item => {
      if (item.isVisible) {
        emit('item-visible', item.data, item.index)
      }
    })

    scrollRAF = null
  })
}

// åŠ è½½æ›´å¤šé¡¹ç›®
async function loadMoreItems() {
  if (isLoadingMore.value) return

  isLoadingMore.value = true
  try {
    await emit('load-more')
  } finally {
    isLoadingMore.value = false
    // é‡æ–°è®¡ç®—æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢è·³è·ƒ
    await nextTick()
  }
}

// åŠ¨æ€æ›´æ–°é¡¹ç›®é«˜åº¦
function updateItemHeight(index, height) {
  if (props.dynamicHeight && height !== itemHeights.value.get(index)) {
    itemHeights.value.set(index, height)
  }
}

// æ»šåŠ¨åˆ°æŒ‡å®šé¡¹ç›®
function scrollToItem(index, alignment = 'auto') {
  if (!containerRef.value || index < 0 || index >= props.items.length) return

  const itemTop = getItemTop(index)
  const itemHeight = itemHeights.value.get(index) || props.itemHeight
  const containerHeight = props.containerHeight

  let scrollTop
  switch (alignment) {
    case 'start':
      scrollTop = itemTop
      break
    case 'center':
      scrollTop = itemTop - (containerHeight - itemHeight) / 2
      break
    case 'end':
      scrollTop = itemTop - containerHeight + itemHeight
      break
    case 'auto':
    default:
      if (itemTop < scrollTop.value) {
        scrollTop = itemTop
      } else if (itemTop + itemHeight > scrollTop.value + containerHeight) {
        scrollTop = itemTop - containerHeight + itemHeight
      }
      break
  }

  containerRef.value.scrollTop = Math.max(0, scrollTop)
}

// ç›‘å¬é¡¹ç›®å˜åŒ–ï¼Œé‡ç½®é«˜åº¦ç¼“å­˜
watch(() => props.items.length, () => {
  if (props.dynamicHeight) {
    // ä¿ç•™å·²ç¼“å­˜çš„é«˜åº¦ï¼Œä½†ç§»é™¤è¶…å‡ºèŒƒå›´çš„é¡¹ç›®
    const newHeights = new Map()
    itemHeights.value.forEach((height, index) => {
      if (index < props.items.length) {
        newHeights.set(index, height)
      }
    })
    itemHeights.value = newHeights
  }
})

// æš´éœ²æ–¹æ³•
defineExpose({
  scrollToItem,
  updateItemHeight,
  getVisibleItems: () => visibleItems.value,
  getScrollTop: () => scrollTop.value
})
</script>

<style scoped>
.virtual-scroll-list {
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
}

.scroll-spacer {
  position: relative;
}

.visible-items {
  position: relative;
}

.virtual-item {
  position: absolute;
  left: 0;
  right: 0;
  box-sizing: border-box;
}

.default-item {
  padding: 12px;
  border-bottom: 1px solid #eee;
  box-sizing: border-box;
  height: 100%;
}

.loading-more {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  background: white;
  border-top: 1px solid #eee;
  text-align: center;
}

.default-loading-more {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #42b883;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
```

---

## ğŸ“‹ ä»£ç è§„èŒƒçº¦å®š

### å‘½åè§„èŒƒ

```vue
<!-- âœ… æ¨èçš„ç»„ä»¶å‘½åå’Œç»“æ„ -->
<template>
  <!-- ä½¿ç”¨è¯­ä¹‰åŒ–çš„HTMLæ ‡ç­¾å’Œæœ‰æ„ä¹‰çš„ç±»å -->
  <header class="user-profile-header">
    <div class="user-avatar-section">
      <img
        :src="user.avatarUrl"
        :alt="`${user.name}çš„ avatar`"
        class="user-avatar-image"
      >
      <div class="user-status-indicator" :class="statusClass">
        {{ userStatusText }}
      </div>
    </div>

    <main class="user-info-section">
      <h1 class="user-name">{{ user.displayName }}</h1>
      <p class="user-bio">{{ user.biography }}</p>
    </main>

    <footer class="user-actions-section">
      <BaseButton
        variant="primary"
        size="medium"
        @click="handleFollow"
        :is-loading="isFollowing"
      >
        {{ isFollowing ? 'å…³æ³¨ä¸­...' : 'å…³æ³¨' }}
      </BaseButton>
      <BaseButton
        variant="secondary"
        size="medium"
        @click="handleMessage"
      >
        å‘æ¶ˆæ¯
      </BaseButton>
    </footer>
  </header>
</template>

<script setup>
import { computed, ref } from 'vue'
import BaseButton from '@/components/base/BaseButton.vue'

// Propså‘½åï¼šä½¿ç”¨å®Œæ•´çš„å•è¯ï¼Œè¯­ä¹‰åŒ–
const props = defineProps({
  user: {
    type: Object,
    required: true,
    validator: (user) => {
      return user.id && user.name && user.avatarUrl
    }
  },
  initialFollowingStatus: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits([
  'follow-status-change',
  'message-click'
])

// å“åº”å¼å˜é‡ï¼šä½¿ç”¨æè¿°æ€§åç§°
const isFollowing = ref(props.initialFollowingStatus)
const isLoading = ref(false)

// è®¡ç®—å±æ€§ï¼šä½¿ç”¨åŠ¨è¯æˆ–å½¢å®¹è¯å½¢å¼
const userStatusText = computed(() => {
  switch (props.user.status) {
    case 'online': return 'åœ¨çº¿'
    case 'away': return 'ç¦»å¼€'
    case 'busy': return 'å¿™ç¢Œ'
    default: return 'ç¦»çº¿'
  }
})

const statusClass = computed(() => {
  return `status-${props.user.status}`
})

// æ–¹æ³•ï¼šä½¿ç”¨åŠ¨è¯å¼€å¤´ï¼Œæè¿°å…·ä½“è¡Œä¸º
async function handleFollow() {
  if (isLoading.value) return

  isLoading.value = true
  try {
    const newStatus = await toggleFollowStatus(props.user.id)
    isFollowing.value = newStatus
    emit('follow-status-change', {
      userId: props.user.id,
      isFollowing: newStatus
    })
  } catch (error) {
    console.error('åˆ‡æ¢å…³æ³¨çŠ¶æ€å¤±è´¥ï¼š', error)
  } finally {
    isLoading.value = false
  }
}

function handleMessage() {
  emit('message-click', props.user)
}

// å‡è®¾çš„APIè°ƒç”¨
async function toggleFollowStatus(userId) {
  // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè°ƒç”¨çœŸå®çš„API
  await new Promise(resolve => setTimeout(resolve, 1000))
  return !isFollowing.value
}
</script>

<style scoped>
/* BEMå‘½åè§„èŒƒï¼šBlock__Element--Modifier */
.user-profile-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
}

.user-avatar-section {
  position: relative;
  margin-bottom: 20px;
}

.user-avatar-image {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid rgba(255, 255, 255, 0.2);
  object-fit: cover;
}

.user-status-indicator {
  position: absolute;
  bottom: 8px;
  right: 8px;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  background: rgba(0, 0, 0, 0.6);
}

.user-status-indicator.status-online {
  background: #4caf50;
}

.user-status-indicator.status-away {
  background: #ff9800;
}

.user-status-indicator.status-busy {
  background: #f44336;
}

.user-info-section {
  text-align: center;
  margin-bottom: 24px;
}

.user-name {
  margin: 0 0 8px 0;
  font-size: 24px;
  font-weight: bold;
}

.user-bio {
  margin: 0;
  opacity: 0.9;
  line-height: 1.5;
}

.user-actions-section {
  display: flex;
  gap: 12px;
  width: 100%;
  max-width: 300px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .user-profile-header {
    padding: 16px;
  }

  .user-avatar-image {
    width: 80px;
    height: 80px;
  }

  .user-name {
    font-size: 20px;
  }

  .user-actions-section {
    flex-direction: column;
    max-width: none;
  }
}
</style>
```

### ç»„ä»¶ç›®å½•ç»“æ„è§„èŒƒ

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ base/                    # åŸºç¡€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ BaseButton.vue
â”‚   â”‚   â”œâ”€â”€ BaseInput.vue
â”‚   â”‚   â”œâ”€â”€ BaseModal.vue
â”‚   â”‚   â””â”€â”€ index.ts            # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚
â”‚   â”œâ”€â”€ business/                # ä¸šåŠ¡ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”‚   â”œâ”€â”€ UserCard.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ UserProfile.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ UserList.vue
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”‚   â”œâ”€â”€ ProductCard.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ ProductList.vue
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ order/
â”‚   â”‚       â”œâ”€â”€ OrderSummary.vue
â”‚   â”‚       â”œâ”€â”€ OrderHistory.vue
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ layout/                  # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ AppHeader.vue
â”‚   â”‚   â”œâ”€â”€ AppSidebar.vue
â”‚   â”‚   â”œâ”€â”€ AppFooter.vue
â”‚   â”‚   â”œâ”€â”€ AppLayout.vue
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â””â”€â”€ ui/                      # UIç»„ä»¶
â”‚       â”œâ”€â”€ LoadingSpinner.vue
â”‚       â”œâ”€â”€ ErrorMessage.vue
â”‚       â”œâ”€â”€ ConfirmDialog.vue
â”‚       â”œâ”€â”€ ToastNotification.vue
â”‚       â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ composables/                 # ç»„åˆå¼å‡½æ•°
â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”œâ”€â”€ useApi.ts
â”‚   â”œâ”€â”€ useLocalStorage.ts
â”‚   â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ services/                    # APIæœåŠ¡
â”‚   â”œâ”€â”€ api.ts
â”‚   â”œâ”€â”€ auth.ts
â”‚   â”œâ”€â”€ user.ts
â”‚   â””â”€â”€ product.ts
â”‚
â”œâ”€â”€ utils/                       # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ format.ts
â”‚   â”œâ”€â”€ validation.ts
â”‚   â”œâ”€â”€ constants.ts
â”‚   â””â”€â”€ helpers.ts
â”‚
â””â”€â”€ types/                       # TypeScriptç±»å‹å®šä¹‰
    â”œâ”€â”€ user.ts
    â”œâ”€â”€ product.ts
    â”œâ”€â”€ api.ts
    â””â”€â”€ index.ts
```

---

## ğŸš¨ é”™è¯¯å¤„ç†æœºåˆ¶

### ç»„ä»¶çº§é”™è¯¯è¾¹ç•Œ

```vue
<!-- ErrorBoundary.vue - ç»„ä»¶é”™è¯¯è¾¹ç•Œ -->
<template>
  <div class="error-boundary">
    <!-- æ­£å¸¸æ¸²æŸ“å­ç»„ä»¶ -->
    <slot v-if="!hasError" />

    <!-- é”™è¯¯çŠ¶æ€æ¸²æŸ“ -->
    <div v-else class="error-fallback">
      <slot name="error-fallback" :error="error" :retry="retry">
        <div class="default-error-fallback">
          <div class="error-icon">âš ï¸</div>
          <h2>å‡ºç°äº†é”™è¯¯</h2>
          <p v-if="showErrorDetails">{{ error?.message }}</p>
          <details v-if="showErrorDetails && error?.stack">
            <summary>é”™è¯¯è¯¦æƒ…</summary>
            <pre class="error-stack">{{ error?.stack }}</pre>
          </details>
          <div class="error-actions">
            <button @click="retry" class="retry-button">
              é‡è¯•
            </button>
            <button @click="reportError" class="report-button">
              æŠ¥å‘Šé”™è¯¯
            </button>
          </div>
        </div>
      </slot>
    </div>
  </div>
</template>

<script setup>
import { ref, onErrorCaptured, onMounted } from 'vue'

const props = defineProps({
  // æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
  showErrorDetails: {
    type: Boolean,
    default: false
  },
  // æœ€å¤§é‡è¯•æ¬¡æ•°
  maxRetries: {
    type: Number,
    default: 3
  },
  // é”™è¯¯ä¸ŠæŠ¥å‡½æ•°
  onError: {
    type: Function,
    default: null
  }
})

const emit = defineEmits(['error', 'retry'])

const hasError = ref(false)
const error = ref(null)
const retryCount = ref(0)

// æ•è·å­ç»„ä»¶é”™è¯¯
onErrorCaptured((err, instance, info) => {
  console.error('ç»„ä»¶é”™è¯¯è¢«æ•è·ï¼š', { err, instance, info })

  error.value = {
    message: err.message,
    stack: err.stack,
    component: instance?.$options?.name || 'Unknown',
    info
  }

  hasError.value = true

  // ä¸ŠæŠ¥é”™è¯¯
  if (props.onError) {
    props.onError(error.value)
  }

  // è‡ªåŠ¨é‡è¯•
  if (retryCount.value < props.maxRetries) {
    setTimeout(() => {
      retry()
    }, 1000 * (retryCount.value + 1)) // é€’å¢å»¶è¿Ÿé‡è¯•
  }

  emit('error', error.value)

  // è¿”å›falseé˜»æ­¢é”™è¯¯ç»§ç»­å‘ä¸Šä¼ æ’­
  return false
})

// é‡è¯•å‡½æ•°
function retry() {
  hasError.value = false
  error.value = null
  retryCount.value++
  emit('retry', retryCount.value)
}

// æ‰‹åŠ¨æŠ¥å‘Šé”™è¯¯
function reportError() {
  // è¿™é‡Œå¯ä»¥é›†æˆé”™è¯¯ä¸ŠæŠ¥æœåŠ¡
  if (navigator.sendBeacon) {
    const errorData = JSON.stringify({
      error: error.value,
      userAgent: navigator.userAgent,
      url: window.location.href,
      timestamp: new Date().toISOString()
    })

    navigator.sendBeacon('/api/errors', errorData)
  } else {
    console.warn('æ— æ³•ä¸ŠæŠ¥é”™è¯¯ï¼šsendBeaconä¸å¯ç”¨')
  }
}

// ç»„ä»¶æŒ‚è½½æ—¶é‡ç½®é”™è¯¯çŠ¶æ€
onMounted(() => {
  hasError.value = false
  error.value = null
  retryCount.value = 0
})

// æš´éœ²æ–¹æ³•
defineExpose({
  retry,
  hasError: readonly(hasError),
  error: readonly(error)
})
</script>

<style scoped>
.error-boundary {
  /* ç»§æ‰¿çˆ¶å®¹å™¨çš„æ ·å¼ */
}

.error-fallback {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
  padding: 20px;
}

.default-error-fallback {
  text-align: center;
  max-width: 500px;
}

.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.default-error-fallback h2 {
  margin: 0 0 8px 0;
  color: #f44336;
}

.default-error-fallback p {
  margin: 0 0 16px 0;
  color: #666;
}

.error-stack {
  background: #f5f5f5;
  padding: 10px;
  border-radius: 4px;
  font-size: 12px;
  text-align: left;
  overflow-x: auto;
}

.error-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.retry-button,
.report-button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

.retry-button {
  background: #4caf50;
  color: white;
}

.report-button {
  background: #2196f3;
  color: white;
}

.retry-button:hover,
.report-button:hover {
  opacity: 0.9;
}
</style>
```

### å¼‚æ­¥é”™è¯¯å¤„ç†

```vue
<!-- AsyncHandler.vue - å¼‚æ­¥æ“ä½œå¤„ç†å™¨ -->
<template>
  <div class="async-handler">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="isLoading" class="loading-state">
      <slot name="loading" :progress="loadingProgress">
        <div class="default-loading">
          <div class="spinner"></div>
          <span>{{ loadingMessage }}</span>
          <div v-if="showProgress" class="progress-bar">
            <div
              class="progress-fill"
              :style="{ width: loadingProgress + '%' }"
            ></div>
          </div>
        </div>
      </slot>
    </div>

    <!-- æˆåŠŸçŠ¶æ€ -->
    <div v-else-if="isSuccess" class="success-state">
      <slot name="success" :data="result">
        <div class="default-success">
          <div class="success-icon">âœ…</div>
          <h3>{{ successMessage }}</h3>
        </div>
      </slot>
    </div>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <div v-else-if="error" class="error-state">
      <slot name="error" :error="error" :retry="execute">
        <div class="default-error">
          <div class="error-icon">âŒ</div>
          <h3>{{ error.title || 'æ“ä½œå¤±è´¥' }}</h3>
          <p>{{ error.message }}</p>
          <div class="error-actions">
            <button v-if="canRetry" @click="execute" class="retry-button">
              é‡è¯•
            </button>
            <button @click="reset" class="reset-button">
              é‡ç½®
            </button>
          </div>
        </div>
      </slot>
    </div>

    <!-- åˆå§‹çŠ¶æ€ -->
    <div v-else class="idle-state">
      <slot name="idle" :execute="execute">
        <div class="default-idle">
          <p>å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æ‰§è¡Œæ“ä½œ</p>
          <button @click="execute" class="execute-button">
            {{ executeButtonText }}
          </button>
        </div>
      </slot>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'

const props = defineProps({
  // å¼‚æ­¥æ“ä½œå‡½æ•°
  asyncOperation: {
    type: Function,
    required: true
  },
  // æœ€å¤§é‡è¯•æ¬¡æ•°
  maxRetries: {
    type: Number,
    default: 3
  },
  // é‡è¯•å»¶è¿Ÿ
  retryDelay: {
    type: Number,
    default: 1000
  },
  // æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡
  showProgress: {
    type: Boolean,
    default: false
  },
  // è‡ªå®šä¹‰æ¶ˆæ¯
  loadingMessage: {
    type: String,
    default: 'å¤„ç†ä¸­...'
  },
  successMessage: {
    type: String,
    default: 'æ“ä½œæˆåŠŸ'
  },
  executeButtonText: {
    type: String,
    default: 'æ‰§è¡Œ'
  },
  // æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œ
  autoExecute: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['loading', 'success', 'error', 'retry', 'reset'])

// çŠ¶æ€ç®¡ç†
const state = ref('idle') // idle, loading, success, error
const result = ref(null)
const error = ref(null)
const isLoading = ref(false)
const retryCount = ref(0)
const loadingProgress = ref(0)

// è®¡ç®—å±æ€§
const isSuccess = computed(() => state.value === 'success')
const canRetry = computed(() => retryCount.value < props.maxRetries)

// æ‰§è¡Œå¼‚æ­¥æ“ä½œ
async function execute() {
  if (isLoading.value) return

  state.value = 'loading'
  isLoading.value = true
  error.value = null
  emit('loading')

  try {
    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°ï¼ˆå¦‚æœæ“ä½œæ”¯æŒè¿›åº¦å›è°ƒï¼‰
    let progress = 0
    const progressInterval = props.showProgress ? setInterval(() => {
      progress += Math.random() * 20
      loadingProgress.value = Math.min(progress, 90)
    }, 200) : null

    // æ‰§è¡Œå¼‚æ­¥æ“ä½œ
    const operationResult = await Promise.race([
      props.asyncOperation({
        onProgress: (progressValue) => {
          if (props.showProgress) {
            loadingProgress.value = progressValue
          }
        }
      }),
      new Promise((_, reject) => {
        setTimeout(() => reject(new Error('æ“ä½œè¶…æ—¶')), 30000)
      })
    ])

    if (progressInterval) {
      clearInterval(progressInterval)
    }

    loadingProgress.value = 100

    // æˆåŠŸå¤„ç†
    result.value = operationResult
    state.value = 'success'
    retryCount.value = 0
    emit('success', operationResult)

  } catch (err) {
    // é”™è¯¯å¤„ç†
    error.value = {
      title: getErrorTitle(err),
      message: err.message || 'æœªçŸ¥é”™è¯¯',
      code: err.code,
      details: err
    }
    state.value = 'error'
    emit('error', error.value)

    // è‡ªåŠ¨é‡è¯•
    if (canRetry.value) {
      setTimeout(() => {
        retryCount.value++
        emit('retry', retryCount.value)
        execute()
      }, props.retryDelay * retryCount.value)
    }

  } finally {
    isLoading.value = false
    if (props.showProgress) {
      loadingProgress.value = 0
    }
  }
}

// è·å–é”™è¯¯æ ‡é¢˜
function getErrorTitle(err) {
  if (err.code === 'NETWORK_ERROR') return 'ç½‘ç»œé”™è¯¯'
  if (err.code === 'TIMEOUT') return 'è¯·æ±‚è¶…æ—¶'
  if (err.code === 'PERMISSION_DENIED') return 'æƒé™ä¸è¶³'
  return 'æ“ä½œå¤±è´¥'
}

// é‡ç½®çŠ¶æ€
function reset() {
  state.value = 'idle'
  result.value = null
  error.value = null
  isLoading.value = false
  retryCount.value = 0
  loadingProgress.value = 0
  emit('reset')
}

// ç›‘å¬è‡ªåŠ¨æ‰§è¡Œ
watch(() => props.autoExecute, (autoExecute) => {
  if (autoExecute && state.value === 'idle') {
    execute()
  }
}, { immediate: true })

// æš´éœ²æ–¹æ³•
defineExpose({
  execute,
  reset,
  retry: execute,
  state: readonly(state),
  result: readonly(result),
  error: readonly(error),
  isLoading: readonly(isLoading)
})
</script>

<style scoped>
.async-handler {
  min-height: 100px;
}

.loading-state,
.success-state,
.error-state,
.idle-state {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100px;
  padding: 20px;
}

.default-loading,
.default-success,
.default-error,
.default-idle {
  text-align: center;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #42b883;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.progress-bar {
  width: 200px;
  height: 8px;
  background: #f3f3f3;
  border-radius: 4px;
  margin: 16px auto 0;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: #42b883;
  transition: width 0.3s ease;
}

.success-icon,
.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.error-actions,
.execute-button {
  margin-top: 16px;
}

.retry-button,
.reset-button,
.execute-button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin: 0 5px;
}

.retry-button {
  background: #ff9800;
  color: white;
}

.reset-button {
  background: #f44336;
  color: white;
}

.execute-button {
  background: #42b883;
  color: white;
}

.retry-button:hover,
.reset-button:hover,
.execute-button:hover {
  opacity: 0.9;
}
</style>
```

---

## ğŸ“ æœ¬ç« å°ç»“

### âœ… æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ

1. **è®¾è®¡åŸåˆ™** - å•ä¸€èŒè´£ã€å¼€é—­åŸåˆ™ã€ç»„åˆä¼˜äºç»§æ‰¿
2. **æ€§èƒ½ä¼˜åŒ–** - æ‡’åŠ è½½ã€è™šæ‹Ÿæ»šåŠ¨ã€ç»„ä»¶ç¼“å­˜
3. **ä»£ç è§„èŒƒ** - å‘½åè§„èŒƒã€ç›®å½•ç»“æ„ã€ä»£ç ç»„ç»‡
4. **é”™è¯¯å¤„ç†** - é”™è¯¯è¾¹ç•Œã€å¼‚æ­¥é”™è¯¯ã€é‡è¯•æœºåˆ¶
5. **å¯ç»´æŠ¤æ€§** - æµ‹è¯•ã€æ–‡æ¡£ã€ç‰ˆæœ¬ç®¡ç†

### ğŸ¯ å®è·µèƒ½åŠ›

- [ ] èƒ½å¤Ÿè®¾è®¡èŒè´£æ¸…æ™°çš„å¯å¤ç”¨ç»„ä»¶
- [ ] èƒ½å¤Ÿå®ç°é«˜æ€§èƒ½çš„ç»„ä»¶ä¼˜åŒ–
- [ ] èƒ½å¤Ÿéµå¾ªè§„èŒƒçš„ä»£ç é£æ ¼
- [ ] èƒ½å¤Ÿå¤„ç†å„ç§é”™è¯¯åœºæ™¯
- [ ] èƒ½å¤Ÿæ„å»ºå¯ç»´æŠ¤çš„ç»„ä»¶æ¶æ„

### ğŸš€ å­¦ä¹ è·¯å¾„æ€»ç»“

é€šè¿‡è¿™ä¸ªç³»åˆ—çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ï¼š

1. **ç»„ä»¶åŸºç¡€** - [[02-Vueç»„ä»¶åŸºç¡€æ¦‚å¿µè¯¦è§£.md|ä»€ä¹ˆæ˜¯ç»„ä»¶]]
2. **ç»„ä»¶ç»“æ„** - [[03-Vueå•æ–‡ä»¶ç»„ä»¶ç»“æ„è¯¦è§£.md|SFCç»“æ„]]
3. **å±æ€§ä¼ é€’** - [[04-Vueç»„ä»¶Propsä¼ é€’æœºåˆ¶è¯¦è§£.md|Propsæœºåˆ¶]]
4. **ç»„ä»¶å¤ç”¨** - [[05-Vueç»„ä»¶å¤ç”¨ä¸å®ä¾‹åŒ–è¯¦è§£.md|å®ä¾‹åŒ–æœºåˆ¶]]
5. **ç»„ä»¶é€šä¿¡** - [[06-Vueç»„ä»¶é€šä¿¡æœºåˆ¶è¯¦è§£.md|é€šä¿¡æ–¹å¼]]
6. **æœ€ä½³å®è·µ** - æœ¬ç« å†…å®¹

---

## ğŸ’¡ ç»„ä»¶å¼€å‘ç»ˆæé‡‘ç§‘ç‰å¾‹

1. **ç»„ä»¶æ˜¯UIçš„å‡½æ•°** - è®¾è®¡ç»„ä»¶å°±åƒè®¾è®¡å‡½æ•°ï¼Œå…³æ³¨è¾“å…¥ã€è¾“å‡ºå’Œå‰¯ä½œç”¨
2. **æ€§èƒ½æ˜¯ç”¨æˆ·ä½“éªŒ** - å§‹ç»ˆè€ƒè™‘æ¸²æŸ“æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨
3. **å¯ç»´æŠ¤æ€§æ˜¯å¯¿å‘½** - å¥½çš„ç»„ä»¶è®¾è®¡è®©ä»£ç æ´»å¾—é•¿ä¹…
4. **é”™è¯¯æ˜¯å¿…ç„¶** - ä¼˜é›…å¤„ç†é”™è¯¯ï¼Œè€Œä¸æ˜¯é¿å…é”™è¯¯
5. **æµ‹è¯•æ˜¯ä¿é™©** - æ²¡æœ‰æµ‹è¯•çš„ç»„ä»¶å°±åƒæ²¡æœ‰ä¿é™©çš„æ±½è½¦

**è®°ä½ï¼šä¼˜ç§€çš„ç»„ä»¶è®¾è®¡æ˜¯ä¼˜ç§€Vueåº”ç”¨çš„åŸºçŸ³ï¼** ğŸ‰

---

## ğŸŠ Vueç»„ä»¶å­¦ä¹ è·¯çº¿å›¾

```
ğŸ¯ Vueç»„ä»¶å­¦ä¹ å®Œæˆè·¯çº¿å›¾ï¼š

âœ… åŸºç¡€æ¦‚å¿µ
   â”œâ”€â”€ ç»„ä»¶æœ¬è´¨ä¸æ€æƒ³
   â”œâ”€â”€ ç»„ä»¶åŒ–ç¼–ç¨‹æ€ç»´
   â””â”€â”€ ç»„ä»¶ä¸å®ä¾‹å…³ç³»

âœ… ç»„ä»¶ç»“æ„
   â”œâ”€â”€ å•æ–‡ä»¶ç»„ä»¶(SFC)
   â”œâ”€â”€ Templateæ¨¡æ¿è¯­æ³•
   â”œâ”€â”€ Scriptè„šæœ¬é€»è¾‘
   â””â”€â”€ Styleæ ·å¼ç®¡ç†

âœ… å±æ€§ä¼ é€’
   â”œâ”€â”€ Propså®šä¹‰ä¸éªŒè¯
   â”œâ”€â”€ åŠ¨æ€Propsä¼ é€’
   â”œâ”€â”€ v-modelåŒå‘ç»‘å®š
   â””â”€â”€ Propsé«˜çº§ç”¨æ³•

âœ… ç»„ä»¶å¤ç”¨
   â”œâ”€â”€ å®ä¾‹ç‹¬ç«‹æ€§åŸç†
   â”œâ”€â”€ åŠ¨æ€ç»„ä»¶ä¸keep-alive
   â”œâ”€â”€ ç»„ä»¶æ± åŒ–ç®¡ç†
   â””â”€â”€ è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

âœ… ç»„ä»¶é€šä¿¡
   â”œâ”€â”€ çˆ¶å­ç»„ä»¶é€šä¿¡
   â”œâ”€â”€ å…„å¼Ÿç»„ä»¶é€šä¿¡
   â”œâ”€â”€ è·¨å±‚çº§é€šä¿¡
   â””â”€â”€ çŠ¶æ€ç®¡ç†é€šä¿¡

âœ… æœ€ä½³å®è·µ
   â”œâ”€â”€ è®¾è®¡åŸåˆ™
   â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–
   â”œâ”€â”€ ä»£ç è§„èŒƒ
   â”œâ”€â”€ é”™è¯¯å¤„ç†
   â””â”€â”€ æµ‹è¯•ç»´æŠ¤

ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ æ–¹å‘ï¼š
   â”œâ”€â”€ Vue Router è·¯ç”±ç³»ç»Ÿ
   â”œâ”€â”€ Pinia çŠ¶æ€ç®¡ç†
   â”œâ”€â”€ Vue CLI å·¥ç¨‹åŒ–
   â””â”€â”€ Vue 3 ç”Ÿæ€ç³»ç»Ÿ
```

**æ­å–œä½ å®Œæˆäº†Vueç»„ä»¶å­¦ä¹ çš„å…¨éƒ¨å†…å®¹ï¼** ğŸŠ