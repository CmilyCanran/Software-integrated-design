# ç¬¬3ç« ï¼šç”¨æˆ·çŠ¶æ€ç®¡ç†

> **å­¦ä¹ ç›®æ ‡**ï¼šä½¿ç”¨Piniaå®ç°ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†ï¼ŒæŒæ¡çŠ¶æ€æŒä¹…åŒ–å’Œå…±äº«

## ğŸ¯ æœ¬ç« æ¦‚è§ˆ

| å†…å®¹ | é¢„è®¡æ—¶é—´ | éš¾åº¦ | çŠ¶æ€ |
|------|----------|------|------|
| PiniaåŸºç¡€æ¦‚å¿µ | 10åˆ†é’Ÿ | â­â­ | â³ |
| åˆ›å»ºç”¨æˆ·Store | 15åˆ†é’Ÿ | â­â­â­ | â³ |
| çŠ¶æ€æŒä¹…åŒ– | 10åˆ†é’Ÿ | â­â­ | â³ |
| å®è·µåº”ç”¨ | 5åˆ†é’Ÿ | â­ | â³ |

---

## ğŸ“š Piniaç®€ä»‹

### ä»€ä¹ˆæ˜¯Piniaï¼Ÿ
Piniaæ˜¯Vueçš„å®˜æ–¹çŠ¶æ€ç®¡ç†åº“ï¼Œæ˜¯Vuexçš„ç»§ä»»è€…ï¼Œæä¾›äº†æ›´ç®€å•ã€æ›´ç›´è§‚çš„APIã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼Ÿ
æƒ³è±¡è¿™äº›åœºæ™¯ï¼š
- ç”¨æˆ·åœ¨ç™»å½•é¡µé¢ç™»å½• â†’ è·³è½¬åˆ°å•†å“é¡µé¢ â†’ å•†å“é¡µé¢ä¸çŸ¥é“ç”¨æˆ·å·²ç™»å½•
- ç”¨æˆ·æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ â†’ è·³è½¬åˆ°è´­ç‰©è½¦é¡µé¢ â†’ è´­ç‰©è½¦æ˜¯ç©ºçš„
- ç”¨æˆ·åˆ·æ–°é¡µé¢ â†’ ç™»å½•çŠ¶æ€ä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ç™»å½•

Piniaè§£å†³äº†è¿™äº›é—®é¢˜ï¼Œæä¾›äº†ä¸€ä¸ªå…¨å±€çš„æ•°æ®ä»“åº“ã€‚

---

## ğŸª åˆ›å»ºç”¨æˆ·è®¤è¯Store

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºStoreæ–‡ä»¶
åœ¨ `src/stores/` ç›®å½•ä¸‹åˆ›å»º `auth.js`ï¼š

```javascript
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useAuthStore = defineStore('auth', () => {
  // ğŸ”¹ çŠ¶æ€æ•°æ®
  const token = ref(localStorage.getItem('token') || '')
  const userInfo = ref(JSON.parse(localStorage.getItem('userInfo') || '{}'))
  const loading = ref(false)

  // ğŸ”¹ è®¡ç®—å±æ€§
  const isLoggedIn = computed(() => !!token.value)
  const isAdmin = computed(() => userInfo.value.role === 'admin')
  const username = computed(() => userInfo.value.username || '')
  const userId = computed(() => userInfo.value.id || null)

  // ğŸ”¹ æ–¹æ³•
  const login = (loginData) => {
    token.value = loginData.token
    userInfo.value = loginData.user

    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('token', loginData.token)
    localStorage.setItem('userInfo', JSON.stringify(loginData.user))
  }

  const logout = () => {
    token.value = ''
    userInfo.value = {}

    // æ¸…é™¤localStorage
    localStorage.removeItem('token')
    localStorage.removeItem('userInfo')
  }

  const updateUserInfo = (newUserInfo) => {
    userInfo.value = { ...userInfo.value, ...newUserInfo }
    localStorage.setItem('userInfo', JSON.stringify(userInfo.value))
  }

  const setLoading = (status) => {
    loading.value = status
  }

  return {
    // çŠ¶æ€
    token,
    userInfo,
    loading,

    // è®¡ç®—å±æ€§
    isLoggedIn,
    isAdmin,
    username,
    userId,

    // æ–¹æ³•
    login,
    logout,
    updateUserInfo,
    setLoading
  }
})
```

### Storeç»“æ„è§£æ

#### ğŸ”¸ çŠ¶æ€ï¼ˆStateï¼‰
```javascript
// ç”¨æˆ·è®¤è¯ä»¤ç‰Œ
const token = ref(localStorage.getItem('token') || '')

// ç”¨æˆ·ä¿¡æ¯å¯¹è±¡
const userInfo = ref(JSON.parse(localStorage.getItem('userInfo') || '{}'))

// åŠ è½½çŠ¶æ€
const loading = ref(false)
```

#### ğŸ”¸ è®¡ç®—å±æ€§ï¼ˆGettersï¼‰
```javascript
// æ˜¯å¦å·²ç™»å½•
const isLoggedIn = computed(() => !!token.value)

// æ˜¯å¦ä¸ºç®¡ç†å‘˜
const isAdmin = computed(() => userInfo.value.role === 'admin')

// ç”¨æˆ·å
const username = computed(() => userInfo.value.username || '')

// ç”¨æˆ·ID
const userId = computed(() => userInfo.value.id || null)
```

#### ğŸ”¸ æ–¹æ³•ï¼ˆActionsï¼‰
```javascript
// ç™»å½•æ–¹æ³•
const login = (loginData) => {
  // æ›´æ–°çŠ¶æ€
  token.value = loginData.token
  userInfo.value = loginData.user

  // æŒä¹…åŒ–å­˜å‚¨
  localStorage.setItem('token', loginData.token)
  localStorage.setItem('userInfo', JSON.stringify(loginData.user))
}

// ç™»å‡ºæ–¹æ³•
const logout = () => {
  // æ¸…é™¤çŠ¶æ€
  token.value = ''
  userInfo.value = {}

  // æ¸…é™¤å­˜å‚¨
  localStorage.removeItem('token')
  localStorage.removeItem('userInfo')
}
```

---

## ğŸ”„ åœ¨ç»„ä»¶ä¸­ä½¿ç”¨Store

### åŸºæœ¬ç”¨æ³•
```vue
<template>
  <div>
    <div v-if="authStore.isLoggedIn">
      æ¬¢è¿ï¼Œ{{ authStore.username }}ï¼
      <button @click="handleLogout">é€€å‡ºç™»å½•</button>
    </div>
    <div v-else>
      <button @click="handleLogin">ç™»å½•</button>
    </div>
  </div>
</template>

<script setup>
import { useAuthStore } from '@/stores/auth'

const authStore = useAuthStore()

const handleLogin = () => {
  // æ¨¡æ‹Ÿç™»å½•
  authStore.login({
    token: 'mock-token-123',
    user: {
      id: 1,
      username: 'admin',
      email: 'admin@example.com',
      role: 'admin'
    }
  })
}

const handleLogout = () => {
  authStore.logout()
}
</script>
```

### åœ¨å¤šä¸ªç»„ä»¶é—´å…±äº«çŠ¶æ€
```vue
<!-- Header.vue -->
<template>
  <header>
    <div v-if="authStore.isLoggedIn">
      ç”¨æˆ·ï¼š{{ authStore.username }}
      <el-tag :type="authStore.isAdmin ? 'danger' : 'success'">
        {{ authStore.isAdmin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}
      </el-tag>
    </div>
    <div v-else>
      æœªç™»å½•
    </div>
  </header>
</template>

<script setup>
import { useAuthStore } from '@/stores/auth'
const authStore = useAuthStore()
</script>
```

```vue
<!-- UserProfile.vue -->
<template>
  <div>
    <h2>ç”¨æˆ·èµ„æ–™</h2>
    <p>ç”¨æˆ·åï¼š{{ authStore.username }}</p>
    <p>é‚®ç®±ï¼š{{ authStore.userInfo.email }}</p>
    <p>è§’è‰²ï¼š{{ authStore.isAdmin ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·' }}</p>
  </div>
</template>

<script setup>
import { useAuthStore } from '@/stores/auth'
const authStore = useAuthStore()
</script>
```

---

## ğŸ’¾ çŠ¶æ€æŒä¹…åŒ–è¯¦è§£

### ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–ï¼Ÿ
- **é¡µé¢åˆ·æ–°** - é˜²æ­¢ç”¨æˆ·çŠ¶æ€ä¸¢å¤±
- **å¤šæ ‡ç­¾é¡µ** - ä¿æŒç™»å½•çŠ¶æ€åŒæ­¥
- **ç”¨æˆ·ä½“éªŒ** - é¿å…é‡å¤ç™»å½•

### localStorage vs sessionStorage
```javascript
// localStorage - æŒä¹…å­˜å‚¨ï¼Œå…³é—­æµè§ˆå™¨åä»ç„¶å­˜åœ¨
localStorage.setItem('token', 'user-token-123')
const token = localStorage.getItem('token')

// sessionStorage - ä¼šè¯å­˜å‚¨ï¼Œå…³é—­æµè§ˆå™¨åæ¸…é™¤
sessionStorage.setItem('tempData', 'temporary')
const tempData = sessionStorage.getItem('tempData')
```

### å®Œæ•´çš„æŒä¹…åŒ–ç­–ç•¥
```javascript
export const useAuthStore = defineStore('auth', () => {
  const token = ref('')
  const userInfo = ref({})

  // ğŸ”¹ åˆå§‹åŒ–æ—¶ä»localStorageæ¢å¤çŠ¶æ€
  const initializeAuth = () => {
    const savedToken = localStorage.getItem('token')
    const savedUserInfo = localStorage.getItem('userInfo')

    if (savedToken) {
      token.value = savedToken
    }

    if (savedUserInfo) {
      try {
        userInfo.value = JSON.parse(savedUserInfo)
      } catch (error) {
        console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
        userInfo.value = {}
      }
    }
  }

  // ğŸ”¹ ç™»å½•æ—¶ä¿å­˜çŠ¶æ€
  const login = (loginData) => {
    token.value = loginData.token
    userInfo.value = loginData.user

    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('token', loginData.token)
    localStorage.setItem('userInfo', JSON.stringify(loginData.user))
  }

  // ğŸ”¹ ç™»å‡ºæ—¶æ¸…é™¤çŠ¶æ€
  const logout = () => {
    token.value = ''
    userInfo.value = {}

    // æ¸…é™¤localStorage
    localStorage.removeItem('token')
    localStorage.removeItem('userInfo')
  }

  // ğŸ”¹ é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  initializeAuth()

  return {
    token,
    userInfo,
    login,
    logout
  }
})
```

---

## ğŸ› ï¸ å®è·µç»ƒä¹ 

### ç»ƒä¹ ï¼šåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„è®¤è¯çŠ¶æ€ç®¡ç†
```javascript
// src/stores/auth.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useAuthStore = defineStore('auth', () => {
  // çŠ¶æ€
  const token = ref(localStorage.getItem('token') || '')
  const userInfo = ref(JSON.parse(localStorage.getItem('userInfo') || '{}'))
  const loading = ref(false)
  const error = ref('')

  // è®¡ç®—å±æ€§
  const isLoggedIn = computed(() => !!token.value)
  const isAdmin = computed(() => userInfo.value.role === 'admin')
  const displayName = computed(() => userInfo.value.username || userInfo.value.email || 'ç”¨æˆ·')

  // æ–¹æ³•
  const login = async (credentials) => {
    try {
      loading.value = true
      error.value = ''

      // æ¨¡æ‹ŸAPIè°ƒç”¨
      await new Promise(resolve => setTimeout(resolve, 1000))

      // æ¨¡æ‹Ÿç™»å½•æˆåŠŸ
      if (credentials.username === 'admin' && credentials.password === '123456') {
        const loginData = {
          token: 'mock-admin-token-' + Date.now(),
          user: {
            id: 1,
            username: 'admin',
            email: 'admin@example.com',
            role: 'admin',
            avatar: 'https://via.placeholder.com/100x100?text=Admin'
          }
        }

        token.value = loginData.token
        userInfo.value = loginData.user

        localStorage.setItem('token', loginData.token)
        localStorage.setItem('userInfo', JSON.stringify(loginData.user))

        return { success: true }
      } else {
        throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
      }

    } catch (err) {
      error.value = err.message
      return { success: false, error: err.message }
    } finally {
      loading.value = false
    }
  }

  const logout = () => {
    token.value = ''
    userInfo.value = {}
    error.value = ''

    localStorage.removeItem('token')
    localStorage.removeItem('userInfo')
  }

  const clearError = () => {
    error.value = ''
  }

  return {
    // çŠ¶æ€
    token,
    userInfo,
    loading,
    error,

    // è®¡ç®—å±æ€§
    isLoggedIn,
    isAdmin,
    displayName,

    // æ–¹æ³•
    login,
    logout,
    clearError
  }
})
```

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
```vue
<template>
  <div class="auth-demo">
    <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
    <div v-if="authStore.isLoggedIn" class="user-info">
      <h3>å½“å‰ç”¨æˆ·ä¿¡æ¯</h3>
      <p>ç”¨æˆ·åï¼š{{ authStore.displayName }}</p>
      <p>è§’è‰²ï¼š{{ authStore.isAdmin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}</p>
      <p>Tokenï¼š{{ authStore.token.substring(0, 20) }}...</p>
      <el-button @click="handleLogout" type="danger">é€€å‡ºç™»å½•</el-button>
    </div>

    <!-- ç™»å½•è¡¨å• -->
    <div v-else class="login-form">
      <h3>ç”¨æˆ·ç™»å½•</h3>
      <el-form @submit.prevent="handleLogin">
        <el-form-item>
          <el-input
            v-model="loginForm.username"
            placeholder="ç”¨æˆ·å"
            prefix-icon="User"
          />
        </el-form-item>
        <el-form-item>
          <el-input
            v-model="loginForm.password"
            type="password"
            placeholder="å¯†ç "
            prefix-icon="Lock"
          />
        </el-form-item>
        <el-form-item>
          <el-button
            type="primary"
            @click="handleLogin"
            :loading="authStore.loading"
            style="width: 100%"
          >
            ç™»å½•
          </el-button>
        </el-form-item>
      </el-form>

      <!-- é”™è¯¯ä¿¡æ¯ -->
      <el-alert
        v-if="authStore.error"
        :title="authStore.error"
        type="error"
        show-icon
        @close="authStore.clearError"
      />
    </div>

    <!-- æµ‹è¯•è´¦å·æç¤º -->
    <div class="test-accounts">
      <el-divider>æµ‹è¯•è´¦å·</el-divider>
      <el-tag type="info">admin / 123456</el-tag>
    </div>
  </div>
</template>

<script setup>
import { reactive } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { ElMessage } from 'element-plus'

const authStore = useAuthStore()

const loginForm = reactive({
  username: '',
  password: ''
})

const handleLogin = async () => {
  if (!loginForm.username || !loginForm.password) {
    ElMessage.warning('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ')
    return
  }

  const result = await authStore.login(loginForm)

  if (result.success) {
    ElMessage.success('ç™»å½•æˆåŠŸ')
  } else {
    ElMessage.error(result.error)
  }
}

const handleLogout = () => {
  authStore.logout()
  ElMessage.success('å·²é€€å‡ºç™»å½•')
}
</script>

<style scoped>
.auth-demo {
  max-width: 400px;
  margin: 0 auto;
  padding: 20px;
}

.user-info, .login-form {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.test-accounts {
  text-align: center;
  margin-top: 20px;
}
</style>
```

---

## ğŸ“ æœ¬ç« å°ç»“

### âœ… æŒæ¡æŠ€èƒ½
- [x] **PiniaåŸºç¡€æ¦‚å¿µ** - ç†è§£çŠ¶æ€ç®¡ç†çš„å¿…è¦æ€§
- [x] **Storeåˆ›å»º** - èƒ½å¤Ÿåˆ›å»ºå’Œä½¿ç”¨Pinia Store
- [x] **çŠ¶æ€æŒä¹…åŒ–** - æŒæ¡localStorageçš„ä½¿ç”¨
- [x] **ç»„ä»¶é›†æˆ** - åœ¨Vueç»„ä»¶ä¸­ä½¿ç”¨Store

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ
- **defineStore** - åˆ›å»ºStoreçš„æ ¸å¿ƒå‡½æ•°
- **ref/reactive** - å“åº”å¼æ•°æ®
- **computed** - è®¡ç®—å±æ€§
- **localStorage** - çŠ¶æ€æŒä¹…åŒ–

### ğŸš€ ä¸‹ä¸€æ­¥
ç”¨æˆ·çŠ¶æ€ç®¡ç†å·²ç»å®Œæˆï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹ è·¯ç”±é…ç½®å’Œå¯¼èˆªå®ˆå«ï¼Œå®ç°é¡µé¢è®¿é—®æƒé™æ§åˆ¶ã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1: Piniaå’ŒVuexæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
**A**:
- **Pinia** æ›´ç®€æ´ï¼ŒAPIæ›´ç›´è§‚
- **Pinia** å¯¹TypeScriptæ”¯æŒæ›´å¥½
- **Pinia** æ²¡æœ‰mutationsï¼Œç›´æ¥ä¿®æ”¹çŠ¶æ€
- **Pinia** æ”¯æŒå¤šä¸ªStore

### Q2: ä¸ºä»€ä¹ˆçŠ¶æ€è¦åŒæ—¶å­˜åœ¨å†…å­˜å’ŒlocalStorageï¼Ÿ
**A**:
- **å†…å­˜** - å“åº”å¼æ›´æ–°ï¼Œç»„ä»¶èƒ½å®æ—¶æ„ŸçŸ¥å˜åŒ–
- **localStorage** - æŒä¹…åŒ–å­˜å‚¨ï¼Œé¡µé¢åˆ·æ–°åä¸ä¸¢å¤±

### Q3: ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼Ÿ
**A**:
- å¤šä¸ªç»„ä»¶éœ€è¦å…±äº«æ•°æ®
- éœ€è¦è·¨é¡µé¢ä¿æŒçŠ¶æ€
- å¤æ‚çš„çŠ¶æ€é€»è¾‘éœ€è¦ç»Ÿä¸€ç®¡ç†

---

**æ­å–œï¼æ‚¨å·²ç»æŒæ¡äº†ç”¨æˆ·çŠ¶æ€ç®¡ç†ã€‚** ğŸ‰

**ä¸‹ä¸€ç« ï¼š[04-è·¯ç”±é…ç½®ä¸å®ˆå«](04-è·¯ç”±é…ç½®ä¸å®ˆå«.md)**