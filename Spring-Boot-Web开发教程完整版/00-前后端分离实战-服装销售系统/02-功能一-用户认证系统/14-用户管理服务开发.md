---
tags:
  - ç”¨æˆ·ç®¡ç†
  - ä¸šåŠ¡æœåŠ¡
  - æ•°æ®éªŒè¯
  - ç”¨æˆ·æ³¨å†Œ
  - å¯†ç åŠ å¯†
created: 2025-11-19
modified: 2025-11-19
category: å¼€å‘æ•™ç¨‹
difficulty: intermediate
---

# 03-ç”¨æˆ·ç®¡ç†æœåŠ¡å¼€å‘

> **å­¦ä¹ ç›®æ ‡**: å®ç°å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œã€ä¿¡æ¯ç®¡ç†ã€æ•°æ®éªŒè¯ç­‰åŠŸèƒ½

## ğŸ¯ æœ¬ç« æ¦‚è§ˆ

**å­¦ä¹ æ—¶é—´**: 45-60åˆ†é’Ÿ | **éš¾åº¦ç­‰çº§**: â­â­â­ | **é‡ç‚¹ç¨‹åº¦**: ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

ç”¨æˆ·ç®¡ç†æœåŠ¡æ˜¯è®¤è¯ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡å±‚ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·æ³¨å†Œã€ä¿¡æ¯æ›´æ–°ã€æ•°æ®éªŒè¯ç­‰ä¸šåŠ¡é€»è¾‘ã€‚æœ¬ç« å°†æ•™ä½ å®ç°å®Œæ•´çš„ç”¨æˆ·ç®¡ç†æœåŠ¡ã€‚

---

## ğŸ“‹ æ ¸å¿ƒéœ€æ±‚

### ğŸ¯ ä¸šåŠ¡ç›®æ ‡
- å®ç°ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
- æä¾›ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- å¤„ç†ç”¨æˆ·çŠ¶æ€å˜æ›´

### ğŸ› ï¸ æŠ€æœ¯éœ€æ±‚
- Spring Serviceå±‚å¼€å‘
- æ•°æ®éªŒè¯å’Œä¸šåŠ¡è§„åˆ™
- äº‹åŠ¡ç®¡ç†
- å¼‚å¸¸å¤„ç†

---

## ğŸ—ï¸ ç”¨æˆ·ç®¡ç†æ¶æ„

### ğŸ¯ æœåŠ¡å±‚æ¶æ„å›¾

```mermaid
graph TD
    A[Controllerå±‚] --> B[UserService]
    B --> C[UserRepository]
    C --> D[MySQLæ•°æ®åº“]

    B --> E[PasswordEncoder]
    B --> F[Validation]
    B --> G[ExceptionHandler]

    H[AuthService] --> B
    I[JwtUtil] --> H

    style A fill:#e3f2fd
    style B fill:#bbdefb
    style C fill:#90caf9
    style D fill:#64b5f6
    style E fill:#ffa726
    style F fill:#66bb6a
    style G fill:#ef5350
    style H fill:#9c27b0
    style I fill:#4caf50
```

---

## ğŸ’» å®æˆ˜ï¼šç”¨æˆ·å®ä½“å’ŒRepository

### 1ï¸âƒ£ ç”¨æˆ·å®ä½“æ¨¡å‹

```java
package com.cmliy.springweb.model;

import jakarta.persistence.*;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.time.LocalDateTime;

/**
 * ğŸ‘¤ ç”¨æˆ·å®ä½“æ¨¡å‹
 * å¯¹åº”æ•°æ®åº“usersè¡¨
 */
@Entity
@Table(name = "users", indexes = {
    @Index(name = "idx_username", columnList = "username"),
    @Index(name = "idx_email", columnList = "email")
})
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´")
    @Column(name = "username", unique = true, nullable = false, length = 50)
    private String username;

    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Column(name = "email", unique = true, nullable = false, length = 100)
    private String email;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 6, message = "å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½")
    @Column(name = "password", nullable = false)
    private String password;

    @Column(name = "role", nullable = false, length = 20)
    private String role = "USER";

    @Column(name = "enabled", nullable = false)
    private Boolean enabled = true;

    @Column(name = "phone", length = 20)
    private String phone;

    @Column(name = "full_name", length = 100)
    private String fullName;

    @Column(name = "avatar_url", length = 500)
    private String avatarUrl;

    @Column(name = "last_login_time")
    private LocalDateTime lastLoginTime;

    @CreationTimestamp
    @Column(name = "created_at", updatable = false, nullable = false)
    private LocalDateTime createdAt;

    @UpdateTimestamp
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    // ğŸ—ï¸ é»˜è®¤æ„é€ å‡½æ•°
    public User() {}

    // ğŸ“ å¸¦å‚æ„é€ å‡½æ•°
    public User(String username, String email, String password, String role) {
        this.username = username;
        this.email = email;
        this.password = password;
        this.role = role;
    }

    // Getterå’ŒSetteræ–¹æ³•
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }

    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }

    public String getRole() { return role; }
    public void setRole(String role) { this.role = role; }

    public Boolean getEnabled() { return enabled; }
    public void setEnabled(Boolean enabled) { this.enabled = enabled; }

    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }

    public String getFullName() { return fullName; }
    public void setFullName(String fullName) { this.fullName = fullName; }

    public String getAvatarUrl() { return avatarUrl; }
    public void setAvatarUrl(String avatarUrl) { this.avatarUrl = avatarUrl; }

    public LocalDateTime getLastLoginTime() { return lastLoginTime; }
    public void setLastLoginTime(LocalDateTime lastLoginTime) { this.lastLoginTime = lastLoginTime; }

    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }

    public LocalDateTime getUpdatedAt() { return updatedAt; }
    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }

    // ğŸ¯ ç”¨æˆ·ä¿¡æ¯DTOè½¬æ¢
    public UserDTO toDTO() {
        UserDTO dto = new UserDTO();
        dto.setId(this.id);
        dto.setUsername(this.username);
        dto.setEmail(this.email);
        dto.setRole(this.role);
        dto.setEnabled(this.enabled);
        dto.setPhone(this.phone);
        dto.setFullName(this.fullName);
        dto.setAvatarUrl(this.avatarUrl);
        dto.setLastLoginTime(this.lastLoginTime);
        dto.setCreatedAt(this.createdAt);
        return dto;
    }

    @Override
    public String toString() {
        return "User{" +
               "id=" + id +
               ", username='" + username + '\'' +
               ", email='" + email + '\'' +
               ", role='" + role + '\'' +
               ", enabled=" + enabled +
               ", createdAt=" + createdAt +
               '}';
    }
}
```

### 2ï¸âƒ£ ç”¨æˆ·Repository

```java
package com.cmliy.springweb.repository;

import com.cmliy.springweb.model.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.Optional;

/**
 * ğŸ‘¤ ç”¨æˆ·æ•°æ®è®¿é—®å±‚
 * æä¾›ç”¨æˆ·æ•°æ®CRUDæ“ä½œ
 */
@Repository
public interface UserRepository extends JpaRepository<User, Long> {

    // ğŸ” æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
    Optional<User> findByUsername(String username);

    // ğŸ” æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
    Optional<User> findByEmail(String email);

    // ğŸ” æ ¹æ®ç”¨æˆ·åæˆ–é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
    Optional<User> findByUsernameOrEmail(String username, String email);

    // ğŸ” æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    boolean existsByUsername(String username);

    // ğŸ” æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
    boolean existsByEmail(String email);

    // ğŸ“Š ç»Ÿè®¡æŒ‡å®šè§’è‰²çš„ç”¨æˆ·æ•°é‡
    long countByRole(String role);

    // ğŸ“Š ç»Ÿè®¡å¯ç”¨çš„ç”¨æˆ·æ•°é‡
    long countByEnabledTrue();

    // ğŸ” æŸ¥æ‰¾æœ€è¿‘ç™»å½•çš„ç”¨æˆ·
    @Query("SELECT u FROM User u WHERE u.lastLoginTime >= :since ORDER BY u.lastLoginTime DESC")
    java.util.List<User> findRecentlyActiveUsers(@Param("since") LocalDateTime since);

    // ğŸ”„ æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
    @Modifying
    @Query("UPDATE User u SET u.lastLoginTime = :loginTime WHERE u.id = :userId")
    int updateLastLoginTime(@Param("userId") Long userId, @Param("loginTime") LocalDateTime loginTime);

    // ğŸ”„ æ›´æ–°ç”¨æˆ·çŠ¶æ€
    @Modifying
    @Query("UPDATE User u SET u.enabled = :enabled WHERE u.id = :userId")
    int updateUserEnabled(@Param("userId") Long userId, @Param("enabled") Boolean enabled);
}
```

---

## ğŸ› ï¸ ç”¨æˆ·æœåŠ¡å®ç°

### 1ï¸âƒ£ ç”¨æˆ·æœåŠ¡æ¥å£

```java
package com.cmliy.springweb.service;

import com.cmliy.springweb.dto.RegisterRequest;
import com.cmliy.springweb.dto.UserDTO;
import com.cmliy.springweb.dto.UserUpdateRequest;
import com.cmliy.springweb.model.User;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

import java.util.List;
import java.util.Optional;

/**
 * ğŸ‘¤ ç”¨æˆ·æœåŠ¡æ¥å£
 * å®šä¹‰ç”¨æˆ·ç®¡ç†ç›¸å…³çš„ä¸šåŠ¡æ“ä½œ
 */
public interface UserService {

    /**
     * ğŸ‘¤ åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆæ³¨å†Œï¼‰
     * @param registerRequest æ³¨å†Œè¯·æ±‚
     * @return åˆ›å»ºçš„ç”¨æˆ·
     */
    User registerUser(RegisterRequest registerRequest);

    /**
     * ğŸ” æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
     * @param id ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    Optional<User> findById(Long id);

    /**
     * ğŸ” æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
     * @param username ç”¨æˆ·å
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    Optional<User> findByUsername(String username);

    /**
     * ğŸ“ æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     * @param id ç”¨æˆ·ID
     * @param updateRequest æ›´æ–°è¯·æ±‚
     * @return æ›´æ–°åçš„ç”¨æˆ·
     */
    User updateUser(Long id, UserUpdateRequest updateRequest);

    /**
     * ğŸ” ä¿®æ”¹ç”¨æˆ·å¯†ç 
     * @param userId ç”¨æˆ·ID
     * @param oldPassword æ—§å¯†ç 
     * @param newPassword æ–°å¯†ç 
     * @return æ˜¯å¦ä¿®æ”¹æˆåŠŸ
     */
    boolean changePassword(Long userId, String oldPassword, String newPassword);

    /**
     * ğŸ”„ å¯ç”¨/ç¦ç”¨ç”¨æˆ·
     * @param userId ç”¨æˆ·ID
     * @param enabled æ˜¯å¦å¯ç”¨
     * @return æ˜¯å¦æ“ä½œæˆåŠŸ
     */
    boolean toggleUserStatus(Long userId, Boolean enabled);

    /**
     * ğŸ‘¥ è·å–æ‰€æœ‰ç”¨æˆ·ï¼ˆåˆ†é¡µï¼‰
     * @param pageable åˆ†é¡µå‚æ•°
     * @return ç”¨æˆ·åˆ†é¡µåˆ—è¡¨
     */
    Page<UserDTO> getAllUsers(Pageable pageable);

    /**
     * ğŸ” æ ¹æ®è§’è‰²è·å–ç”¨æˆ·
     * @param role ç”¨æˆ·è§’è‰²
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    List<UserDTO> getUsersByRole(String role);

    /**
     * ğŸ“Š è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
     * @return ç”¨æˆ·ç»Ÿè®¡
     */
    UserStatistics getUserStatistics();

    /**
     * ğŸ” æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨
     * @param username ç”¨æˆ·å
     * @return æ˜¯å¦å¯ç”¨
     */
    boolean isUsernameAvailable(String username);

    /**
     * ğŸ” æ£€æŸ¥é‚®ç®±æ˜¯å¦å¯ç”¨
     * @param email é‚®ç®±
     * @return æ˜¯å¦å¯ç”¨
     */
    boolean isEmailAvailable(String email);
}
```

### 2ï¸âƒ£ ç”¨æˆ·æœåŠ¡å®ç°ç±»

```java
package com.cmliy.springweb.service;

import com.cmliy.springweb.dto.RegisterRequest;
import com.cmliy.springweb.dto.UserDTO;
import com.cmliy.springweb.dto.UserUpdateRequest;
import com.cmliy.springweb.exception.BusinessException;
import com.cmliy.springweb.model.User;
import com.cmliy.springweb.repository.UserRepository;
import com.cmliy.springweb.util.PasswordUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * ğŸ‘¤ ç”¨æˆ·æœåŠ¡å®ç°
 * æä¾›ç”¨æˆ·ç®¡ç†çš„å…·ä½“ä¸šåŠ¡é€»è¾‘
 */
@Service
@Transactional
public class UserServiceImpl implements UserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    /**
     * ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ
     */
    @Override
    public User registerUser(RegisterRequest registerRequest) {
        // ğŸ” éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
        if (userRepository.existsByUsername(registerRequest.getUsername())) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨: " + registerRequest.getUsername());
        }

        // ğŸ” éªŒè¯é‚®ç®±å”¯ä¸€æ€§
        if (userRepository.existsByEmail(registerRequest.getEmail())) {
            throw new BusinessException("é‚®ç®±å·²è¢«æ³¨å†Œ: " + registerRequest.getEmail());
        }

        // ğŸ‘¤ åˆ›å»ºæ–°ç”¨æˆ·
        User user = new User();
        user.setUsername(registerRequest.getUsername());
        user.setEmail(registerRequest.getEmail());
        user.setPassword(passwordEncoder.encode(registerRequest.getPassword()));
        user.setRole("USER");  // é»˜è®¤è§’è‰²
        user.setEnabled(true);  // é»˜è®¤å¯ç”¨
        user.setFullName(registerRequest.getFullName());
        user.setPhone(registerRequest.getPhone());

        // ğŸ’¾ ä¿å­˜ç”¨æˆ·
        User savedUser = userRepository.save(user);

        System.out.println("âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ: " + savedUser.getUsername());
        return savedUser;
    }

    /**
     * ğŸ” æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
     */
    @Override
    @Transactional(readOnly = true)
    public Optional<User> findById(Long id) {
        return userRepository.findById(id);
    }

    /**
     * ğŸ” æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
     */
    @Override
    @Transactional(readOnly = true)
    public Optional<User> findByUsername(String username) {
        return userRepository.findByUsername(username);
    }

    /**
     * ğŸ“ æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    @Override
    public User updateUser(Long id, UserUpdateRequest updateRequest) {
        // ğŸ” æŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));

        // ğŸ“ æ›´æ–°åŸºæœ¬ä¿¡æ¯
        if (StringUtils.hasText(updateRequest.getFullName())) {
            user.setFullName(updateRequest.getFullName());
        }
        if (StringUtils.hasText(updateRequest.getPhone())) {
            user.setPhone(updateRequest.getPhone());
        }
        if (StringUtils.hasText(updateRequest.getAvatarUrl())) {
            user.setAvatarUrl(updateRequest.getAvatarUrl());
        }

        // ğŸ’¾ ä¿å­˜æ›´æ–°
        User updatedUser = userRepository.save(user);

        System.out.println("âœ… ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ: " + updatedUser.getUsername());
        return updatedUser;
    }

    /**
     * ğŸ” ä¿®æ”¹å¯†ç 
     */
    @Override
    public boolean changePassword(Long userId, String oldPassword, String newPassword) {
        // ğŸ” æŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));

        // âœ… éªŒè¯æ—§å¯†ç 
        if (!passwordEncoder.matches(oldPassword, user.getPassword())) {
            throw new BusinessException("åŸå¯†ç ä¸æ­£ç¡®");
        }

        // ğŸ” è®¾ç½®æ–°å¯†ç 
        user.setPassword(passwordEncoder.encode(newPassword));
        userRepository.save(user);

        System.out.println("âœ… å¯†ç ä¿®æ”¹æˆåŠŸ: " + user.getUsername());
        return true;
    }

    /**
     * ğŸ”„ å¯ç”¨/ç¦ç”¨ç”¨æˆ·
     */
    @Override
    public boolean toggleUserStatus(Long userId, Boolean enabled) {
        // ğŸ” æŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));

        // ğŸ”„ é˜²æ­¢ç¦ç”¨ç®¡ç†å‘˜è´¦æˆ·
        if ("ADMIN".equals(user.getRole()) && !enabled) {
            throw new BusinessException("ä¸èƒ½ç¦ç”¨ç®¡ç†å‘˜è´¦æˆ·");
        }

        // ğŸ”„ æ›´æ–°çŠ¶æ€
        user.setEnabled(enabled);
        userRepository.save(user);

        String status = enabled ? "å¯ç”¨" : "ç¦ç”¨";
        System.out.println("âœ… ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ: " + user.getUsername() + " å·²" + status);

        return true;
    }

    /**
     * ğŸ‘¥ è·å–æ‰€æœ‰ç”¨æˆ·ï¼ˆåˆ†é¡µï¼‰
     */
    @Override
    @Transactional(readOnly = true)
    public Page<UserDTO> getAllUsers(Pageable pageable) {
        return userRepository.findAll(pageable)
                .map(User::toDTO);
    }

    /**
     * ğŸ” æ ¹æ®è§’è‰²è·å–ç”¨æˆ·
     */
    @Override
    @Transactional(readOnly = true)
    public List<UserDTO> getUsersByRole(String role) {
        return userRepository.findAll().stream()
                .filter(user -> role.equals(user.getRole()))
                .map(User::toDTO)
                .collect(Collectors.toList());
    }

    /**
     * ğŸ“Š è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
     */
    @Override
    @Transactional(readOnly = true)
    public UserStatistics getUserStatistics() {
        long totalUsers = userRepository.count();
        long enabledUsers = userRepository.countByEnabledTrue();
        long adminUsers = userRepository.countByRole("ADMIN");
        long regularUsers = userRepository.countByRole("USER");

        // ğŸ” æœ€è¿‘æ´»è·ƒç”¨æˆ·
        LocalDateTime since = LocalDateTime.now().minusDays(7);
        List<User> recentlyActive = userRepository.findRecentlyActiveUsers(since);

        return new UserStatistics(
            totalUsers,
            enabledUsers,
            adminUsers,
            regularUsers,
            recentlyActive.size()
        );
    }

    /**
     * ğŸ” æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨
     */
    @Override
    @Transactional(readOnly = true)
    public boolean isUsernameAvailable(String username) {
        return !userRepository.existsByUsername(username);
    }

    /**
     * ğŸ” æ£€æŸ¥é‚®ç®±æ˜¯å¦å¯ç”¨
     */
    @Override
    @Transactional(readOnly = true)
    public boolean isEmailAvailable(String email) {
        return !userRepository.existsByEmail(email);
    }

    /**
     * ğŸ“ æ›´æ–°æœ€åç™»å½•æ—¶é—´
     */
    public void updateLastLoginTime(Long userId) {
        userRepository.updateLastLoginTime(userId, LocalDateTime.now());
    }
}
```

---

## ğŸ§ª ç”¨æˆ·æœåŠ¡æµ‹è¯•

### 1ï¸âƒ£ ç”¨æˆ·æ³¨å†Œæµ‹è¯•

```java
package com.cmliy.springweb.service;

import com.cmliy.springweb.dto.RegisterRequest;
import com.cmliy.springweb.exception.BusinessException;
import com.cmliy.springweb.model.User;
import com.cmliy.springweb.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.test.context.ActiveProfiles;

import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@SpringBootTest
@ActiveProfiles("test")
public class UserServiceTest {

    @Autowired
    private UserService userService;

    @MockBean
    private UserRepository userRepository;

    @MockBean
    private PasswordEncoder passwordEncoder;

    private RegisterRequest validRegisterRequest;

    @BeforeEach
    public void setUp() {
        validRegisterRequest = new RegisterRequest();
        validRegisterRequest.setUsername("testuser");
        validRegisterRequest.setEmail("test@example.com");
        validRegisterRequest.setPassword("password123");
        validRegisterRequest.setFullName("æµ‹è¯•ç”¨æˆ·");
        validRegisterRequest.setPhone("13800138000");
    }

    @Test
    public void testRegisterUserSuccess() {
        // ğŸ¯ æ¨¡æ‹ŸRepositoryè¡Œä¸º
        when(userRepository.existsByUsername("testuser")).thenReturn(false);
        when(userRepository.existsByEmail("test@example.com")).thenReturn(false);
        when(passwordEncoder.encode("password123")).thenReturn("encoded_password");
        when(userRepository.save(any(User.class))).thenAnswer(invocation -> {
            User user = invocation.getArgument(0);
            user.setId(1L);
            return user;
        });

        // ğŸ‘¤ æ‰§è¡Œæ³¨å†Œ
        User registeredUser = userService.registerUser(validRegisterRequest);

        // âœ… éªŒè¯ç»“æœ
        assertNotNull(registeredUser);
        assertEquals("testuser", registeredUser.getUsername());
        assertEquals("test@example.com", registeredUser.getEmail());
        assertEquals("USER", registeredUser.getRole());
        assertTrue(registeredUser.getEnabled());

        // ğŸ§ª éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userRepository).existsByUsername("testuser");
        verify(userRepository).existsByEmail("test@example.com");
        verify(userRepository).save(any(User.class));

        System.out.println("âœ… ç”¨æˆ·æ³¨å†Œæµ‹è¯•é€šè¿‡");
    }

    @Test
    public void testRegisterUserWithExistingUsername() {
        // ğŸ¯ æ¨¡æ‹Ÿç”¨æˆ·åå·²å­˜åœ¨
        when(userRepository.existsByUsername("testuser")).thenReturn(true);

        // âŒ æ‰§è¡Œæ³¨å†Œåº”è¯¥æŠ›å‡ºå¼‚å¸¸
        BusinessException exception = assertThrows(BusinessException.class, () -> {
            userService.registerUser(validRegisterRequest);
        });

        assertEquals("ç”¨æˆ·åå·²å­˜åœ¨: testuser", exception.getMessage());
        System.out.println("âœ… ç”¨æˆ·åé‡å¤æµ‹è¯•é€šè¿‡");
    }

    @Test
    public void testRegisterUserWithExistingEmail() {
        // ğŸ¯ æ¨¡æ‹Ÿé‚®ç®±å·²å­˜åœ¨
        when(userRepository.existsByUsername("testuser")).thenReturn(false);
        when(userRepository.existsByEmail("test@example.com")).thenReturn(true);

        // âŒ æ‰§è¡Œæ³¨å†Œåº”è¯¥æŠ›å‡ºå¼‚å¸¸
        BusinessException exception = assertThrows(BusinessException.class, () -> {
            userService.registerUser(validRegisterRequest);
        });

        assertEquals("é‚®ç®±å·²è¢«æ³¨å†Œ: test@example.com", exception.getMessage());
        System.out.println("âœ… é‚®ç®±é‡å¤æµ‹è¯•é€šè¿‡");
    }

    @Test
    public void testChangePasswordSuccess() {
        // ğŸ¯ åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        User testUser = new User();
        testUser.setId(1L);
        testUser.setUsername("testuser");
        testUser.setPassword("encoded_old_password");

        // ğŸ¯ æ¨¡æ‹ŸRepositoryå’Œå¯†ç ç¼–ç å™¨è¡Œä¸º
        when(userRepository.findById(1L)).thenReturn(Optional.of(testUser));
        when(passwordEncoder.matches("oldpassword", "encoded_old_password")).thenReturn(true);
        when(passwordEncoder.encode("newpassword")).thenReturn("encoded_new_password");

        // ğŸ” æ‰§è¡Œå¯†ç ä¿®æ”¹
        boolean result = userService.changePassword(1L, "oldpassword", "newpassword");

        // âœ… éªŒè¯ç»“æœ
        assertTrue(result);
        verify(passwordEncoder).matches("oldpassword", "encoded_old_password");
        verify(passwordEncoder).encode("newpassword");
        verify(userRepository).save(testUser);

        System.out.println("âœ… å¯†ç ä¿®æ”¹æµ‹è¯•é€šè¿‡");
    }

    @Test
    public void testChangePasswordWithWrongOldPassword() {
        // ğŸ¯ åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        User testUser = new User();
        testUser.setId(1L);
        testUser.setUsername("testuser");
        testUser.setPassword("encoded_old_password");

        // ğŸ¯ æ¨¡æ‹Ÿæ—§å¯†ç éªŒè¯å¤±è´¥
        when(userRepository.findById(1L)).thenReturn(Optional.of(testUser));
        when(passwordEncoder.matches("wrongpassword", "encoded_old_password")).thenReturn(false);

        // âŒ æ‰§è¡Œå¯†ç ä¿®æ”¹åº”è¯¥æŠ›å‡ºå¼‚å¸¸
        BusinessException exception = assertThrows(BusinessException.class, () -> {
            userService.changePassword(1L, "wrongpassword", "newpassword");
        });

        assertEquals("åŸå¯†ç ä¸æ­£ç¡®", exception.getMessage());
        System.out.println("âœ… åŸå¯†ç é”™è¯¯æµ‹è¯•é€šè¿‡");
    }
}
```

---

## ğŸš€ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### â“ é—®é¢˜1: ç”¨æˆ·æ³¨å†Œæ—¶æ•°æ®éªŒè¯å¤±è´¥

**é”™è¯¯**: `MethodArgumentNotValidException`

**è§£å†³æ–¹æ¡ˆ**:
```java
// âœ… åœ¨Controllerå±‚æ·»åŠ æ•°æ®éªŒè¯
@PostMapping("/register")
public ResponseEntity<?> register(@Valid @RequestBody RegisterRequest request) {
    // ä¸šåŠ¡é€»è¾‘
}

// âœ… åœ¨DTOç±»ä¸­æ·»åŠ éªŒè¯æ³¨è§£
public class RegisterRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´")
    private String username;

    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
}
```

### â“ é—®é¢˜2: å¯†ç ç¼–ç ä¸åŒ¹é…

**é”™è¯¯**: `Bad credentialsException`

**è§£å†³æ–¹æ¡ˆ**:
```java
// âœ… ç¡®ä¿åœ¨æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ç›¸åŒçš„å¯†ç ç¼–ç å™¨
@Service
public class UserServiceImpl implements UserService {
    @Autowired
    private PasswordEncoder passwordEncoder;  // ä½¿ç”¨åŒä¸€ä¸ªBean

    public User registerUser(RegisterRequest request) {
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        // ...
    }
}
```

### â“ é—®é¢˜3: äº‹åŠ¡å›æ»šé—®é¢˜

**é”™è¯¯**: å¼‚å¸¸å‘ç”Ÿåæ•°æ®æ²¡æœ‰å›æ»š

**è§£å†³æ–¹æ¡ˆ**:
```java
// âœ… æ­£ç¡®é…ç½®äº‹åŠ¡æ³¨è§£
@Service
@Transactional  // ç±»çº§åˆ«äº‹åŠ¡
public class UserServiceImpl implements UserService {

    @Transactional(rollbackFor = BusinessException.class)  // æŒ‡å®šå›æ»šå¼‚å¸¸
    public User registerUser(RegisterRequest request) {
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");  // ä¼šè§¦å‘å›æ»š
        }
        // ...
    }
}
```

---

## ğŸ“Š ç”¨æˆ·æœåŠ¡æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ğŸ” å¯†ç å®‰å…¨** - å§‹ç»ˆåŠ å¯†å­˜å‚¨å¯†ç 
2. **ğŸ“ æ•°æ®éªŒè¯** - å¤šå±‚æ¬¡éªŒè¯ç”¨æˆ·è¾“å…¥
3. **ğŸ”„ äº‹åŠ¡ç®¡ç†** - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **ğŸš¨ å¼‚å¸¸å¤„ç†** - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
5. **ğŸ§ª å•å…ƒæµ‹è¯•** - å…¨é¢æµ‹è¯•ä¸šåŠ¡é€»è¾‘

### âŒ é¿å…åšæ³•

1. **ğŸš« æ˜æ–‡å­˜å‚¨å¯†ç ** - å¿…é¡»åŠ å¯†å­˜å‚¨
2. **ğŸš« å¿½ç•¥æ•°æ®éªŒè¯** - é˜²æ­¢è„æ•°æ®
3. **ğŸš« ä¸šåŠ¡é€»è¾‘æ³„éœ²** - ä¿æŒæœåŠ¡å±‚çº¯å‡€
4. **ğŸš« è¿‡é•¿çš„æœåŠ¡æ–¹æ³•** - æ‹†åˆ†ä¸ºå°æ–¹æ³•

---

## ğŸ“ æœ¬ç« å°ç»“

### âœ… å·²æŒæ¡æŠ€èƒ½

- [ ] **å®ç°** ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
- [ ] **å¼€å‘** ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- [ ] **å¤„ç†** å¯†ç åŠ å¯†å’ŒéªŒè¯
- [ ] **æŒæ¡** äº‹åŠ¡ç®¡ç†
- [ ] **åˆ›å»º** å®Œæ•´çš„ä¸šåŠ¡æœåŠ¡

### ğŸ¯ å…³é”®è¦ç‚¹

1. **ç”¨æˆ·å®ä½“** - å®šä¹‰ç”¨æˆ·æ•°æ®æ¨¡å‹
2. **Repositoryå±‚** - æä¾›æ•°æ®è®¿é—®æ¥å£
3. **Serviceå±‚** - å®ç°ä¸šåŠ¡é€»è¾‘
4. **æ•°æ®éªŒè¯** - ç¡®ä¿æ•°æ®å®Œæ•´æ€§

### ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»æŒæ¡äº†ç”¨æˆ·ç®¡ç†æœåŠ¡ï¼Œæ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ ï¼š
- â†’ **04-è®¤è¯APIæ§åˆ¶å™¨** - å¼€å‘RESTfulè®¤è¯æ¥å£
- â†’ **05-å¼‚å¸¸å¤„ç†å’Œå®‰å…¨å¢å¼º** - å®Œå–„ç³»ç»Ÿå®‰å…¨æ€§
- â†’ **06-åŠŸèƒ½æµ‹è¯•å’ŒéªŒè¯** - éªŒè¯è®¤è¯ç³»ç»Ÿ

---

**è®°ä½ï¼šç”¨æˆ·æœåŠ¡æ˜¯è®¤è¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ï¼** ğŸ‰

---