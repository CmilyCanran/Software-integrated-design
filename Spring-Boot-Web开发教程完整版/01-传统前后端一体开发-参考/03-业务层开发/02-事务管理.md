# äº‹åŠ¡ç®¡ç†è¯¦è§£

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- ç†è§£äº‹åŠ¡çš„æ¦‚å¿µå’ŒACIDç‰¹æ€§
- æŒæ¡Springçš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†
- å­¦ä¼šäº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„ä½¿ç”¨
- äº†è§£äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œå¼‚å¸¸å¤„ç†

## ğŸ—ï¸ äº‹åŠ¡åŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ
äº‹åŠ¡æ˜¯æ•°æ®åº“æ“ä½œçš„åŸºæœ¬å•ä½ï¼Œç”±ä¸€ç³»åˆ—æ“ä½œç»„æˆï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

### ACIDç‰¹æ€§
- **åŸå­æ€§ (Atomicity)**: äº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ
- **ä¸€è‡´æ€§ (Consistency)**: äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“çš„çŠ¶æ€ä¿æŒä¸€è‡´
- **éš”ç¦»æ€§ (Isolation)**: å¹¶å‘äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°
- **æŒä¹…æ€§ (Durability)**: äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå…¶ç»“æœå°±æ˜¯æ°¸ä¹…æ€§çš„

## ğŸ“ Springäº‹åŠ¡ç®¡ç†

### 1. å£°æ˜å¼äº‹åŠ¡ç®¡ç†

#### @Transactionalæ³¨è§£
```java
@Service
public class UserServiceImpl implements UserService {

    @Transactional  // é»˜è®¤äº‹åŠ¡é…ç½®
    public void createUser(UserCreateDTO userCreateDTO) {
        // äº‹åŠ¡å†…çš„æ‰€æœ‰æ“ä½œ
        userRepository.save(user);
        emailService.sendWelcomeEmail(user.getEmail());
    }

    @Transactional(
        propagation = Propagation.REQUIRED,  // ä¼ æ’­è¡Œä¸º
        isolation = Isolation.READ_COMMITTED, // éš”ç¦»çº§åˆ«
        timeout = 30,                        // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        readOnly = false,                    // æ˜¯å¦åªè¯»
        rollbackFor = Exception.class        // å›æ»šå¼‚å¸¸
    )
    public void complexOperation() {
        // å¤æ‚çš„ä¸šåŠ¡æ“ä½œ
    }
}
```

### 2. äº‹åŠ¡ä¼ æ’­è¡Œä¸º

#### ä¼ æ’­è¡Œä¸ºç±»å‹
```java
@Service
public class TransactionService {

    // REQUIRED: å¦‚æœå­˜åœ¨äº‹åŠ¡å°±åŠ å…¥ï¼Œå¦åˆ™åˆ›å»ºæ–°äº‹åŠ¡ï¼ˆé»˜è®¤ï¼‰
    @Transactional(propagation = Propagation.REQUIRED)
    public void requiredMethod() {
        // æ–¹æ³•é€»è¾‘
    }

    // REQUIRES_NEW: æ€»æ˜¯åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void requiresNewMethod() {
        // æ€»æ˜¯åœ¨æ–°äº‹åŠ¡ä¸­æ‰§è¡Œ
    }

    // MANDATORY: å¿…é¡»åœ¨å·²æœ‰äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸
    @Transactional(propagation = Propagation.MANDATORY)
    public void mandatoryMethod() {
        // å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨
    }

    // SUPPORTS: å¦‚æœå­˜åœ¨äº‹åŠ¡å°±åŠ å…¥ï¼Œå¦åˆ™éäº‹åŠ¡æ‰§è¡Œ
    @Transactional(propagation = Propagation.SUPPORTS)
    public void supportsMethod() {
        // æ”¯æŒäº‹åŠ¡ä½†ä¸å¼ºåˆ¶
    }

    // NOT_SUPPORTED: æ€»æ˜¯éäº‹åŠ¡æ‰§è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡
    @Transactional(propagation = Propagation.NOT_SUPPORTED)
    public void notSupportedMethod() {
        // éäº‹åŠ¡æ‰§è¡Œ
    }

    // NEVER: æ€»æ˜¯éäº‹åŠ¡æ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨äº‹åŠ¡å°±æŠ›å‡ºå¼‚å¸¸
    @Transactional(propagation = Propagation.NEVER)
    public void neverMethod() {
        // ç»ä¸èƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
    }

    // NESTED: åµŒå¥—äº‹åŠ¡ï¼Œå›æ»šç‚¹æœºåˆ¶
    @Transactional(propagation = Propagation.NESTED)
    public void nestedMethod() {
        // åµŒå¥—äº‹åŠ¡æ‰§è¡Œ
    }
}
```

### 3. äº‹åŠ¡éš”ç¦»çº§åˆ«

#### éš”ç¦»çº§åˆ«è¯´æ˜
```java
@Service
public class IsolationService {

    // DEFAULT: ä½¿ç”¨æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«
    @Transactional(isolation = Isolation.DEFAULT)
    public void defaultIsolation() {
        // ä½¿ç”¨æ•°æ®åº“é»˜è®¤è®¾ç½®
    }

    // READ_UNCOMMITTED: è¯»æœªæäº¤ï¼ˆæœ€ä½éš”ç¦»çº§åˆ«ï¼‰
    @Transactional(isolation = Isolation.READ_UNCOMMITTED)
    public void readUncommitted() {
        // å¯èƒ½è¯»åˆ°è„æ•°æ®
    }

    // READ_COMMITTED: è¯»å·²æäº¤ï¼ˆé¿å…è„è¯»ï¼‰
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void readCommitted() {
        // é¿å…è„è¯»ï¼Œä½†å¯èƒ½å‡ºç°ä¸å¯é‡å¤è¯»
    }

    // REPEATABLE_READ: å¯é‡å¤è¯»ï¼ˆé¿å…è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼‰
    @Transactional(isolation = Isolation.REPEATABLE_READ)
    public void repeatableRead() {
        // MySQLé»˜è®¤éš”ç¦»çº§åˆ«
    }

    // SERIALIZABLE: ä¸²è¡ŒåŒ–ï¼ˆæœ€é«˜éš”ç¦»çº§åˆ«ï¼‰
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public void serializable() {
        // å®Œå…¨ä¸²è¡Œæ‰§è¡Œï¼Œæ€§èƒ½æœ€ä½
    }
}
```

## ğŸ”§ å®é™…åº”ç”¨ç¤ºä¾‹

### 1. ç”¨æˆ·æ³¨å†Œäº‹åŠ¡

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class UserRegistrationService {

    private final UserRepository userRepository;
    private final UserProfileRepository profileRepository;
    private final RoleRepository roleRepository;
    private final EmailService emailService;

    @Transactional(
        propagation = Propagation.REQUIRED,
        rollbackFor = {Exception.class, RuntimeException.class},
        timeout = 30
    )
    public UserDTO registerUser(UserRegistrationDTO registrationDTO) {
        log.info("å¼€å§‹ç”¨æˆ·æ³¨å†Œæµç¨‹: {}", registrationDTO.getUsername());

        try {
            // 1. åˆ›å»ºç”¨æˆ·ä¸»è®°å½•
            User user = createUserFromDTO(registrationDTO);
            User savedUser = userRepository.save(user);
            log.debug("ç”¨æˆ·ä¸»è®°å½•åˆ›å»ºæˆåŠŸ: {}", savedUser.getId());

            // 2. åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆ
            UserProfile profile = createProfileForUser(savedUser, registrationDTO);
            profileRepository.save(profile);
            log.debug("ç”¨æˆ·æ¡£æ¡ˆåˆ›å»ºæˆåŠŸ: {}", profile.getId());

            // 3. åˆ†é…é»˜è®¤è§’è‰²
            assignDefaultRole(savedUser);
            log.debug("é»˜è®¤è§’è‰²åˆ†é…æˆåŠŸ");

            // 4. å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆå¼‚æ­¥ï¼Œä¸å½±å“äº‹åŠ¡ï¼‰
            emailService.sendWelcomeEmailAsync(savedUser.getEmail());
            log.info("æ¬¢è¿é‚®ä»¶å‘é€ä»»åŠ¡å·²æäº¤");

            return userMapper.toDTO(savedUser);

        } catch (Exception e) {
            log.error("ç”¨æˆ·æ³¨å†Œå¤±è´¥: {}", registrationDTO.getUsername(), e);
            throw new UserRegistrationException("ç”¨æˆ·æ³¨å†Œå¤±è´¥: " + e.getMessage(), e);
        }
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void assignDefaultRole(User user) {
        Role userRole = roleRepository.findByName("USER")
                .orElseThrow(() -> new IllegalStateException("é»˜è®¤ç”¨æˆ·è§’è‰²ä¸å­˜åœ¨"));

        UserRole userRole = new UserRole();
        userRole.setUser(user);
        userRole.setRole(userRole);

        roleRepository.save(userRole);
    }
}
```

### 2. è®¢å•å¤„ç†äº‹åŠ¡

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class OrderProcessingService {

    private final OrderRepository orderRepository;
    private final ProductRepository productRepository;
    private final InventoryService inventoryService;
    private final PaymentService paymentService;

    @Transactional
    public OrderDTO processOrder(OrderCreateDTO orderCreateDTO) {
        log.info("å¼€å§‹å¤„ç†è®¢å•: {}", orderCreateDTO.getOrderItems());

        // 1. åˆ›å»ºè®¢å•
        Order order = createOrder(orderCreateDTO);
        Order savedOrder = orderRepository.save(order);

        try {
            // 2. æ£€æŸ¥å¹¶é”å®šåº“å­˜
            reserveInventory(order.getOrderItems());

            // 3. å¤„ç†æ”¯ä»˜
            PaymentResult paymentResult = processPayment(order);

            if (paymentResult.isSuccess()) {
                // 4. ç¡®è®¤è®¢å•çŠ¶æ€
                order.setStatus(OrderStatus.CONFIRMED);
                order.setPaymentId(paymentResult.getPaymentId());

                // 5. æ‰£å‡åº“å­˜
                deductInventory(order.getOrderItems());

            } else {
                // æ”¯ä»˜å¤±è´¥ï¼Œå–æ¶ˆè®¢å•
                order.setStatus(OrderStatus.CANCELLED);
                releaseInventory(order.getOrderItems());
            }

            orderRepository.save(order);
            return orderMapper.toDTO(order);

        } catch (Exception e) {
            // å¼‚å¸¸æ—¶è‡ªåŠ¨é‡Šæ”¾åº“å­˜
            releaseInventory(order.getOrderItems());
            throw new OrderProcessingException("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void reserveInventory(List<OrderItem> items) {
        for (OrderItem item : items) {
            inventoryService.reserveStock(item.getProductId(), item.getQuantity());
        }
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void deductInventory(List<OrderItem> items) {
        for (OrderItem item : items) {
            inventoryService.deductStock(item.getProductId(), item.getQuantity());
        }
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void releaseInventory(List<OrderItem> items) {
        for (OrderItem item : items) {
            inventoryService.releaseStock(item.getProductId(), item.getQuantity());
        }
    }
}
```

### 3. æ‰¹é‡æ“ä½œäº‹åŠ¡

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class BatchOperationService {

    private final UserRepository userRepository;
    private final AuditLogRepository auditLogRepository;

    @Transactional
    public BatchOperationResult batchUpdateUsers(List<UserUpdateDTO> updates) {
        log.info("å¼€å§‹æ‰¹é‡æ›´æ–°ç”¨æˆ·ï¼Œæ•°é‡: {}", updates.size());

        int successCount = 0;
        List<String> failures = new ArrayList<>();

        for (UserUpdateDTO update : updates) {
            try {
                updateUser(update);
                successCount++;

                // è®°å½•å®¡è®¡æ—¥å¿—
                auditLogRepository.save(createAuditLog(update, "SUCCESS"));

            } catch (Exception e) {
                failures.add(update.getId() + ": " + e.getMessage());
                log.warn("ç”¨æˆ·æ›´æ–°å¤±è´¥: {}", update.getId(), e);

                // è®°å½•å¤±è´¥æ—¥å¿—
                auditLogRepository.save(createAuditLog(update, "FAILURE"));
            }
        }

        return BatchOperationResult.builder()
                .totalCount(updates.size())
                .successCount(successCount)
                .failureCount(failures.size())
                .failures(failures)
                .build();
    }

    @Transactional(propagation = Propagation.REQUIRED)
    private void updateUser(UserUpdateDTO update) {
        User user = userRepository.findById(update.getId())
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + update.getId()));

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        userMapper.updateEntityFromDTO(update, user);
        user.setUpdatedAt(LocalDateTime.now());

        userRepository.save(user);
    }
}
```

## ğŸ”„ äº‹åŠ¡å›æ»šæœºåˆ¶

### 1. é»˜è®¤å›æ»šè§„åˆ™

```java
@Service
public class TransactionRollbackService {

    // é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰RuntimeExceptionå’ŒErrorä¼šè§¦å‘å›æ»š
    @Transactional
    public void defaultRollback() {
        // RuntimeException ä¼šå›æ»š
        throw new RuntimeException("This will rollback");

        // Error ä¼šå›æ»š
        throw new OutOfMemoryError("This will rollback");

        // æ£€æŸ¥å¼‚å¸¸ï¼ˆExceptionï¼‰é»˜è®¤ä¸ä¼šå›æ»š
        // throw new IOException("This will NOT rollback by default");
    }

    // æŒ‡å®šå›æ»šå¼‚å¸¸
    @Transactional(rollbackFor = Exception.class)
    public void customRollback() {
        // ç°åœ¨IOExceptionä¹Ÿä¼šå›æ»š
        throw new IOException("This will rollback now");
    }

    // æŒ‡å®šä¸å›æ»šå¼‚å¸¸
    @Transactional(noRollbackFor = BusinessException.class)
    public void noRollbackForSpecificException() {
        // BusinessExceptionä¸ä¼šè§¦å‘å›æ»š
        throw new BusinessException("This will NOT rollback");
    }
}
```

### 2. ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†

```java
@Service
@RequiredArgsConstructor
public class ProgrammaticTransactionService {

    private final TransactionTemplate transactionTemplate;
    private final UserRepository userRepository;

    public UserDTO createUserWithProgrammaticTransaction(UserCreateDTO userCreateDTO) {
        return transactionTemplate.execute(status -> {
            try {
                // äº‹åŠ¡å†…çš„æ“ä½œ
                User user = new User();
                user.setUsername(userCreateDTO.getUsername());
                user.setEmail(userCreateDTO.getEmail());

                User savedUser = userRepository.save(user);

                // å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®å›æ»š
                if (savedUser.getUsername().contains("test")) {
                    status.setRollbackOnly();
                    throw new BusinessException("æµ‹è¯•ç”¨æˆ·ä¸å…è®¸åˆ›å»º");
                }

                return userMapper.toDTO(savedUser);

            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
        });
    }

    public void complexTransaction() {
        // æ— è¿”å›å€¼çš„äº‹åŠ¡
        transactionTemplate.executeWithoutResult(status -> {
            // å¤æ‚çš„äº‹åŠ¡æ“ä½œ
            userRepository.updateAllUsersStatus(false);
            userRepository.updateAdminUsersStatus(true);
        });
    }
}
```

## âš™ï¸ äº‹åŠ¡é…ç½®

### 1. å…¨å±€äº‹åŠ¡é…ç½®

```java
@Configuration
@EnableTransactionManagement
public class TransactionConfig {

    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }

    @Bean
    public TransactionTemplate transactionTemplate(PlatformTransactionManager transactionManager) {
        TransactionTemplate template = new TransactionTemplate(transactionManager);

        // è®¾ç½®é»˜è®¤ä¼ æ’­è¡Œä¸º
        template.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);

        // è®¾ç½®é»˜è®¤éš”ç¦»çº§åˆ«
        template.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);

        // è®¾ç½®é»˜è®¤è¶…æ—¶æ—¶é—´
        template.setTimeout(30);

        // è®¾ç½®ä¸ºåªè¯»äº‹åŠ¡
        template.setReadOnly(false);

        return template;
    }
}
```

### 2. å¤šæ•°æ®æºäº‹åŠ¡ç®¡ç†

```java
@Configuration
public class MultiDataSourceTransactionConfig {

    @Bean("primaryTransactionManager")
    public PlatformTransactionManager primaryTransactionManager(
            @Qualifier("primaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }

    @Bean("secondaryTransactionManager")
    public PlatformTransactionManager secondaryTransactionManager(
            @Qualifier("secondaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}

@Service
public class MultiDataSourceService {

    @Transactional("primaryTransactionManager")
    public void operationOnPrimaryDB() {
        // åœ¨ä¸»æ•°æ®åº“ä¸Šçš„æ“ä½œ
    }

    @Transactional("secondaryTransactionManager")
    public void operationOnSecondaryDB() {
        // åœ¨ä»æ•°æ®åº“ä¸Šçš„æ“ä½œ
    }

    // è·¨æ•°æ®æºäº‹åŠ¡éœ€è¦ä½¿ç”¨JTAæˆ–åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨
}
```

## ğŸ¯ äº‹åŠ¡æœ€ä½³å®è·µ

### 1. äº‹åŠ¡ç²’åº¦æ§åˆ¶
```java
@Service
public class TransactionBestPracticeService {

    // âœ… å¥½çš„åšæ³•ï¼šäº‹åŠ¡èŒƒå›´å°½å¯èƒ½å°
    @Transactional
    public void updateUserName(Long userId, String newName) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
        user.setFullName(newName);
        userRepository.save(user);
    }

    // âŒ é¿å…çš„åšæ³•ï¼šäº‹åŠ¡èŒƒå›´è¿‡å¤§
    @Transactional
    public void complexLongRunningOperation() {
        // æŸ¥è¯¢æ“ä½œï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰
        List<User> users = userRepository.findAll();

        // å¤–éƒ¨APIè°ƒç”¨ï¼ˆå¯èƒ½è¶…æ—¶ï¼‰
        externalService.syncUsers(users);

        // å¤§é‡è®¡ç®—
        complexCalculation(users);

        // æ•°æ®åº“æ›´æ–°
        userRepository.saveAll(users);
    }

    // âœ… å¥½çš„åšæ³•ï¼šåˆ†ç¦»æŸ¥è¯¢å’Œæ›´æ–°
    @Transactional(readOnly = true)
    public List<User> getUsersForProcessing() {
        return userRepository.findAll();
    }

    @Transactional
    public void updateProcessedUsers(List<User> users) {
        userRepository.saveAll(users);
    }
}
```

### 2. å¼‚å¸¸å¤„ç†ç­–ç•¥
```java
@Service
public class TransactionExceptionHandlingService {

    @Transactional
    public void operationWithCustomException() {
        try {
            // ä¸šåŠ¡æ“ä½œ
            performBusinessOperation();
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œä¸å›æ»šäº‹åŠ¡
            log.warn("ä¸šåŠ¡æ“ä½œå¤±è´¥: {}", e.getMessage());
            throw e; // é‡æ–°æŠ›å‡ºï¼Œä½†ä¸ä¼šå›æ»š
        } catch (RuntimeException e) {
            // è¿è¡Œæ—¶å¼‚å¸¸ï¼Œä¼šå›æ»šäº‹åŠ¡
            log.error("ç³»ç»Ÿé”™è¯¯ï¼Œäº‹åŠ¡å°†å›æ»š", e);
            throw e;
        }
    }

    @Transactional(rollbackFor = {BusinessException.class, SystemException.class})
    public void operationWithSpecificRollback() {
        // æŒ‡å®šçš„å¼‚å¸¸éƒ½ä¼šè§¦å‘å›æ»š
    }
}
```

### 3. åªè¯»äº‹åŠ¡ä¼˜åŒ–
```java
@Service
public class ReadOnlyTransactionService {

    // âœ… æŸ¥è¯¢æ“ä½œä½¿ç”¨åªè¯»äº‹åŠ¡
    @Transactional(readOnly = true)
    public List<UserDTO> getAllUsers() {
        return userRepository.findAll().stream()
                .map(userMapper::toDTO)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public UserDTO getUserById(Long id) {
        return userRepository.findById(id)
                .map(userMapper::toDTO)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
    }

    @Transactional(readOnly = true)
    public Page<UserDTO> searchUsers(UserSearchCriteria criteria, Pageable pageable) {
        return userRepository.findAll(pageable)
                .map(userMapper::toDTO);
    }
}
```

## ğŸ“Š äº‹åŠ¡ç›‘æ§å’Œè°ƒè¯•

### 1. äº‹åŠ¡æ—¥å¿—é…ç½®

```properties
# application.properties
# å¯ç”¨Springäº‹åŠ¡æ—¥å¿—
logging.level.org.springframework.transaction=DEBUG
logging.level.org.springframework.orm.jpa=DEBUG
logging.level.org.hibernate.transaction=DEBUG

# æ˜¾ç¤ºæ‰§è¡Œçš„SQL
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

### 2. äº‹åŠ¡æ€§èƒ½ç›‘æ§

```java
@Aspect
@Component
@Slf4j
public class TransactionMonitorAspect {

    @Around("@annotation(org.springframework.transaction.annotation.Transactional)")
    public Object monitorTransaction(ProceedingJoinPoint joinPoint) throws Throwable {
        String methodName = joinPoint.getSignature().toShortString();

        long startTime = System.currentTimeMillis();
        log.info("äº‹åŠ¡å¼€å§‹: {}", methodName);

        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;

            log.info("äº‹åŠ¡æˆåŠŸå®Œæˆ: {}, è€—æ—¶: {}ms", methodName, duration);

            if (duration > 5000) { // è¶…è¿‡5ç§’çš„äº‹åŠ¡
                log.warn("æ…¢äº‹åŠ¡è­¦å‘Š: {}, è€—æ—¶: {}ms", methodName, duration);
            }

            return result;

        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("äº‹åŠ¡å›æ»š: {}, è€—æ—¶: {}ms, é”™è¯¯: {}", methodName, duration, e.getMessage());
            throw e;
        }
    }
}
```

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ç†è§£äº‹åŠ¡çš„ACIDç‰¹æ€§
- [ ] æŒæ¡Springå£°æ˜å¼äº‹åŠ¡ç®¡ç†
- [ ] ç†è§£äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„ä½¿ç”¨åœºæ™¯
- [ ] äº†è§£äº‹åŠ¡éš”ç¦»çº§åˆ«çš„é€‰æ‹©
- [ ] æŒæ¡äº‹åŠ¡å›æ»šæœºåˆ¶
- [ ] äº†è§£äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–æ–¹æ³•

## ğŸš€ ä¸‹ä¸€æ­¥

äº‹åŠ¡ç®¡ç†å­¦ä¹ å®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š
[DTOè®¾è®¡æ¨¡å¼](03-DTOè®¾è®¡.md)

---

**æç¤º**: åˆç†ä½¿ç”¨äº‹åŠ¡æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„å…³é”®ï¼Œä½†è¦é¿å…è¿‡åº¦ä½¿ç”¨äº‹åŠ¡å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚