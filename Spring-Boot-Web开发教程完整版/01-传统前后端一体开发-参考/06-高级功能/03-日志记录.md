# æ—¥å¿—è®°å½•è¯¦è§£

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- ç†è§£æ—¥å¿—çš„é‡è¦æ€§å’Œçº§åˆ«
- æŒæ¡Logbacké…ç½®å’Œä½¿ç”¨
- å­¦ä¼šç»“æ„åŒ–æ—¥å¿—è®°å½•
- äº†è§£æ—¥å¿—ç›‘æ§å’Œåˆ†æ

## ğŸ—ï¸ æ—¥å¿—åŸºç¡€æ¦‚å¿µ

### æ—¥å¿—çš„é‡è¦æ€§
- **é—®é¢˜è¯Šæ–­**: å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜
- **æ€§èƒ½ç›‘æ§**: åˆ†æç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ
- **å®‰å…¨å®¡è®¡**: è®°å½•å…³é”®æ“ä½œå’Œè®¿é—®
- **ä¸šåŠ¡åˆ†æ**: æä¾›ä¸šåŠ¡æ•°æ®æ”¯æŒ
- **åˆè§„è¦æ±‚**: æ»¡è¶³æ³•è§„å’Œå®¡è®¡è¦æ±‚

### æ—¥å¿—çº§åˆ«
- **ERROR**: é”™è¯¯äº‹ä»¶ï¼Œå¯èƒ½å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- **WARN**: è­¦å‘Šä¿¡æ¯ï¼Œæ½œåœ¨çš„é—®é¢˜
- **INFO**: é‡è¦çš„ä¿¡æ¯æµï¼Œç³»ç»Ÿæ­£å¸¸è¿è¡Œçš„å…³é”®æ­¥éª¤
- **DEBUG**: è°ƒè¯•ä¿¡æ¯ï¼Œè¯¦ç»†çš„æ‰§è¡Œæµç¨‹
- **TRACE**: æœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œé€šå¸¸åªåœ¨å¼€å‘æ—¶ä½¿ç”¨

## ğŸ“ Logbacké…ç½®

### 1. åŸºç¡€Logbacké…ç½®

```xml
<!-- src/main/resources/logback-spring.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- å®šä¹‰å˜é‡ -->
    <property name="LOG_PATH" value="logs"/>
    <property name="LOG_FILE" value="springweb"/>
    <property name="MAX_FILE_SIZE" value="10MB"/>
    <property name="MAX_HISTORY" value="30"/>
    <property name="TOTAL_SIZE_CAP" value="1GB"/>

    <!-- å½©è‰²æ—¥å¿—è¾“å‡ºæ ¼å¼ -->
    <property name="CONSOLE_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%yellow(%thread)] %cyan(%logger{36}) - %msg%n"/>

    <!-- æ–‡ä»¶æ—¥å¿—è¾“å‡ºæ ¼å¼ -->
    <property name="FILE_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n"/>

    <!-- ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰ -->
    <property name="JSON_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n"/>

    <!-- æ§åˆ¶å°è¾“å‡º -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- æ–‡ä»¶è¾“å‡º -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}.log</file>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
            <cleanHistoryOnStart>true</cleanHistoryOnStart>
        </rollingPolicy>
    </appender>

    <!-- é”™è¯¯æ—¥å¿—å•ç‹¬è®°å½• -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}-error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}-error.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- å¼‚æ­¥æ—¥å¿—è¾“å‡º -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <discardingThreshold>0</discardingThreshold>
        <queueSize>256</queueSize>
        <includeCallerData>true</includeCallerData>
        <appender-ref ref="FILE"/>
    </appender>

    <!-- JSONæ ¼å¼æ—¥å¿—è¾“å‡º -->
    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}-json.log</file>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <timeZone>Asia/Shanghai</timeZone>
            <includeCallerData>true</includeCallerData>
            <customFields>{"application":"springweb","environment":"${spring.profiles.active:-default}"}</customFields>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}-json.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- ç‰¹å®šåŒ…çš„æ—¥å¿—çº§åˆ«é…ç½® -->
    <logger name="com.cmliy.springweb" level="INFO" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
        <appender-ref ref="JSON_FILE"/>
    </logger>

    <logger name="com.cmliy.springweb.controller" level="DEBUG"/>
    <logger name="com.cmliy.springweb.service" level="INFO"/>
    <logger name="com.cmliy.springweb.repository" level="DEBUG"/>

    <!-- Springæ¡†æ¶æ—¥å¿—çº§åˆ« -->
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.springframework.security" level="INFO"/>
    <logger name="org.springframework.transaction" level="INFO"/>

    <!-- æ•°æ®åº“ç›¸å…³æ—¥å¿— -->
    <logger name="org.hibernate.SQL" level="DEBUG"/>
    <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>
    <logger name="com.zaxxer.hikari" level="INFO"/>

    <!-- æ ¹æ—¥å¿—çº§åˆ« -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
        <appender-ref ref="ERROR_FILE"/>
    </root>

    <!-- å¼€å‘ç¯å¢ƒé…ç½® -->
    <springProfile name="dev">
        <logger name="com.cmliy.springweb" level="DEBUG"/>
        <logger name="org.springframework.web" level="DEBUG"/>
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- ç”Ÿäº§ç¯å¢ƒé…ç½® -->
    <springProfile name="prod">
        <logger name="com.cmliy.springweb" level="INFO"/>
        <logger name="org.springframework.web" level="WARN"/>
        <logger name="org.hibernate.SQL" level="WARN"/>
        <root level="INFO">
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ERROR_FILE"/>
            <appender-ref ref="JSON_FILE"/>
        </root>
    </springProfile>
</configuration>
```

## ğŸ¨ ç»“æ„åŒ–æ—¥å¿—è®°å½•

### 1. æ—¥å¿—å·¥å…·ç±»

```java
package com.cmliy.springweb.util;

import lombok.extern.slf4j.Slf4j;
import org.slf4j.MDC;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;
import java.util.UUID;

/**
 * æ—¥å¿—å·¥å…·ç±»
 */
@Slf4j
@Component
public class LogUtils {

    private static final String REQUEST_ID = "requestId";
    private static final String USER_ID = "userId";
    private static final String CLIENT_IP = "clientIp";
    private static final String USER_AGENT = "userAgent";

    /**
     * åˆå§‹åŒ–è¯·æ±‚æ—¥å¿—ä¸Šä¸‹æ–‡
     */
    public static void initializeLogContext() {
        // ç”Ÿæˆè¯·æ±‚ID
        String requestId = UUID.randomUUID().toString().replace("-", "");
        MDC.put(REQUEST_ID, requestId);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication != null && authentication.isAuthenticated()) {
            String username = authentication.getName();
            MDC.put(USER_ID, username);
        }

        // è·å–è¯·æ±‚ä¿¡æ¯
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes != null) {
            HttpServletRequest request = attributes.getRequest();
            MDC.put(CLIENT_IP, getClientIP(request));
            MDC.put(USER_AGENT, request.getHeader("User-Agent"));
        }
    }

    /**
     * æ¸…ç†æ—¥å¿—ä¸Šä¸‹æ–‡
     */
    public static void clearLogContext() {
        MDC.clear();
    }

    /**
     * è®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—
     */
    public static void logUserAction(String action, String details) {
        log.info("ç”¨æˆ·æ“ä½œ: action={}, details={}", action, details);
    }

    /**
     * è®°å½•ä¸šåŠ¡æ“ä½œæ—¥å¿—
     */
    public static void logBusinessOperation(String operation, Object... params) {
        log.info("ä¸šåŠ¡æ“ä½œ: operation={}, params={}", operation, params);
    }

    /**
     * è®°å½•ç³»ç»Ÿæ€§èƒ½æ—¥å¿—
     */
    public static void logPerformance(String operation, long duration) {
        log.info("æ€§èƒ½ç›‘æ§: operation={}, duration={}ms", operation, duration);
    }

    /**
     * è®°å½•å®‰å…¨ç›¸å…³æ—¥å¿—
     */
    public static void logSecurity(String event, String details, String level) {
        switch (level.toLowerCase()) {
            case "error":
                log.error("å®‰å…¨äº‹ä»¶: event={}, details={}", event, details);
                break;
            case "warn":
                log.warn("å®‰å…¨äº‹ä»¶: event={}, details={}", event, details);
                break;
            default:
                log.info("å®‰å…¨äº‹ä»¶: event={}, details={}", event, details);
        }
    }

    /**
     * è®°å½•æ•°æ®å˜æ›´æ—¥å¿—
     */
    public static void logDataChange(String entity, String operation, String id, Object changes) {
        log.info("æ•°æ®å˜æ›´: entity={}, operation={}, id={}, changes={}", entity, operation, id, changes);
    }

    /**
     * è®°å½•å¼‚å¸¸æ—¥å¿—ï¼ˆå¸¦ä¸Šä¸‹æ–‡ï¼‰
     */
    public static void logException(String operation, Exception e) {
        log.error("å¼‚å¸¸è®°å½•: operation={}, exception={}, message={}",
                  operation, e.getClass().getSimpleName(), e.getMessage(), e);
    }

    /**
     * è·å–å®¢æˆ·ç«¯IPåœ°å€
     */
    private static String getClientIP(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty() && !"unknown".equalsIgnoreCase(xForwardedFor)) {
            return xForwardedFor.split(",")[0].trim();
        }

        String xRealIP = request.getHeader("X-Real-IP");
        if (xRealIP != null && !xRealIP.isEmpty() && !"unknown".equalsIgnoreCase(xRealIP)) {
            return xRealIP;
        }

        return request.getRemoteAddr();
    }
}
```

### 2. æ—¥å¿—åˆ‡é¢

```java
package com.cmliy.springweb.aspect;

import com.cmliy.springweb.util.LogUtils;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.stereotype.Component;

/**
 * æ—¥å¿—åˆ‡é¢
 */
@Slf4j
@Aspect
@Component
public class LoggingAspect {

    /**
     * Controllerå±‚åˆ‡ç‚¹
     */
    @Pointcut("execution(* com.cmliy.springweb.controller..*.*(..))")
    public void controllerPointcut() {}

    /**
     * Serviceå±‚åˆ‡ç‚¹
     */
    @Pointcut("execution(* com.cmliy.springweb.service..*.*(..))")
    public void servicePointcut() {}

    /**
     * Repositoryå±‚åˆ‡ç‚¹
     */
    @Pointcut("execution(* com.cmliy.springweb.repository..*.*(..))")
    public void repositoryPointcut() {}

    /**
     * è®°å½•Controlleræ–¹æ³•æ‰§è¡Œæ—¥å¿—
     */
    @Around("controllerPointcut()")
    public Object logController(ProceedingJoinPoint joinPoint) throws Throwable {
        String className = joinPoint.getTarget().getClass().getSimpleName();
        String methodName = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();

        long startTime = System.currentTimeMillis();

        log.info("Controllerå¼€å§‹æ‰§è¡Œ: {}.{}", className, methodName);

        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;

            log.info("Controlleræ‰§è¡Œå®Œæˆ: {}.{}, è€—æ—¶={}ms", className, methodName, duration);
            return result;

        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("Controlleræ‰§è¡Œå¼‚å¸¸: {}.{}, è€—æ—¶={}ms, å¼‚å¸¸={}",
                     className, methodName, duration, e.getClass().getSimpleName(), e);
            throw e;
        }
    }

    /**
     * è®°å½•Serviceæ–¹æ³•æ‰§è¡Œæ—¥å¿—
     */
    @Around("servicePointcut()")
    public Object logService(ProceedingJoinPoint joinPoint) throws Throwable {
        String className = joinPoint.getTarget().getClass().getSimpleName();
        String methodName = joinPoint.getSignature().getName();

        long startTime = System.currentTimeMillis();

        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;

            if (duration > 1000) { // è¶…è¿‡1ç§’çš„æ“ä½œè®°å½•è­¦å‘Š
                log.warn("Serviceæ‰§è¡Œè€—æ—¶è¾ƒé•¿: {}.{}, è€—æ—¶={}ms", className, methodName, duration);
            } else {
                log.debug("Serviceæ‰§è¡Œå®Œæˆ: {}.{}, è€—æ—¶={}ms", className, methodName, duration);
            }

            return result;

        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("Serviceæ‰§è¡Œå¼‚å¸¸: {}.{}, è€—æ—¶={}ms", className, methodName, duration, e);
            throw e;
        }
    }

    /**
     * è®°å½•Repositoryæ–¹æ³•æ‰§è¡Œæ—¥å¿—
     */
    @Around("repositoryPointcut()")
    public Object logRepository(ProceedingJoinPoint joinPoint) throws Throwable {
        String className = joinPoint.getTarget().getClass().getSimpleName();
        String methodName = joinPoint.getSignature().getName();

        long startTime = System.currentTimeMillis();

        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;

            log.debug("Repositoryæ‰§è¡Œå®Œæˆ: {}.{}, è€—æ—¶={}ms", className, methodName, duration);
            return result;

        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("Repositoryæ‰§è¡Œå¼‚å¸¸: {}.{}, è€—æ—¶={}ms", className, methodName, duration, e);
            throw e;
        }
    }
}
```

### 3. æ“ä½œæ—¥å¿—è®°å½•

```java
package com.cmliy.springweb.service;

import com.cmliy.springweb.entity.OperationLog;
import com.cmliy.springweb.repository.OperationLogRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import jakarta.servlet.http.HttpServletRequest;
import java.time.LocalDateTime;

/**
 * æ“ä½œæ—¥å¿—æœåŠ¡
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class OperationLogService {

    private final OperationLogRepository operationLogRepository;

    /**
     * å¼‚æ­¥è®°å½•æ“ä½œæ—¥å¿—
     */
    @Async
    public void logOperation(OperationLog log) {
        try {
            operationLogRepository.save(log);
        } catch (Exception e) {
            log.error("ä¿å­˜æ“ä½œæ—¥å¿—å¤±è´¥", e);
        }
    }

    /**
     * è®°å½•ç”¨æˆ·æ“ä½œ
     */
    @Async
    public void logUserOperation(String username, String operation, String resource,
                                String description, HttpServletRequest request) {
        OperationLog log = OperationLog.builder()
                .username(username)
                .operationType(operation)
                .resourceType(resource)
                .description(description)
                .ipAddress(getClientIP(request))
                .userAgent(request.getHeader("User-Agent"))
                .requestMethod(request.getMethod())
                .requestUrl(request.getRequestURL().toString())
                .responseStatus(200)
                .executionTime(0L)
                .createdAt(LocalDateTime.now())
                .build();

        logOperation(log);
    }

    /**
     * è®°å½•APIè°ƒç”¨
     */
    @Async
    public void logApiCall(String username, String method, String url, String params,
                          int status, long duration, HttpServletRequest request) {
        OperationLog log = OperationLog.builder()
                .username(username)
                .operationType("API_CALL")
                .resourceType("API")
                .description(String.format("%s %s", method, url))
                .ipAddress(getClientIP(request))
                .userAgent(request.getHeader("User-Agent"))
                .requestMethod(method)
                .requestUrl(url)
                .responseStatus(status)
                .executionTime(duration)
                .createdAt(LocalDateTime.now())
                .build();

        logOperation(log);
    }

    /**
     * è®°å½•æ•°æ®å˜æ›´
     */
    @Async
    public void logDataChange(String username, String operation, String entity,
                             String entityId, String changes, HttpServletRequest request) {
        OperationLog log = OperationLog.builder()
                .username(username)
                .operationType("DATA_CHANGE")
                .resourceType(entity)
                .resourceId(entityId)
                .description(String.format("%s %s: %s", operation, entity, changes))
                .ipAddress(getClientIP(request))
                .userAgent(request.getHeader("User-Agent"))
                .requestMethod(request.getMethod())
                .requestUrl(request.getRequestURL().toString())
                .responseStatus(200)
                .executionTime(0L)
                .createdAt(LocalDateTime.now())
                .build();

        logOperation(log);
    }

    /**
     * è®°å½•å®‰å…¨äº‹ä»¶
     */
    @Async
    public void logSecurityEvent(String username, String event, String details,
                                 String level, HttpServletRequest request) {
        OperationLog log = OperationLog.builder()
                .username(username)
                .operationType("SECURITY_EVENT")
                .resourceType("SECURITY")
                .description(String.format("%s: %s", event, details))
                .ipAddress(getClientIP(request))
                .userAgent(request.getHeader("User-Agent"))
                .requestMethod(request.getMethod())
                .requestUrl(request.getRequestURL().toString())
                .responseStatus(200)
                .executionTime(0L)
                .createdAt(LocalDateTime.now())
                .build();

        logOperation(log);
    }

    private String getClientIP(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }
        return request.getRemoteAddr();
    }
}
```

## ğŸ”§ æ—¥å¿—ç›‘æ§å’Œåˆ†æ

### 1. æ—¥å¿—ç›‘æ§é…ç½®

```java
package com.cmliy.springweb.monitor;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.concurrent.atomic.AtomicLong;

/**
 * æ—¥å¿—ç›‘æ§ç»„ä»¶
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class LogMonitor {

    private final MeterRegistry meterRegistry;

    // æ—¥å¿—çº§åˆ«è®¡æ•°å™¨
    private final Counter errorCounter;
    private final Counter warnCounter;
    private final Counter infoCounter;
    private final Counter debugCounter;

    // å¼‚å¸¸è®¡æ•°å™¨
    private final Counter exceptionCounter;

    // æ€§èƒ½è®¡æ—¶å™¨
    private final Timer performanceTimer;

    // æ…¢æŸ¥è¯¢è®¡æ•°å™¨
    private final AtomicLong slowQueryCount = new AtomicLong(0);

    public LogMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;

        this.errorCounter = Counter.builder("logs.error.total")
                .description("Total error logs")
                .register(meterRegistry);

        this.warnCounter = Counter.builder("logs.warn.total")
                .description("Total warning logs")
                .register(meterRegistry);

        this.infoCounter = Counter.builder("logs.info.total")
                .description("Total info logs")
                .register(meterRegistry);

        this.debugCounter = Counter.builder("logs.debug.total")
                .description("Total debug logs")
                .register(meterRegistry);

        this.exceptionCounter = Counter.builder("exceptions.total")
                .description("Total exceptions")
                .register(meterRegistry);

        this.performanceTimer = Timer.builder("operation.duration")
                .description("Operation duration")
                .register(meterRegistry);
    }

    /**
     * è®°å½•é”™è¯¯æ—¥å¿—
     */
    public void logError(String message, Throwable throwable) {
        errorCounter.increment();
        exceptionCounter.increment();
        log.error(message, throwable);
    }

    /**
     * è®°å½•è­¦å‘Šæ—¥å¿—
     */
    public void logWarn(String message) {
        warnCounter.increment();
        log.warn(message);
    }

    /**
     * è®°å½•ä¿¡æ¯æ—¥å¿—
     */
    public void logInfo(String message) {
        infoCounter.increment();
        log.info(message);
    }

    /**
     * è®°å½•è°ƒè¯•æ—¥å¿—
     */
    public void logDebug(String message) {
        debugCounter.increment();
        log.debug(message);
    }

    /**
     * è®°å½•æ“ä½œæ€§èƒ½
     */
    public void recordPerformance(String operation, long duration) {
        performanceTimer.record(duration, java.util.concurrent.TimeUnit.MILLISECONDS);

        if (duration > 1000) { // è¶…è¿‡1ç§’çš„æ“ä½œ
            slowQueryCount.incrementAndGet();
            log.warn("æ…¢æ“ä½œæ£€æµ‹: operation={}, duration={}ms", operation, duration);
        }
    }

    /**
     * è®°å½•æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
     */
    public void recordQueryPerformance(String query, long duration) {
        recordPerformance("DB_QUERY", duration);

        if (duration > 500) { // è¶…è¿‡500msçš„æŸ¥è¯¢
            log.warn("æ…¢æŸ¥è¯¢æ£€æµ‹: query={}, duration={}ms", query, duration);
        }
    }
}
```

### 2. æ—¥å¿—åˆ†ææœåŠ¡

```java
package com.cmliy.springweb.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * æ—¥å¿—åˆ†ææœåŠ¡
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class LogAnalysisService {

    private final JdbcTemplate jdbcTemplate;

    /**
     * è·å–é”™è¯¯æ—¥å¿—ç»Ÿè®¡
     */
    public Map<String, Object> getErrorLogStats(LocalDateTime startTime, LocalDateTime endTime) {
        String sql = """
            SELECT
                COUNT(*) as total_errors,
                COUNT(DISTINCT username) as affected_users,
                COUNT(DISTINCT ip_address) as unique_ips,
                operation_type,
                COUNT(*) as error_count
            FROM operation_logs
            WHERE created_at BETWEEN ? AND ?
            AND response_status >= 400
            GROUP BY operation_type
            ORDER BY error_count DESC
            LIMIT 10
            """;

        List<Map<String, Object>> results = jdbcTemplate.queryForList(sql, startTime, endTime);

        Map<String, Object> stats = new HashMap<>();
        stats.put("errorDetails", results);
        stats.put("totalErrors", results.stream().mapToLong(row -> (Long) row.get("total_errors")).sum());
        stats.put("affectedUsers", results.stream().mapToLong(row -> (Long) row.get("affected_users")).max().orElse(0L));
        stats.put("uniqueIPs", results.stream().mapToLong(row -> (Long) row.get("unique_ips")).max().orElse(0L));

        return stats;
    }

    /**
     * è·å–ç”¨æˆ·æ´»åŠ¨ç»Ÿè®¡
     */
    public Map<String, Object> getUserActivityStats(LocalDateTime startTime, LocalDateTime endTime) {
        String sql = """
            SELECT
                username,
                COUNT(*) as operation_count,
                COUNT(DISTINCT DATE(created_at)) as active_days,
                MAX(created_at) as last_activity
            FROM operation_logs
            WHERE created_at BETWEEN ? AND ?
            AND username IS NOT NULL
            GROUP BY username
            ORDER BY operation_count DESC
            LIMIT 20
            """;

        List<Map<String, Object>> results = jdbcTemplate.queryForList(sql, startTime, endTime);

        Map<String, Object> stats = new HashMap<>();
        stats.put("topUsers", results);
        stats.put("totalUsers", results.size());

        return stats;
    }

    /**
     * è·å–APIæ€§èƒ½ç»Ÿè®¡
     */
    public Map<String, Object> getApiPerformanceStats(LocalDateTime startTime, LocalDateTime endTime) {
        String sql = """
            SELECT
                request_url,
                request_method,
                COUNT(*) as request_count,
                AVG(execution_time) as avg_duration,
                MAX(execution_time) as max_duration,
                MIN(execution_time) as min_duration,
                COUNT(CASE WHEN response_status >= 400 THEN 1 END) as error_count
            FROM operation_logs
            WHERE created_at BETWEEN ? AND ?
            AND operation_type = 'API_CALL'
            GROUP BY request_url, request_method
            HAVING COUNT(*) > 10
            ORDER BY avg_duration DESC
            LIMIT 20
            """;

        List<Map<String, Object>> results = jdbcTemplate.queryForList(sql, startTime, endTime);

        Map<String, Object> stats = new HashMap<>();
        stats.put("apiPerformance", results);

        return stats;
    }

    /**
     * è·å–å®‰å…¨äº‹ä»¶ç»Ÿè®¡
     */
    public Map<String, Object> getSecurityEventStats(LocalDateTime startTime, LocalDateTime endTime) {
        String sql = """
            SELECT
                description,
                COUNT(*) as event_count,
                COUNT(DISTINCT ip_address) as unique_ips,
                COUNT(DISTINCT username) as affected_users
            FROM operation_logs
            WHERE created_at BETWEEN ? AND ?
            AND operation_type = 'SECURITY_EVENT'
            GROUP BY description
            ORDER BY event_count DESC
            LIMIT 10
            """;

        List<Map<String, Object>> results = jdbcTemplate.queryForList(sql, startTime, endTime);

        Map<String, Object> stats = new HashMap<>();
        stats.put("securityEvents", results);

        return stats;
    }

    /**
     * ç”Ÿæˆæ—¥å¿—æŠ¥å‘Š
     */
    public Map<String, Object> generateLogReport(LocalDateTime startTime, LocalDateTime endTime) {
        Map<String, Object> report = new HashMap<>();
        report.put("period", Map.of("startTime", startTime, "endTime", endTime));
        report.put("errorStats", getErrorLogStats(startTime, endTime));
        report.put("userActivityStats", getUserActivityStats(startTime, endTime));
        report.put("apiPerformanceStats", getApiPerformanceStats(startTime, endTime));
        report.put("securityEventStats", getSecurityEventStats(startTime, endTime));

        return report;
    }
}
```

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] é…ç½®Logbackæ—¥å¿—æ¡†æ¶
- [ ] å®ç°ç»“æ„åŒ–æ—¥å¿—è®°å½•
- [ ] åˆ›å»ºæ—¥å¿—åˆ‡é¢å’Œå·¥å…·ç±»
- [ ] ç›‘æ§å’Œåˆ†ææ—¥å¿—æ•°æ®
- [ ] ä¼˜åŒ–æ—¥å¿—æ€§èƒ½

## ğŸ‰ æ•™ç¨‹æ€»ç»“

æ­å–œæ‚¨å®Œæˆäº†Spring Boot Webå¼€å‘çš„å®Œæ•´å­¦ä¹ ï¼ç°åœ¨æ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [x] é…ç½®Spring Booté¡¹ç›®åŸºç¡€ç¯å¢ƒ
- [x] è®¾è®¡å’Œå®ç°æ•°æ®å±‚ï¼ˆEntityã€Repositoryï¼‰
- [x] å¼€å‘ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆServiceã€DTOã€äº‹åŠ¡ç®¡ç†ï¼‰
- [x] åˆ›å»ºæ§åˆ¶å±‚ï¼ˆControllerã€RESTful APIã€è¡¨å•å¤„ç†ï¼‰
- [x] å¼€å‘å‰ç«¯é¡µé¢ï¼ˆThymeleafã€å“åº”å¼å¸ƒå±€ã€äº¤äº’åŠŸèƒ½ï¼‰
- [x] å®ç°é«˜çº§åŠŸèƒ½ï¼ˆå¼‚å¸¸å¤„ç†ã€æ•°æ®éªŒè¯ã€æ—¥å¿—è®°å½•ï¼‰

## ğŸš€ åç»­å­¦ä¹ å»ºè®®

1. **æ·±å…¥Springç”Ÿæ€**: å­¦ä¹ Spring Cloudã€Spring Securityç­‰
2. **æ•°æ®åº“ä¼˜åŒ–**: å­¦ä¹ ç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢ä¼˜åŒ–ã€è¿æ¥æ± é…ç½®
3. **æ€§èƒ½è°ƒä¼˜**: JVMè°ƒä¼˜ã€ç¼“å­˜ç­–ç•¥ã€å¼‚æ­¥å¤„ç†
4. **å®¹å™¨åŒ–éƒ¨ç½²**: Dockerã€Kubernetes
5. **CI/CDæµæ°´çº¿**: Jenkinsã€GitLab CI
6. **å¾®æœåŠ¡æ¶æ„**: æœåŠ¡æ‹†åˆ†ã€æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡

---

**æç¤º**: æ—¥å¿—è®°å½•æ˜¯ç³»ç»Ÿè¿ç»´çš„é‡è¦å·¥å…·ï¼Œåˆç†é…ç½®å’Œä½¿ç”¨æ—¥å¿—èƒ½å¤Ÿå¤§å¤§æé«˜é—®é¢˜è¯Šæ–­å’Œç³»ç»Ÿç›‘æ§çš„æ•ˆç‡ã€‚