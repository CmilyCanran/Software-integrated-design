# æ•°æ®éªŒè¯è¯¦è§£

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- æŒæ¡Bean Validationçš„ä½¿ç”¨
- å­¦ä¼šè‡ªå®šä¹‰éªŒè¯æ³¨è§£
- äº†è§£éªŒè¯åˆ†ç»„å’Œåºåˆ—
- å®ç°å¤æ‚éªŒè¯é€»è¾‘

## ğŸ—ï¸ æ•°æ®éªŒè¯åŸºç¡€æ¦‚å¿µ

### éªŒè¯çš„é‡è¦æ€§
- **æ•°æ®å®Œæ•´æ€§**: ç¡®ä¿è¾“å…¥æ•°æ®çš„å‡†ç¡®æ€§
- **ä¸šåŠ¡è§„åˆ™**: å¼ºåˆ¶æ‰§è¡Œä¸šåŠ¡çº¦æŸ
- **å®‰å…¨æ€§**: é˜²æ­¢æ¶æ„è¾“å…¥
- **ç”¨æˆ·ä½“éªŒ**: æä¾›å³æ—¶çš„é”™è¯¯åé¦ˆ

### Spring BootéªŒè¯æœºåˆ¶
- **JSR-380/Bean Validation 2.0**: Javaæ ‡å‡†éªŒè¯è§„èŒƒ
- **Spring Validation**: Springå¯¹éªŒè¯è§„èŒƒçš„é›†æˆ
- **è‡ªåŠ¨éªŒè¯**: Controllerå±‚è‡ªåŠ¨éªŒè¯è¯·æ±‚å‚æ•°
- **æ‰‹åŠ¨éªŒè¯**: Serviceå±‚æ‰‹åŠ¨è§¦å‘éªŒè¯

## ğŸ“ åŸºç¡€éªŒè¯æ³¨è§£

### 1. å¸¸ç”¨éªŒè¯æ³¨è§£

```java
package com.cmliy.springweb.dto;

import jakarta.validation.constraints.*;
import lombok.Data;

import java.time.LocalDate;
import java.time.Past;

/**
 * ç”¨æˆ·åˆ›å»ºDTO - å®Œæ•´éªŒè¯ç¤ºä¾‹
 */
@Data
public class UserCreateDTO {

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 8, max = 128, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨8-128ä¹‹é—´")
    @Pattern(regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]",
             message = "å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦")
    private String password;

    @NotBlank(message = "ç¡®è®¤å¯†ç ä¸èƒ½ä¸ºç©º")
    private String confirmPassword;

    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®", regexp = "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$")
    @Size(max = 100, message = "é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡100")
    private String email;

    @Size(max = 100, message = "å…¨åé•¿åº¦ä¸èƒ½è¶…è¿‡100")
    private String fullName;

    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    private String phoneNumber;

    @Past(message = "å‡ºç”Ÿæ—¥æœŸå¿…é¡»æ˜¯è¿‡å»çš„æ—¥æœŸ")
    private LocalDate birthDate;

    @URL(message = "å¤´åƒURLæ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 255, message = "å¤´åƒURLé•¿åº¦ä¸èƒ½è¶…è¿‡255")
    private String avatarUrl;

    @Min(value = 18, message = "å¹´é¾„ä¸èƒ½å°äº18å²")
    @Max(value = 120, message = "å¹´é¾„ä¸èƒ½å¤§äº120å²")
    private Integer age;

    @AssertTrue(message = "å¿…é¡»åŒæ„æœåŠ¡æ¡æ¬¾")
    private Boolean agreeToTerms;

    // è‡ªå®šä¹‰éªŒè¯æ–¹æ³•
    public boolean isPasswordMatching() {
        return password != null && password.equals(confirmPassword);
    }

    @AssertTrue(message = "ç¡®è®¤å¯†ç ä¸åŒ¹é…")
    public boolean isConfirmPasswordMatching() {
        return isPasswordMatching();
    }
}
```

### 2. éªŒè¯åˆ†ç»„

```java
package com.cmliy.springweb.validation.group;

/**
 * éªŒè¯åˆ†ç»„æ¥å£
 */
public interface ValidationGroups {

    /**
     * åˆ›å»ºæ—¶çš„éªŒè¯ç»„
     */
    interface Create {}

    /**
     * æ›´æ–°æ—¶çš„éªŒè¯ç»„
     */
    interface Update {}

    /**
     * åŸºç¡€éªŒè¯ç»„
     */
    interface Basic {}

    /**
     * é«˜çº§éªŒè¯ç»„
     */
    interface Advanced {}

    /**
     * ç®¡ç†å‘˜æ“ä½œéªŒè¯ç»„
     */
    interface Admin {}
}
```

```java
package com.cmliy.springweb.dto;

import com.cmliy.springweb.validation.group.ValidationGroups;
import jakarta.validation.constraints.*;
import lombok.Data;

/**
 * ä½¿ç”¨éªŒè¯åˆ†ç»„çš„ç”¨æˆ·æ›´æ–°DTO
 */
@Data
public class UserUpdateDTO {

    @Null(groups = ValidationGroups.Create.class, message = "åˆ›å»ºæ—¶IDå¿…é¡»ä¸ºç©º")
    @NotNull(groups = ValidationGroups.Update.class, message = "æ›´æ–°æ—¶IDä¸èƒ½ä¸ºç©º")
    private Long id;

    @NotBlank(groups = {ValidationGroups.Basic.class, ValidationGroups.Update.class})
    @Size(min = 3, max = 50, groups = ValidationGroups.Basic.class)
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", groups = ValidationGroups.Basic.class)
    private String username;

    @NotBlank(groups = ValidationGroups.Basic.class)
    @Email(groups = ValidationGroups.Basic.class)
    private String email;

    @Size(max = 100, groups = ValidationGroups.Basic.class)
    private String fullName;

    @Pattern(regexp = "^1[3-9]\\d{9}$", groups = ValidationGroups.Advanced.class)
    private String phoneNumber;

    @Past(groups = ValidationGroups.Advanced.class)
    private LocalDate birthDate;

    @URL(groups = ValidationGroups.Advanced.class)
    private String avatarUrl;

    @NotNull(groups = ValidationGroups.Admin.class)
    private String role;
}
```

## ğŸ¨ è‡ªå®šä¹‰éªŒè¯æ³¨è§£

### 1. ç”¨æˆ·åå”¯ä¸€æ€§éªŒè¯

```java
package com.cmliy.springweb.validation.annotation;

import com.cmliy.springweb.validation.validator.UniqueUsernameValidator;
import jakarta.validation.Constraint;
import jakarta.validation.Payload;

import java.lang.annotation.*;

/**
 * ç”¨æˆ·åå”¯ä¸€æ€§éªŒè¯æ³¨è§£
 */
@Documented
@Constraint(validatedBy = UniqueUsernameValidator.class)
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
public @interface UniqueUsername {

    String message() default "ç”¨æˆ·åå·²å­˜åœ¨";

    Class<?>[] groups() default {};

    Class<? extends Payload>[] payload() default {};

    /**
     * æ˜¯å¦åœ¨æ›´æ–°æ—¶éªŒè¯ï¼ˆæ’é™¤å½“å‰ç”¨æˆ·ï¼‰
     */
    boolean checkOnUpdate() default false;

    /**
     * ç”¨æˆ·IDå­—æ®µåï¼ˆç”¨äºæ›´æ–°æ—¶æ’é™¤ï¼‰
     */
    String userIdField() default "id";
}
```

```java
package com.cmliy.springweb.validation.validator;

import com.cmliy.springweb.repository.UserRepository;
import com.cmliy.springweb.validation.annotation.UniqueUsername;
import jakarta.validation.ConstraintValidator;
import jakarta.validation.ConstraintValidatorContext;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.BeanWrapper;
import org.springframework.beans.BeanWrapperImpl;
import org.springframework.stereotype.Component;

/**
 * ç”¨æˆ·åå”¯ä¸€æ€§éªŒè¯å™¨
 */
@Component
@RequiredArgsConstructor
public class UniqueUsernameValidator implements ConstraintValidator<UniqueUsername, Object> {

    private final UserRepository userRepository;

    private UniqueUsername annotation;

    @Override
    public void initialize(UniqueUsername constraintAnnotation) {
        this.annotation = constraintAnnotation;
    }

    @Override
    public boolean isValid(Object value, ConstraintValidatorContext context) {
        if (value == null) {
            return true;
        }

        String username = value.toString();
        boolean isUpdate = annotation.checkOnUpdate();

        if (!isUpdate) {
            // åˆ›å»ºæ—¶éªŒè¯
            return !userRepository.existsByUsername(username);
        } else {
            // æ›´æ–°æ—¶éªŒè¯ï¼Œéœ€è¦è·å–ç”¨æˆ·ID
            BeanWrapper beanWrapper = new BeanWrapperImpl(value);
            Long userId = (Long) beanWrapper.getPropertyValue(annotation.userIdField());

            return !userRepository.existsByUsernameAndIdNot(username, userId != null ? userId : 0L);
        }
    }
}
```

### 2. å¯†ç å¼ºåº¦éªŒè¯

```java
package com.cmliy.springweb.validation.annotation;

import com.cmliy.springweb.validation.validator.PasswordStrengthValidator;
import jakarta.validation.Constraint;
import jakarta.validation.Payload;

import java.lang.annotation.*;

/**
 * å¯†ç å¼ºåº¦éªŒè¯æ³¨è§£
 */
@Documented
@Constraint(validatedBy = PasswordStrengthValidator.class)
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
public @interface PasswordStrength {

    String message() default "å¯†ç å¼ºåº¦ä¸å¤Ÿ";

    Class<?>[] groups() default {};

    Class<? extends Payload>[] payload() default {};

    /**
     * æœ€å°å¼ºåº¦ç­‰çº§ (1-5)
     */
    int minStrength() default 3;
}
```

```java
package com.cmliy.springweb.validation.validator;

import com.cmliy.springweb.validation.annotation.PasswordStrength;
import jakarta.validation.ConstraintValidator;
import jakarta.validation.ConstraintValidatorContext;
import org.springframework.stereotype.Component;

/**
 * å¯†ç å¼ºåº¦éªŒè¯å™¨
 */
@Component
public class PasswordStrengthValidator implements ConstraintValidator<PasswordStrength, String> {

    private int minStrength;

    @Override
    public void initialize(PasswordStrength constraintAnnotation) {
        this.minStrength = constraintAnnotation.minStrength();
    }

    @Override
    public boolean isValid(String password, ConstraintValidatorContext context) {
        if (password == null) {
            return true;
        }

        int strength = calculatePasswordStrength(password);
        return strength >= minStrength;
    }

    /**
     * è®¡ç®—å¯†ç å¼ºåº¦
     */
    private int calculatePasswordStrength(String password) {
        int strength = 0;

        // é•¿åº¦æ£€æŸ¥
        if (password.length() >= 8) strength++;
        if (password.length() >= 12) strength++;

        // å­—ç¬¦ç±»å‹æ£€æŸ¥
        if (password.matches(".*[a-z].*")) strength++; // å°å†™å­—æ¯
        if (password.matches(".*[A-Z].*")) strength++; // å¤§å†™å­—æ¯
        if (password.matches(".*\\d.*")) strength++;    // æ•°å­—
        if (password.matches(".*[@$!%*?&].*")) strength++; // ç‰¹æ®Šå­—ç¬¦

        // å¤æ‚æ€§æ£€æŸ¥
        if (password.matches(".*[a-z].*[A-Z].*")) strength++; // å¤§å°å†™æ··åˆ
        if (password.matches(".*\\d.*[@$!%*?&].*")) strength++; // æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦

        return Math.min(strength, 5);
    }
}
```

### 3. æ—¥æœŸèŒƒå›´éªŒè¯

```java
package com.cmliy.springweb.validation.annotation;

import com.cmliy.springweb.validation.validator.DateRangeValidator;
import jakarta.validation.Constraint;
import jakarta.validation.Payload;

import java.lang.annotation.*;

/**
 * æ—¥æœŸèŒƒå›´éªŒè¯æ³¨è§£
 */
@Documented
@Constraint(validatedBy = DateRangeValidator.class)
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
public @interface DateRange {

    String message() default "æ—¥æœŸä¸åœ¨æœ‰æ•ˆèŒƒå›´å†…";

    Class<?>[] groups() default {};

    Class<? extends Payload>[] payload() default {};

    /**
     * æœ€å°æ—¥æœŸï¼ˆç›¸å¯¹äºå½“å‰æ—¥æœŸçš„å¤©æ•°ï¼‰
     */
    int minDays() default Integer.MIN_VALUE;

    /**
     * æœ€å¤§æ—¥æœŸï¼ˆç›¸å¯¹äºå½“å‰æ—¥æœŸçš„å¤©æ•°ï¼‰
     */
    int maxDays() default Integer.MAX_VALUE;

    /**
     * æ˜¯å¦åŒ…å«è¾¹ç•Œ
     */
    boolean inclusive() default true;
}
```

```java
package com.cmliy.springweb.validation.validator;

import com.cmliy.springweb.validation.annotation.DateRange;
import jakarta.validation.ConstraintValidator;
import jakarta.validation.ConstraintValidatorContext;

import java.time.LocalDate;
import java.time.Period;

/**
 * æ—¥æœŸèŒƒå›´éªŒè¯å™¨
 */
public class DateRangeValidator implements ConstraintValidator<DateRange, LocalDate> {

    private int minDays;
    private int maxDays;
    private boolean inclusive;

    @Override
    public void initialize(DateRange constraintAnnotation) {
        this.minDays = constraintAnnotation.minDays();
        this.maxDays = constraintAnnotation.maxDays();
        this.inclusive = constraintAnnotation.inclusive();
    }

    @Override
    public boolean isValid(LocalDate date, ConstraintValidatorContext context) {
        if (date == null) {
            return true;
        }

        LocalDate today = LocalDate.now();
        Period period = Period.between(today, date);
        int daysBetween = period.getDays() + period.getMonths() * 30 + period.getYears() * 365;

        if (inclusive) {
            return daysBetween >= minDays && daysBetween <= maxDays;
        } else {
            return daysBetween > minDays && daysBetween < maxDays;
        }
    }
}
```

## ğŸ”§ é«˜çº§éªŒè¯åŠŸèƒ½

### 1. è·¨å­—æ®µéªŒè¯

```java
package com.cmliy.springweb.dto;

import com.cmliy.springweb.validation.annotation.*;
import jakarta.validation.constraints.*;
import lombok.Data;

import java.time.LocalDate;

/**
 * è·¨å­—æ®µéªŒè¯ç¤ºä¾‹
 */
@Data
public class UserProfileDTO {

    @NotNull
    private Long userId;

    @NotNull
    private LocalDate birthDate;

    @NotNull
    private LocalDate joinDate;

    @Min(value = 18, message = "å¹´é¾„ä¸èƒ½å°äº18å²")
    private Integer age;

    @AssertTrue(message = "åŠ å…¥æ—¥æœŸä¸èƒ½æ—©äºå‡ºç”Ÿæ—¥æœŸ")
    public boolean isJoinDateAfterBirthDate() {
        if (birthDate == null || joinDate == null) {
            return true;
        }
        return !joinDate.isBefore(birthDate);
    }

    @AssertTrue(message = "å¹´é¾„ä¸å‡ºç”Ÿæ—¥æœŸä¸åŒ¹é…")
    public boolean isAgeMatchesBirthDate() {
        if (birthDate == null || age == null) {
            return true;
        }
        int calculatedAge = LocalDate.now().getYear() - birthDate.getYear();
        return Math.abs(calculatedAge - age) <= 1; // å…è®¸1å¹´è¯¯å·®
    }

    @Valid
    @Size(min = 1, message = "è‡³å°‘éœ€è¦ä¸€ä¸ªåœ°å€")
    private List<AddressDTO> addresses;

    @AssertTrue(message = "å¿…é¡»è®¾ç½®ä¸€ä¸ªé»˜è®¤åœ°å€")
    public boolean hasDefaultAddress() {
        if (addresses == null || addresses.isEmpty()) {
            return false;
        }
        return addresses.stream().anyMatch(AddressDTO::getIsDefault);
    }
}
```

### 2. æ¡ä»¶éªŒè¯

```java
package com.cmliy.springweb.validation.annotation;

import com.cmliy.springweb.validation.validator.ConditionalValidator;
import jakarta.validation.Constraint;
import jakarta.validation.Payload;

import java.lang.annotation.*;

/**
 * æ¡ä»¶éªŒè¯æ³¨è§£
 */
@Documented
@Constraint(validatedBy = ConditionalValidator.class)
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface ConditionalValidation {

    String message() default "æ¡ä»¶éªŒè¯å¤±è´¥";

    Class<?>[] groups() default {};

    Class<? extends Payload>[] payload() default {};

    /**
     * æ¡ä»¶è¡¨è¾¾å¼
     */
    String condition();

    /**
     * éªŒè¯çš„æ–¹æ³•å
     */
    String validationMethod();

    /**
     * éªŒè¯å¤±è´¥çš„æ¶ˆæ¯
     */
    String validationMessage() default "";
}
```

```java
package com.cmliy.springweb.validation.validator;

import com.cmliy.springweb.validation.annotation.ConditionalValidation;
import jakarta.validation.ConstraintValidator;
import jakarta.validation.ConstraintValidatorContext;
import lombok.extern.slf4j.Slf4j;
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;
import org.springframework.expression.spel.support.StandardEvaluationContext;

/**
 * æ¡ä»¶éªŒè¯å™¨
 */
@Slf4j
public class ConditionalValidator implements ConstraintValidator<ConditionalValidation, Object> {

    private ExpressionParser parser = new SpelExpressionParser();
    private String condition;
    private String validationMethod;
    private String validationMessage;

    @Override
    public void initialize(ConditionalValidation constraintAnnotation) {
        this.condition = constraintAnnotation.condition();
        this.validationMethod = constraintAnnotation.validationMethod();
        this.validationMessage = constraintAnnotation.validationMessage();
    }

    @Override
    public boolean isValid(Object object, ConstraintValidatorContext context) {
        try {
            // è¯„ä¼°æ¡ä»¶è¡¨è¾¾å¼
            StandardEvaluationContext ctx = new StandardEvaluationContext(object);
            Expression exp = parser.parseExpression(condition);
            Boolean conditionResult = exp.getValue(ctx, Boolean.class);

            if (Boolean.TRUE.equals(conditionResult)) {
                // æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡ŒéªŒè¯æ–¹æ³•
                java.lang.reflect.Method method = object.getClass()
                        .getMethod(validationMethod);
                boolean validationResult = (Boolean) method.invoke(object);

                if (!validationResult) {
                    // éªŒè¯å¤±è´¥ï¼Œæ·»åŠ è‡ªå®šä¹‰æ¶ˆæ¯
                    context.disableDefaultConstraintViolation();
                    context.buildConstraintViolationWithTemplate(validationMessage)
                            .addConstraintViolation();
                }

                return validationResult;
            }

            return true; // æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡éªŒè¯

        } catch (Exception e) {
            log.error("æ¡ä»¶éªŒè¯æ‰§è¡Œå¤±è´¥", e);
            return false;
        }
    }
}
```

### 3. é›†åˆéªŒè¯

```java
package com.cmliy.springweb.dto;

import jakarta.validation.Valid;
import jakarta.validation.constraints.*;
import lombok.Data;

import java.util.List;

/**
 * é›†åˆéªŒè¯ç¤ºä¾‹
 */
@Data
public class BatchUserCreateDTO {

    @Valid
    @NotEmpty(message = "ç”¨æˆ·åˆ—è¡¨ä¸èƒ½ä¸ºç©º")
    @Size(min = 1, max = 100, message = "ç”¨æˆ·æ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´")
    private List<UserCreateDTO> users;

    @AssertTrue(message = "ç”¨æˆ·åä¸èƒ½é‡å¤")
    public boolean isUsernamesUnique() {
        if (users == null || users.isEmpty()) {
            return true;
        }

        long uniqueCount = users.stream()
                .map(UserCreateDTO::getUsername)
                .distinct()
                .count();

        return uniqueCount == users.size();
    }

    @AssertTrue(message = "é‚®ç®±ä¸èƒ½é‡å¤")
    public boolean isEmailsUnique() {
        if (users == null || users.isEmpty()) {
            return true;
        }

        long uniqueCount = users.stream()
                .map(UserCreateDTO::getEmail)
                .distinct()
                .count();

        return uniqueCount == users.size();
    }

    @AssertTrue(message = "ç®¡ç†å‘˜ç”¨æˆ·ä¸èƒ½è¶…è¿‡10ä¸ª")
    public boolean isAdminCountValid() {
        if (users == null || users.isEmpty()) {
            return true;
        }

        long adminCount = users.stream()
                .filter(user -> "ADMIN".equals(user.getRole()))
                .count();

        return adminCount <= 10;
    }
}
```

## ğŸ¯ éªŒè¯æœåŠ¡å±‚

### 1. éªŒè¯æœåŠ¡

```java
package com.cmliy.springweb.service;

import com.cmliy.springweb.dto.UserCreateDTO;
import com.cmliy.springweb.dto.UserUpdateDTO;
import com.cmliy.springweb.validation.group.ValidationGroups;
import jakarta.validation.ConstraintViolation;
import jakarta.validation.Validator;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.Set;
import java.util.stream.Collectors;

/**
 * éªŒè¯æœåŠ¡
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class ValidationService {

    private final Validator validator;

    /**
     * éªŒè¯å¯¹è±¡
     */
    public <T> void validate(T object, Class<?>... groups) {
        Set<ConstraintViolation<T>> violations = validator.validate(object, groups);

        if (!violations.isEmpty()) {
            String errorMessage = violations.stream()
                    .map(ConstraintViolation::getMessage)
                    .collect(Collectors.joining("; "));

            log.warn("éªŒè¯å¤±è´¥: {}", errorMessage);
            throw new jakarta.validation.ValidationException(errorMessage);
        }
    }

    /**
     * éªŒè¯å¹¶è¿”å›é”™è¯¯ä¿¡æ¯
     */
    public <T> Set<ConstraintViolation<T>> validateWithErrors(T object, Class<?>... groups) {
        return validator.validate(object, groups);
    }

    /**
     * éªŒè¯ç”¨æˆ·åˆ›å»º
     */
    public void validateUserCreate(UserCreateDTO userCreateDTO) {
        validate(userCreateDTO, ValidationGroups.Create.class);
    }

    /**
     * éªŒè¯ç”¨æˆ·æ›´æ–°
     */
    public void validateUserUpdate(UserUpdateDTO userUpdateDTO) {
        validate(userUpdateDTO, ValidationGroups.Update.class);
    }

    /**
     * éªŒè¯å¹¶æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯
     */
    public <T> String formatValidationErrors(Set<ConstraintViolation<T>> violations) {
        return violations.stream()
                .collect(Collectors.groupingBy(
                        violation -> violation.getPropertyPath().toString(),
                        Collectors.mapping(ConstraintViolation::getMessage, Collectors.joining(", "))
                ))
                .entrySet()
                .stream()
                .map(entry -> entry.getKey() + ": " + entry.getValue())
                .collect(Collectors.joining("; "));
    }
}
```

### 2. Serviceå±‚éªŒè¯

```java
package com.cmliy.springweb.service.impl;

import com.cmliy.springweb.dto.UserCreateDTO;
import com.cmliy.springweb.service.ValidationService;
import com.cmliy.springweb.validation.group.ValidationGroups;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.validation.annotation.Validated;

/**
 * å¸¦éªŒè¯çš„ç”¨æˆ·æœåŠ¡å®ç°
 */
@Slf4j
@Service
@Validated
@RequiredArgsConstructor
public class ValidatedUserServiceImpl {

    private final ValidationService validationService;

    /**
     * åˆ›å»ºç”¨æˆ·ï¼ˆæ‰‹åŠ¨éªŒè¯ï¼‰
     */
    public void createUserManual(@Valid UserCreateDTO userCreateDTO) {
        // æ‰‹åŠ¨è°ƒç”¨éªŒè¯æœåŠ¡
        validationService.validateUserCreate(userCreateDTO);

        // ä¸šåŠ¡é€»è¾‘
        log.info("åˆ›å»ºç”¨æˆ·: {}", userCreateDTO.getUsername());
    }

    /**
     * åˆ›å»ºç”¨æˆ·ï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰
     */
    public void createUserAuto(@Valid UserCreateDTO userCreateDTO) {
        // Springä¼šè‡ªåŠ¨éªŒè¯å‚æ•°
        log.info("åˆ›å»ºç”¨æˆ·: {}", userCreateDTO.getUsername());
    }

    /**
     * åˆ†ç»„éªŒè¯
     */
    public void updateUserWithGroup(UserCreateDTO userCreateDTO) {
        // ä½¿ç”¨ç‰¹å®šåˆ†ç»„éªŒè¯
        validationService.validate(userCreateDTO, ValidationGroups.Basic.class);

        log.info("æ›´æ–°ç”¨æˆ·åŸºæœ¬ä¿¡æ¯: {}", userCreateDTO.getUsername());
    }

    /**
     * è‡ªå®šä¹‰éªŒè¯é€»è¾‘
     */
    public void createUserWithCustomValidation(UserCreateDTO userCreateDTO) {
        // å…ˆè¿›è¡Œæ ‡å‡†éªŒè¯
        validationService.validateUserCreate(userCreateDTO);

        // ç„¶åè¿›è¡Œè‡ªå®šä¹‰ä¸šåŠ¡éªŒè¯
        validateBusinessRules(userCreateDTO);

        log.info("åˆ›å»ºç”¨æˆ·: {}", userCreateDTO.getUsername());
    }

    private void validateBusinessRules(UserCreateDTO userCreateDTO) {
        // æ£€æŸ¥ä¸šåŠ¡è§„åˆ™
        if (userCreateDTO.getAge() != null && userCreateDTO.getAge() < 18) {
            throw new IllegalArgumentException("ç”¨æˆ·å¹´é¾„ä¸èƒ½å°äº18å²");
        }

        if (userCreateDTO.getBirthDate() != null && userCreateDTO.getJoinDate() != null) {
            if (userCreateDTO.getJoinDate().isBefore(userCreateDTO.getBirthDate())) {
                throw new IllegalArgumentException("åŠ å…¥æ—¥æœŸä¸èƒ½æ—©äºå‡ºç”Ÿæ—¥æœŸ");
            }
        }
    }
}
```

## ğŸ“Š éªŒè¯é…ç½®å’Œä¼˜åŒ–

### 1. éªŒè¯é…ç½®

```java
package com.cmliy.springweb.config;

import org.springframework.context.MessageSource;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.validation.beanvalidation.LocalValidatorFactoryBean;
import org.springframework.validation.beanvalidation.MethodValidationPostProcessor;

import java.util.Properties;

/**
 * éªŒè¯é…ç½®
 */
@Configuration
public class ValidationConfig {

    /**
     * é…ç½®æ¶ˆæ¯æº
     */
    @Bean
    public MessageSource messageSource() {
        ReloadableResourceBundleMessageSource messageSource = new ReloadableResourceBundleMessageSource();
        messageSource.setBasenames("classpath:messages/validation");
        messageSource.setDefaultEncoding("UTF-8");
        messageSource.setCacheSeconds(10); // å¼€å‘ç¯å¢ƒå¯ä»¥è®¾ç½®çŸ­ä¸€äº›
        return messageSource;
    }

    /**
     * é…ç½®éªŒè¯å™¨å·¥å‚
     */
    @Bean
    public LocalValidatorFactoryBean validator() {
        LocalValidatorFactoryBean bean = new LocalValidatorFactoryBean();
        bean.setValidationMessageSource(messageSource());
        bean.setValidationProperties(validationProperties());
        return bean;
    }

    /**
     * æ–¹æ³•éªŒè¯åå¤„ç†å™¨
     */
    @Bean
    public MethodValidationPostProcessor methodValidationPostProcessor() {
        return new MethodValidationPostProcessor();
    }

    /**
     * éªŒè¯å±æ€§
     */
    private Properties validationProperties() {
        Properties properties = new Properties();
        properties.setProperty("hibernate.validator.fail_fast", "true");
        return properties;
    }
}
```

### 2. éªŒè¯æ¶ˆæ¯èµ„æº

```properties
# src/main/resources/messages/validation.properties

# ç”¨æˆ·ç›¸å…³éªŒè¯æ¶ˆæ¯
user.username.notblank=ç”¨æˆ·åä¸èƒ½ä¸ºç©º
user.username.size=ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨{min}-{max}ä¹‹é—´
user.username.pattern=ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
user.username.unique=ç”¨æˆ·åå·²å­˜åœ¨

user.email.notblank=é‚®ç®±ä¸èƒ½ä¸ºç©º
user.email.email=é‚®ç®±æ ¼å¼ä¸æ­£ç¡®
user.email.unique=é‚®ç®±å·²å­˜åœ¨

user.password.notblank=å¯†ç ä¸èƒ½ä¸ºç©º
user.password.size=å¯†ç é•¿åº¦å¿…é¡»åœ¨{min}-{max}ä¹‹é—´
user.password.pattern=å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
user.password.strength=å¯†ç å¼ºåº¦ä¸å¤Ÿï¼Œè‡³å°‘éœ€è¦{minStrength}çº§

user.birthDate.past=å‡ºç”Ÿæ—¥æœŸå¿…é¡»æ˜¯è¿‡å»çš„æ—¥æœŸ
user.birthDate.range=å‡ºç”Ÿæ—¥æœŸå¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†…

# é€šç”¨éªŒè¯æ¶ˆæ¯
validation.notnull={field}ä¸èƒ½ä¸ºç©º
validation.notblank={field}ä¸èƒ½ä¸ºç©º
validation.size={field}é•¿åº¦å¿…é¡»åœ¨{min}-{max}ä¹‹é—´
validation.min={field}ä¸èƒ½å°äº{value}
validation.max={field}ä¸èƒ½å¤§äº{value}
validation.email={field}æ ¼å¼ä¸æ­£ç¡®
validation.pattern={field}æ ¼å¼ä¸æ­£ç¡®
validation.url={field}URLæ ¼å¼ä¸æ­£ç¡®
validation.past={field}å¿…é¡»æ˜¯è¿‡å»çš„æ—¥æœŸ
validation.future={field}å¿…é¡»æ˜¯æœªæ¥çš„æ—¥æœŸ
validation.asserttrue={field}éªŒè¯å¤±è´¥
```

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ä½¿ç”¨Bean Validationè¿›è¡Œæ•°æ®éªŒè¯
- [ ] åˆ›å»ºè‡ªå®šä¹‰éªŒè¯æ³¨è§£
- [ ] å®ç°è·¨å­—æ®µå’Œæ¡ä»¶éªŒè¯
- [ ] é…ç½®éªŒè¯æ¶ˆæ¯å’Œåˆ†ç»„
- [ ] åœ¨Serviceå±‚è¿›è¡ŒéªŒè¯

## ğŸš€ ä¸‹ä¸€æ­¥

æ•°æ®éªŒè¯å­¦ä¹ å®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š
[æ—¥å¿—è®°å½•](03-æ—¥å¿—è®°å½•.md)

---

**æç¤º**: éªŒè¯åº”è¯¥åœ¨ç³»ç»Ÿçš„å¤šä¸ªå±‚æ¬¡è¿›è¡Œï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ã€ä¸šåŠ¡éªŒè¯å’Œæ•°æ®å®Œæ•´æ€§éªŒè¯ï¼Œç¡®ä¿æ•°æ®çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ã€‚