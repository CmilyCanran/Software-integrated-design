# å…¨å±€å¼‚å¸¸å¤„ç†

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- ç†è§£Spring Bootå¼‚å¸¸å¤„ç†æœºåˆ¶
- æŒæ¡å…¨å±€å¼‚å¸¸å¤„ç†å™¨çš„è®¾è®¡
- å­¦ä¼šè‡ªå®šä¹‰å¼‚å¸¸å’Œé”™è¯¯å“åº”
- äº†è§£å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ

## ğŸ—ï¸ å¼‚å¸¸å¤„ç†åŸºç¡€æ¦‚å¿µ

### å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§
- **ç”¨æˆ·ä½“éªŒ**: æä¾›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **ç³»ç»Ÿç¨³å®šæ€§**: é˜²æ­¢å¼‚å¸¸å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- **è°ƒè¯•æ”¯æŒ**: è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- **å®‰å…¨æ€§**: é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²

### Spring Bootå¼‚å¸¸å¤„ç†æœºåˆ¶
- **é»˜è®¤å¼‚å¸¸å¤„ç†**: Spring Bootæä¾›é»˜è®¤çš„é”™è¯¯é¡µé¢
- **å…¨å±€å¼‚å¸¸å¤„ç†å™¨**: ä½¿ç”¨@ControllerAdviceç»Ÿä¸€å¤„ç†
- **è‡ªå®šä¹‰å¼‚å¸¸**: åˆ›å»ºä¸šåŠ¡ç›¸å…³çš„å¼‚å¸¸ç±»å‹
- **é”™è¯¯å“åº”**: ç»Ÿä¸€çš„APIé”™è¯¯å“åº”æ ¼å¼

## ğŸ“ è‡ªå®šä¹‰å¼‚å¸¸è®¾è®¡

### 1. åŸºç¡€å¼‚å¸¸ç±»

```java
package com.cmliy.springweb.exception;

/**
 * åŸºç¡€ä¸šåŠ¡å¼‚å¸¸ç±»
 */
public class BaseException extends RuntimeException {

    private final String errorCode;
    private final Object data;

    public BaseException(String message) {
        super(message);
        this.errorCode = null;
        this.data = null;
    }

    public BaseException(String message, String errorCode) {
        super(message);
        this.errorCode = errorCode;
        this.data = null;
    }

    public BaseException(String message, String errorCode, Object data) {
        super(message);
        this.errorCode = errorCode;
        this.data = data;
    }

    public BaseException(String message, Throwable cause) {
        super(message, cause);
        this.errorCode = null;
        this.data = null;
    }

    public BaseException(String message, String errorCode, Throwable cause) {
        super(message, cause);
        this.errorCode = errorCode;
        this.data = null;
    }

    public String getErrorCode() {
        return errorCode;
    }

    public Object getData() {
        return data;
    }
}
```

### 2. ä¸šåŠ¡å¼‚å¸¸ç±»

```java
package com.cmliy.springweb.exception;

/**
 * ç”¨æˆ·ç›¸å…³å¼‚å¸¸
 */
public class UserException extends BaseException {

    public UserException(String message) {
        super(message);
    }

    public UserException(String message, String errorCode) {
        super(message, errorCode);
    }

    public UserException(String message, String errorCode, Object data) {
        super(message, errorCode, data);
    }

    // é™æ€å·¥å‚æ–¹æ³•
    public static UserException userNotFound(Long userId) {
        return new UserException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId, "USER_NOT_FOUND", userId);
    }

    public static UserException userNotFound(String username) {
        return new UserException("ç”¨æˆ·ä¸å­˜åœ¨: " + username, "USER_NOT_FOUND", username);
    }

    public static UserException duplicateUsername(String username) {
        return new UserException("ç”¨æˆ·åå·²å­˜åœ¨: " + username, "DUPLICATE_USERNAME", username);
    }

    public static UserException duplicateEmail(String email) {
        return new UserException("é‚®ç®±å·²å­˜åœ¨: " + email, "DUPLICATE_EMAIL", email);
    }

    public static UserException invalidPassword() {
        return new UserException("å¯†ç ä¸æ­£ç¡®", "INVALID_PASSWORD");
    }

    public static UserException accountDisabled(String username) {
        return new UserException("è´¦æˆ·å·²ç¦ç”¨: " + username, "ACCOUNT_DISABLED", username);
    }

    public static UserException accountLocked(String username) {
        return new UserException("è´¦æˆ·å·²é”å®š: " + username, "ACCOUNT_LOCKED", username);
    }
}

/**
 * æƒé™ç›¸å…³å¼‚å¸¸
 */
public class PermissionException extends BaseException {

    public PermissionException(String message) {
        super(message);
    }

    public PermissionException(String message, String errorCode) {
        super(message, errorCode);
    }

    public static PermissionException accessDenied() {
        return new PermissionException("è®¿é—®è¢«æ‹’ç»", "ACCESS_DENIED");
    }

    public static PermissionException insufficientPermission() {
        return new PermissionException("æƒé™ä¸è¶³", "INSUFFICIENT_PERMISSION");
    }

    public static PermissionException operationNotAllowed(String operation) {
        return new PermissionException("æ“ä½œä¸è¢«å…è®¸: " + operation, "OPERATION_NOT_ALLOWED", operation);
    }
}

/**
 * ä¸šåŠ¡è§„åˆ™å¼‚å¸¸
 */
public class BusinessException extends BaseException {

    public BusinessException(String message) {
        super(message);
    }

    public BusinessException(String message, String errorCode) {
        super(message, errorCode);
    }

    public static BusinessException operationNotSupported(String operation) {
        return new BusinessException("ä¸æ”¯æŒçš„æ“ä½œ: " + operation, "OPERATION_NOT_SUPPORTED", operation);
    }

    public static BusinessException resourceConflict(String resource) {
        return new BusinessException("èµ„æºå†²çª: " + resource, "RESOURCE_CONFLICT", resource);
    }

    public static BusinessException quotaExceeded(String quotaType) {
        return new BusinessException("é…é¢å·²è¶…å‡º: " + quotaType, "QUOTA_EXCEEDED", quotaType);
    }
}

/**
 * ç³»ç»Ÿå¼‚å¸¸
 */
public class SystemException extends BaseException {

    public SystemException(String message) {
        super(message);
    }

    public SystemException(String message, Throwable cause) {
        super(message, cause);
    }

    public static SystemException databaseError(String message) {
        return new SystemException("æ•°æ®åº“é”™è¯¯: " + message, "DATABASE_ERROR");
    }

    public static SystemException networkError(String message) {
        return new SystemException("ç½‘ç»œé”™è¯¯: " + message, "NETWORK_ERROR");
    }

    public static SystemException configurationError(String config) {
        return new SystemException("é…ç½®é”™è¯¯: " + config, "CONFIGURATION_ERROR", config);
    }
}
```

## ğŸ¯ å…¨å±€å¼‚å¸¸å¤„ç†å™¨

### 1. å…¨å±€å¼‚å¸¸å¤„ç†å™¨ç±»

```java
package com.cmliy.springweb.exception;

import com.cmliy.springweb.dto.ApiResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.validation.BindException;
import org.springframework.validation.FieldError;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.multipart.MaxUploadSizeExceededException;
import org.springframework.web.servlet.NoHandlerFoundException;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.ConstraintViolation;
import jakarta.validation.ConstraintViolationException;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    // ==================== ä¸šåŠ¡å¼‚å¸¸å¤„ç† ====================

    /**
     * å¤„ç†åŸºç¡€ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BaseException.class)
    public ResponseEntity<ApiResponse<Void>> handleBaseException(
            BaseException e, HttpServletRequest request) {

        log.warn("ä¸šåŠ¡å¼‚å¸¸: {} - {}", e.getErrorCode(), e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message(e.getMessage())
                .errorCode(e.getErrorCode())
                .timestamp(LocalDateTime.now())
                .build();

        HttpStatus status = determineHttpStatus(e);
        return ResponseEntity.status(status).body(response);
    }

    /**
     * å¤„ç†ç”¨æˆ·å¼‚å¸¸
     */
    @ExceptionHandler(UserException.class)
    public ResponseEntity<ApiResponse<Void>> handleUserException(
            UserException e, HttpServletRequest request) {

        log.warn("ç”¨æˆ·å¼‚å¸¸: {} - {}", e.getErrorCode(), e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message(e.getMessage())
                .errorCode(e.getErrorCode())
                .data(e.getData())
                .timestamp(LocalDateTime.now())
                .build();

        HttpStatus status = determineHttpStatus(e);
        return ResponseEntity.status(status).body(response);
    }

    /**
     * å¤„ç†æƒé™å¼‚å¸¸
     */
    @ExceptionHandler(PermissionException.class)
    public ResponseEntity<ApiResponse<Void>> handlePermissionException(
            PermissionException e, HttpServletRequest request) {

        log.warn("æƒé™å¼‚å¸¸: {} - {}", e.getErrorCode(), e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message(e.getMessage())
                .errorCode(e.getErrorCode())
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(response);
    }

    // ==================== å‚æ•°éªŒè¯å¼‚å¸¸å¤„ç† ====================

    /**
     * å¤„ç†æ–¹æ³•å‚æ•°éªŒè¯å¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Map<String, String>>> handleMethodArgumentNotValidException(
            MethodArgumentNotValidException e, HttpServletRequest request) {

        log.warn("å‚æ•°éªŒè¯å¤±è´¥: {}", e.getMessage());

        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getAllErrors().forEach(error -> {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });

        ApiResponse<Map<String, String>> response = ApiResponse.<Map<String, String>>builder()
                .success(false)
                .message("å‚æ•°éªŒè¯å¤±è´¥")
                .errorCode("VALIDATION_FAILED")
                .data(errors)
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.badRequest().body(response);
    }

    /**
     * å¤„ç†ç»‘å®šå¼‚å¸¸
     */
    @ExceptionHandler(BindException.class)
    public ResponseEntity<ApiResponse<Map<String, String>>> handleBindException(
            BindException e, HttpServletRequest request) {

        log.warn("æ•°æ®ç»‘å®šå¤±è´¥: {}", e.getMessage());

        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getAllErrors().forEach(error -> {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });

        ApiResponse<Map<String, String>> response = ApiResponse.<Map<String, String>>builder()
                .success(false)
                .message("æ•°æ®ç»‘å®šå¤±è´¥")
                .errorCode("BIND_FAILED")
                .data(errors)
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.badRequest().body(response);
    }

    /**
     * å¤„ç†çº¦æŸè¿åå¼‚å¸¸
     */
    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity<ApiResponse<Map<String, String>>> handleConstraintViolationException(
            ConstraintViolationException e, HttpServletRequest request) {

        log.warn("çº¦æŸéªŒè¯å¤±è´¥: {}", e.getMessage());

        Map<String, String> errors = new HashMap<>();
        Set<ConstraintViolation<?>> violations = e.getConstraintViolations();
        for (ConstraintViolation<?> violation : violations) {
            String fieldName = violation.getPropertyPath().toString();
            String errorMessage = violation.getMessage();
            errors.put(fieldName, errorMessage);
        }

        ApiResponse<Map<String, String>> response = ApiResponse.<Map<String, String>>builder()
                .success(false)
                .message("çº¦æŸéªŒè¯å¤±è´¥")
                .errorCode("CONSTRAINT_VIOLATION")
                .data(errors)
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.badRequest().body(response);
    }

    // ==================== HTTPç›¸å…³å¼‚å¸¸å¤„ç† ====================

    /**
     * å¤„ç†HTTPæ–¹æ³•ä¸æ”¯æŒå¼‚å¸¸
     */
    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)
    public ResponseEntity<ApiResponse<Void>> handleHttpRequestMethodNotSupportedException(
            HttpRequestMethodNotSupportedException e, HttpServletRequest request) {

        log.warn("HTTPæ–¹æ³•ä¸æ”¯æŒ: {}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("ä¸æ”¯æŒçš„HTTPæ–¹æ³•: " + e.getMethod())
                .errorCode("METHOD_NOT_ALLOWED")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.METHOD_NOT_ALLOWED).body(response);
    }

    /**
     * å¤„ç†ç¼ºå°‘è¯·æ±‚å‚æ•°å¼‚å¸¸
     */
    @ExceptionHandler(MissingServletRequestParameterException.class)
    public ResponseEntity<ApiResponse<Void>> handleMissingServletRequestParameterException(
            MissingServletRequestParameterException e, HttpServletRequest request) {

        log.warn("ç¼ºå°‘è¯·æ±‚å‚æ•°: {}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("ç¼ºå°‘å¿…éœ€çš„è¯·æ±‚å‚æ•°: " + e.getParameterName())
                .errorCode("MISSING_PARAMETER")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.badRequest().body(response);
    }

    /**
     * å¤„ç†æ–¹æ³•å‚æ•°ç±»å‹ä¸åŒ¹é…å¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    public ResponseEntity<ApiResponse<Void>> handleMethodArgumentTypeMismatchException(
            MethodArgumentTypeMismatchException e, HttpServletRequest request) {

        log.warn("å‚æ•°ç±»å‹ä¸åŒ¹é…: {}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("å‚æ•°ç±»å‹ä¸åŒ¹é…: " + e.getName())
                .errorCode("TYPE_MISMATCH")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.badRequest().body(response);
    }

    /**
     * å¤„ç†æ–‡ä»¶ä¸Šä¼ å¤§å°è¶…é™å¼‚å¸¸
     */
    @ExceptionHandler(MaxUploadSizeExceededException.class)
    public ResponseEntity<ApiResponse<Void>> handleMaxUploadSizeExceededException(
            MaxUploadSizeExceededException e, HttpServletRequest request) {

        log.warn("æ–‡ä»¶ä¸Šä¼ å¤§å°è¶…é™: {}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("ä¸Šä¼ æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶")
                .errorCode("FILE_SIZE_EXCEEDED")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.PAYLOAD_TOO_LARGE).body(response);
    }

    /**
     * å¤„ç†è®¿é—®æ‹’ç»å¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponse<Void>> handleAccessDeniedException(
            AccessDeniedException e, HttpServletRequest request) {

        log.warn("è®¿é—®è¢«æ‹’ç»: {}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("è®¿é—®è¢«æ‹’ç»")
                .errorCode("ACCESS_DENIED")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(response);
    }

    /**
     * å¤„ç†404å¼‚å¸¸
     */
    @ExceptionHandler(NoHandlerFoundException.class)
    public ResponseEntity<ApiResponse<Void>> handleNoHandlerFoundException(
            NoHandlerFoundException e, HttpServletRequest request) {

        log.warn("è¯·æ±‚è·¯å¾„ä¸å­˜åœ¨: {}", e.getRequestURL());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨")
                .errorCode("NOT_FOUND")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }

    // ==================== ç³»ç»Ÿå¼‚å¸¸å¤„ç† ====================

    /**
     * å¤„ç†æ•°æ®åº“å¼‚å¸¸
     */
    @ExceptionHandler(org.springframework.dao.DataAccessException.class)
    public ResponseEntity<ApiResponse<Void>> handleDataAccessException(
            org.springframework.dao.DataAccessException e, HttpServletRequest request) {

        log.error("æ•°æ®åº“è®¿é—®å¼‚å¸¸", e);

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("æ•°æ®åº“æ“ä½œå¤±è´¥")
                .errorCode("DATABASE_ERROR")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }

    /**
     * å¤„ç†ç©ºæŒ‡é’ˆå¼‚å¸¸
     */
    @ExceptionHandler(NullPointerException.class)
    public ResponseEntity<ApiResponse<Void>> handleNullPointerException(
            NullPointerException e, HttpServletRequest request) {

        log.error("ç©ºæŒ‡é’ˆå¼‚å¸¸", e);

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("ç³»ç»Ÿå†…éƒ¨é”™è¯¯")
                .errorCode("INTERNAL_ERROR")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }

    /**
     * å¤„ç†é€šç”¨å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleGenericException(
            Exception e, HttpServletRequest request) {

        log.error("æœªå¤„ç†çš„å¼‚å¸¸", e);

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message("ç³»ç»Ÿå†…éƒ¨é”™è¯¯")
                .errorCode("INTERNAL_ERROR")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }

    // ==================== è¾…åŠ©æ–¹æ³• ====================

    /**
     * æ ¹æ®å¼‚å¸¸ç±»å‹ç¡®å®šHTTPçŠ¶æ€ç 
     */
    private HttpStatus determineHttpStatus(BaseException e) {
        if (e instanceof UserException) {
            switch (e.getErrorCode()) {
                case "USER_NOT_FOUND":
                    return HttpStatus.NOT_FOUND;
                case "DUPLICATE_USERNAME":
                case "DUPLICATE_EMAIL":
                    return HttpStatus.CONFLICT;
                case "INVALID_PASSWORD":
                case "ACCOUNT_DISABLED":
                case "ACCOUNT_LOCKED":
                    return HttpStatus.BAD_REQUEST;
                default:
                    return HttpStatus.BAD_REQUEST;
            }
        } else if (e instanceof PermissionException) {
            return HttpStatus.FORBIDDEN;
        } else if (e instanceof BusinessException) {
            switch (e.getErrorCode()) {
                case "RESOURCE_CONFLICT":
                    return HttpStatus.CONFLICT;
                case "QUOTA_EXCEEDED":
                    return HttpStatus.PAYLOAD_TOO_LARGE;
                default:
                    return HttpStatus.BAD_REQUEST;
            }
        } else {
            return HttpStatus.INTERNAL_SERVER_ERROR;
        }
    }
}
```

### 2. Webé¡µé¢å¼‚å¸¸å¤„ç†å™¨

```java
package com.cmliy.springweb.exception;

import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.web.servlet.error.ErrorAttributes;
import org.springframework.boot.web.servlet.error.ErrorController;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.context.request.WebRequest;

import jakarta.servlet.http.HttpServletRequest;
import java.util.Map;

/**
 * Webé¡µé¢é”™è¯¯æ§åˆ¶å™¨
 */
@Slf4j
@Controller
@RequestMapping("/error")
public class WebErrorController implements ErrorController {

    private final ErrorAttributes errorAttributes;

    public WebErrorController(ErrorAttributes errorAttributes) {
        this.errorAttributes = errorAttributes;
    }

    /**
     * å¤„ç†Webé¡µé¢é”™è¯¯
     */
    @GetMapping
    public String handleError(HttpServletRequest request, Model model) {
        HttpStatus status = getStatus(request);
        Map<String, Object> errorDetails = getErrorAttributes(request);

        log.error("Webé¡µé¢é”™è¯¯: {} - {}", status.value(), errorDetails.get("message"));

        model.addAttribute("status", status.value());
        model.addAttribute("error", errorDetails.get("error"));
        model.addAttribute("message", errorDetails.get("message"));
        model.addAttribute("path", errorDetails.get("path"));
        model.addAttribute("timestamp", errorDetails.get("timestamp"));

        // æ ¹æ®çŠ¶æ€ç è¿”å›ä¸åŒçš„é”™è¯¯é¡µé¢
        switch (status) {
            case NOT_FOUND:
                return "error/404";
            case FORBIDDEN:
                return "error/403";
            case INTERNAL_SERVER_ERROR:
                return "error/500";
            default:
                return "error/default";
        }
    }

    /**
     * å¤„ç†404é”™è¯¯
     */
    @GetMapping("/404")
    public String handleNotFound(Model model) {
        model.addAttribute("status", 404);
        model.addAttribute("message", "è¯·æ±‚çš„é¡µé¢ä¸å­˜åœ¨");
        return "error/404";
    }

    /**
     * å¤„ç†403é”™è¯¯
     */
    @GetMapping("/403")
    public String handleForbidden(Model model) {
        model.addAttribute("status", 403);
        model.addAttribute("message", "è®¿é—®è¢«æ‹’ç»");
        return "error/403";
    }

    /**
     * å¤„ç†500é”™è¯¯
     */
    @GetMapping("/500")
    public String handleInternalServerError(Model model) {
        model.addAttribute("status", 500);
        model.addAttribute("message", "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯");
        return "error/500";
    }

    /**
     * è·å–HTTPçŠ¶æ€ç 
     */
    private HttpStatus getStatus(HttpServletRequest request) {
        Integer statusCode = (Integer) request.getAttribute("jakarta.servlet.error.status_code");
        if (statusCode == null) {
            return HttpStatus.INTERNAL_SERVER_ERROR;
        }
        return HttpStatus.valueOf(statusCode);
    }

    /**
     * è·å–é”™è¯¯è¯¦æƒ…
     */
    private Map<String, Object> getErrorAttributes(HttpServletRequest request) {
        WebRequest webRequest = new org.springframework.web.context.request.ServletWebRequest(request);
        return errorAttributes.getErrorAttributes(webRequest, true);
    }
}
```

## ğŸ¨ é”™è¯¯é¡µé¢è®¾è®¡

### 1. 404é”™è¯¯é¡µé¢

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>é¡µé¢æœªæ‰¾åˆ° - 404</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .error-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .error-content {
            text-align: center;
            color: white;
        }

        .error-code {
            font-size: 8rem;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .error-message {
            font-size: 1.5rem;
            margin-bottom: 2rem;
        }

        .error-actions .btn {
            margin: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-content">
            <div class="error-code" th:text="${status}">404</div>
            <h1 class="error-message">é¡µé¢æœªæ‰¾åˆ°</h1>
            <p class="lead">æŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤ã€‚</p>

            <div class="error-actions">
                <a th:href="@{/}" class="btn btn-light btn-lg">
                    <i class="fas fa-home me-2"></i>è¿”å›é¦–é¡µ
                </a>
                <button onclick="history.back()" class="btn btn-outline-light btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>è¿”å›ä¸Šé¡µ
                </button>
            </div>

            <div class="mt-4">
                <small>
                    é”™è¯¯ID: <span th:text="${timestamp}">æ—¶é—´æˆ³</span> |
                    è·¯å¾„: <span th:text="${path}">è·¯å¾„</span>
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/js/all.min.js"></script>
</body>
</html>
```

### 2. 500é”™è¯¯é¡µé¢

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>æœåŠ¡å™¨é”™è¯¯ - 500</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .error-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .error-content {
            text-align: center;
            color: white;
            max-width: 600px;
            padding: 2rem;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .error-code {
            font-size: 6rem;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .error-details {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-content">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="error-code" th:text="${status}">500</div>
            <h1>æœåŠ¡å™¨å†…éƒ¨é”™è¯¯</h1>
            <p class="lead">æŠ±æ­‰ï¼ŒæœåŠ¡å™¨é‡åˆ°äº†ä¸€ä¸ªé”™è¯¯ï¼Œæ— æ³•å®Œæˆæ‚¨çš„è¯·æ±‚ã€‚</p>

            <div class="error-details">
                <h5>é”™è¯¯è¯¦æƒ…</h5>
                <div class="text-start">
                    <p><strong>é”™è¯¯ç±»å‹:</strong> <span th:text="${error}">Internal Server Error</span></p>
                    <p><strong>é”™è¯¯æ¶ˆæ¯:</strong> <span th:text="${message}">Error message</span></p>
                    <p><strong>è¯·æ±‚è·¯å¾„:</strong> <span th:text="${path}">Request path</span></p>
                    <p><strong>å‘ç”Ÿæ—¶é—´:</strong> <span th:text="${timestamp}">Timestamp</span></p>
                </div>
            </div>

            <div class="error-actions mt-4">
                <a th:href="@{/}" class="btn btn-light btn-lg me-2">
                    <i class="fas fa-home me-2"></i>è¿”å›é¦–é¡µ
                </a>
                <button onclick="location.reload()" class="btn btn-outline-light btn-lg">
                    <i class="fas fa-redo me-2"></i>é‡è¯•
                </button>
            </div>

            <div class="mt-4">
                <small>
                    å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/js/all.min.js"></script>
</body>
</html>
```

## ğŸ”§ å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

### 1. å¼‚å¸¸å¤„ç†åŸåˆ™

```java
@Service
public class UserService {

    /**
     * âœ… å¥½çš„åšæ³•ï¼šå…·ä½“çš„å¼‚å¸¸å¤„ç†
     */
    public UserDTO getUserById(Long id) {
        return userRepository.findById(id)
                .map(userMapper::toDTO)
                .orElseThrow(() -> UserException.userNotFound(id));
    }

    /**
     * âŒ é¿å…çš„åšæ³•ï¼šæŠ›å‡ºé€šç”¨å¼‚å¸¸
     */
    public UserDTO getUserByIdBad(Long id) {
        Optional<User> user = userRepository.findById(id);
        if (user.isPresent()) {
            return userMapper::toDTO;
        } else {
            throw new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"); // å¤ªé€šç”¨
        }
    }

    /**
     * âœ… å¥½çš„åšæ³•ï¼šå¼‚å¸¸é“¾ä¿æŒ
     */
    @Transactional
    public UserDTO createUser(UserCreateDTO dto) {
        try {
            // ä¸šåŠ¡é€»è¾‘
            return savedUser;
        } catch (DataIntegrityViolationException e) {
            // è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸ï¼Œä¿æŒåŸå§‹å¼‚å¸¸
            throw new BusinessException("ç”¨æˆ·åˆ›å»ºå¤±è´¥: æ•°æ®å®Œæ•´æ€§å†²çª",
                                      "DATA_INTEGRITY_VIOLATION", e);
        }
    }

    /**
     * âœ… å¥½çš„åšæ³•ï¼šè®°å½•è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
     */
    public void deleteUser(Long id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> UserException.userNotFound(id));

        if (user.hasRelatedData()) {
            throw new BusinessException("ç”¨æˆ·å­˜åœ¨å…³è”æ•°æ®ï¼Œæ— æ³•åˆ é™¤",
                                      "HAS_RELATED_DATA",
                                      Map.of("userId", id, "relatedData", user.getRelatedDataCount()));
        }

        userRepository.delete(user);
        log.info("ç”¨æˆ·åˆ é™¤æˆåŠŸ: userId={}, username={}", id, user.getUsername());
    }
}
```

### 2. å¼‚å¸¸æ—¥å¿—è®°å½•

```java
@Slf4j
@RestControllerAdvice
public class LoggingExceptionHandler {

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleException(Exception e, HttpServletRequest request) {
        // è®°å½•è¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯
        String requestId = MDC.get("requestId");
        String userAgent = request.getHeader("User-Agent");
        String clientIP = getClientIP(request);

        log.error("æœªå¤„ç†å¼‚å¸¸ [requestId={}, path={}, method={}, clientIP={}, userAgent={}]",
                  requestId, request.getRequestURI(), request.getMethod(), clientIP, userAgent, e);

        // æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
        String sanitizedMessage = sanitizeErrorMessage(e.getMessage());

        ApiResponse<Void> response = ApiResponse.<Void>builder()
                .success(false)
                .message(sanitizedMessage)
                .errorCode("INTERNAL_ERROR")
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }

    private String getClientIP(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }
        return request.getRemoteAddr();
    }

    private String sanitizeErrorMessage(String message) {
        // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
        return message.replaceAll("password=\\w+", "password=***")
                     .replaceAll("token=\\w+", "token=***");
    }
}
```

### 3. å¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦

```java
@Component
public class ExceptionMonitor {

    private final MeterRegistry meterRegistry;
    private final AlertService alertService;

    public ExceptionMonitor(MeterRegistry meterRegistry, AlertService alertService) {
        this.meterRegistry = meterRegistry;
        this.alertService = alertService;
    }

    @EventListener
    public void handleExceptionEvent(ExceptionEvent event) {
        // è®°å½•å¼‚å¸¸æŒ‡æ ‡
        meterRegistry.counter("exceptions.total",
                "exception.type", event.getException().getClass().getSimpleName(),
                "status.code", String.valueOf(event.getStatusCode()))
                .increment();

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
        if (shouldAlert(event)) {
            alertService.sendAlert(createAlertMessage(event));
        }
    }

    private boolean shouldAlert(ExceptionEvent event) {
        // ç³»ç»Ÿå¼‚å¸¸éœ€è¦å‘Šè­¦
        if (event.getException() instanceof SystemException) {
            return true;
        }

        // 5xxé”™è¯¯éœ€è¦å‘Šè­¦
        if (event.getStatusCode() >= 500) {
            return true;
        }

        // çŸ­æ—¶é—´å†…å¤§é‡ç›¸åŒå¼‚å¸¸éœ€è¦å‘Šè­¦
        return hasHighErrorRate(event.getException().getClass());
    }

    private boolean hasHighErrorRate(Class<? extends Exception> exceptionClass) {
        // å®ç°é”™è¯¯ç‡æ£€æŸ¥é€»è¾‘
        return false;
    }
}
```

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è®¾è®¡åˆç†çš„è‡ªå®šä¹‰å¼‚å¸¸ç±»
- [ ] å®ç°å…¨å±€å¼‚å¸¸å¤„ç†å™¨
- [ ] åˆ›å»ºå‹å¥½çš„é”™è¯¯é¡µé¢
- [ ] éµå¾ªå¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ
- [ ] å®ç°å¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦

## ğŸš€ ä¸‹ä¸€æ­¥

å¼‚å¸¸å¤„ç†å­¦ä¹ å®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š
[æ•°æ®éªŒè¯](02-æ•°æ®éªŒè¯.md)

---

**æç¤º**: å¥½çš„å¼‚å¸¸å¤„ç†åº”è¯¥æ—¢èƒ½æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œåˆèƒ½ä¿ç•™è¶³å¤Ÿçš„æŠ€æœ¯ç»†èŠ‚ç”¨äºè°ƒè¯•å’Œç›‘æ§ã€‚