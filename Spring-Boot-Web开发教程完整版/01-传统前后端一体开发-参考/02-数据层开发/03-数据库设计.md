# 数据库表结构设计

## 📋 学习目标

- 理解关系型数据库的设计原则
- 掌握用户管理系统的数据库设计
- 学会编写数据库DDL语句
- 了解数据库索引和约束的优化

## 🗄️ 数据库设计原则

### 1. 数据库范式

#### 第一范式 (1NF)
- 字段不可再分
- 每个字段都是原子性的

#### 第二范式 (2NF)
- 满足1NF
- 非主键字段完全依赖于主键

#### 第三范式 (3NF)
- 满足2NF
- 非主键字段不传递依赖于主键

### 2. 设计原则
- 单一职责：每个表只描述一个实体
- 主键原则：每个表都有主键
- 外键关系：通过外键维护表关系
- 数据完整性：使用约束保证数据质量

## 📊 用户管理系统数据库设计

### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码（加密存储）',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    full_name VARCHAR(100) COMMENT '全名',
    phone_number VARCHAR(20) COMMENT '电话号码',
    gender ENUM('MALE', 'FEMALE', 'OTHER') COMMENT '性别',
    birth_date DATE COMMENT '出生日期',
    avatar_url VARCHAR(255) COMMENT '头像URL',
    enabled TINYINT(1) NOT NULL DEFAULT 1 COMMENT '是否启用',
    role ENUM('USER', 'ADMIN', 'SUPER_ADMIN') NOT NULL DEFAULT 'USER' COMMENT '用户角色',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_enabled (enabled),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

### 2. 地址表 (addresses)

```sql
CREATE TABLE addresses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '地址ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    street VARCHAR(200) NOT NULL COMMENT '街道地址',
    city VARCHAR(100) NOT NULL COMMENT '城市',
    province VARCHAR(100) NOT NULL COMMENT '省份',
    postal_code VARCHAR(20) COMMENT '邮政编码',
    country VARCHAR(100) NOT NULL DEFAULT '中国' COMMENT '国家',
    type ENUM('HOME', 'WORK', 'SHIPPING', 'BILLING') NOT NULL COMMENT '地址类型',
    is_default TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否默认地址',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_city (city),
    INDEX idx_province (province),
    INDEX idx_type (type),
    INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='地址表';
```

### 3. 用户档案表 (user_profiles)

```sql
CREATE TABLE user_profiles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '档案ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    bio TEXT COMMENT '个人简介',
    website VARCHAR(200) COMMENT '个人网站',
    github_username VARCHAR(50) COMMENT 'GitHub用户名',
    linkedin_url VARCHAR(200) COMMENT 'LinkedIn链接',
    company VARCHAR(100) COMMENT '公司',
    job_title VARCHAR(100) COMMENT '职位',
    education VARCHAR(200) COMMENT '教育背景',
    skills TEXT COMMENT '技能标签',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户档案表';
```

### 4. 权限表 (permissions)

```sql
CREATE TABLE permissions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '权限ID',
    name VARCHAR(100) NOT NULL UNIQUE COMMENT '权限名称',
    display_name VARCHAR(100) NOT NULL COMMENT '权限显示名称',
    description VARCHAR(500) COMMENT '权限描述',
    resource VARCHAR(200) COMMENT '资源路径',
    action VARCHAR(50) COMMENT '操作类型',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_name (name),
    INDEX idx_resource (resource),
    INDEX idx_action (action)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='权限表';
```

### 5. 用户权限关联表 (user_permissions)

```sql
CREATE TABLE user_permissions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '关联ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    permission_id BIGINT NOT NULL COMMENT '权限ID',
    granted_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',
    granted_by BIGINT COMMENT '授权人ID',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES users(id) ON DELETE SET NULL,
    UNIQUE KEY uk_user_permission (user_id, permission_id),
    INDEX idx_user_id (user_id),
    INDEX idx_permission_id (permission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户权限关联表';
```

### 6. 角色表 (roles)

```sql
CREATE TABLE roles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '角色ID',
    name VARCHAR(50) NOT NULL UNIQUE COMMENT '角色名称',
    display_name VARCHAR(100) NOT NULL COMMENT '角色显示名称',
    description VARCHAR(500) COMMENT '角色描述',
    is_system TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否系统角色',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_name (name),
    INDEX idx_is_system (is_system)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色表';
```

### 7. 用户角色关联表 (user_roles)

```sql
CREATE TABLE user_roles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '关联ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    assigned_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
    assigned_by BIGINT COMMENT '分配人ID',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_by) REFERENCES users(id) ON DELETE SET NULL,
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户角色关联表';
```

### 8. 操作日志表 (operation_logs)

```sql
CREATE TABLE operation_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID',
    user_id BIGINT COMMENT '操作用户ID',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    resource_id BIGINT COMMENT '资源ID',
    description VARCHAR(500) COMMENT '操作描述',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    request_method VARCHAR(10) COMMENT '请求方法',
    request_url VARCHAR(500) COMMENT '请求URL',
    response_status INT COMMENT '响应状态码',
    execution_time BIGINT COMMENT '执行时间（毫秒）',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_operation_type (operation_type),
    INDEX idx_resource_type (resource_type),
    INDEX idx_created_at (created_at),
    INDEX idx_ip_address (ip_address)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

## 🗂️ 数据库关系图

```
users (用户表)
├── addresses (地址表) [1:N]
├── user_profiles (用户档案表) [1:1]
├── user_permissions (用户权限关联表) [M:N]
├── user_roles (用户角色关联表) [M:N]
└── operation_logs (操作日志表) [1:N]

permissions (权限表)
└── user_permissions (用户权限关联表) [M:N]

roles (角色表)
└── user_roles (用户角色关联表) [M:N]
```

## 📝 初始化数据脚本

### 1. 插入基础角色数据

```sql
INSERT INTO roles (name, display_name, description, is_system) VALUES
('USER', '普通用户', '系统默认用户角色，拥有基础权限', 1),
('ADMIN', '管理员', '系统管理员，拥有大部分管理权限', 1),
('SUPER_ADMIN', '超级管理员', '超级管理员，拥有所有权限', 1);
```

### 2. 插入基础权限数据

```sql
INSERT INTO permissions (name, display_name, description, resource, action) VALUES
-- 用户管理权限
('USER_READ', '查看用户', '查看用户列表和详情', '/users', 'READ'),
('USER_CREATE', '创建用户', '创建新用户', '/users', 'CREATE'),
('USER_UPDATE', '更新用户', '更新用户信息', '/users', 'UPDATE'),
('USER_DELETE', '删除用户', '删除用户', '/users', 'DELETE'),

-- 角色管理权限
('ROLE_READ', '查看角色', '查看角色列表和详情', '/roles', 'READ'),
('ROLE_CREATE', '创建角色', '创建新角色', '/roles', 'CREATE'),
('ROLE_UPDATE', '更新角色', '更新角色信息', '/roles', 'UPDATE'),
('ROLE_DELETE', '删除角色', '删除角色', '/roles', 'DELETE'),

-- 系统管理权限
('SYSTEM_CONFIG', '系统配置', '修改系统配置', '/system', 'UPDATE'),
('SYSTEM_MONITOR', '系统监控', '查看系统监控信息', '/system', 'READ'),

-- 日志管理权限
('LOG_READ', '查看日志', '查看系统日志', '/logs', 'READ'),
('LOG_DELETE', '删除日志', '删除系统日志', '/logs', 'DELETE');
```

### 3. 创建默认管理员用户

```sql
-- 插入超级管理员用户
INSERT INTO users (username, password, email, full_name, enabled, role) VALUES
('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iYqiSfFDYZt/I5/BFnhkSLsVBDSC', 'admin@example.com', '系统管理员', 1, 'SUPER_ADMIN');

-- 为管理员分配角色
INSERT INTO user_roles (user_id, role_id, assigned_by)
SELECT u.id, r.id, u.id
FROM users u, roles r
WHERE u.username = 'admin' AND r.name = 'SUPER_ADMIN';

-- 为管理员分配所有权限
INSERT INTO user_permissions (user_id, permission_id, granted_by)
SELECT u.id, p.id, u.id
FROM users u, permissions p
WHERE u.username = 'admin';
```

## 🔧 数据库优化建议

### 1. 索引优化

#### 主要查询索引
```sql
-- 用户表索引
CREATE INDEX idx_users_username_email ON users(username, email);
CREATE INDEX idx_users_role_enabled ON users(role, enabled);
CREATE INDEX idx_users_created_at_enabled ON users(created_at, enabled);

-- 地址表索引
CREATE INDEX idx_addresses_user_type ON addresses(user_id, type);
CREATE INDEX idx_addresses_user_default ON addresses(user_id, is_default);

-- 日志表索引
CREATE INDEX idx_operation_logs_user_created ON operation_logs(user_id, created_at);
CREATE INDEX idx_operation_logs_type_created ON operation_logs(operation_type, created_at);
```

#### 复合索引原则
- 经常一起查询的字段建立复合索引
- 将选择性高的字段放在前面
- 避免过多索引影响写入性能

### 2. 表分区策略

```sql
-- 按月分区操作日志表（适用于大量日志数据）
ALTER TABLE operation_logs
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    PARTITION p202403 VALUES LESS THAN (202404),
    -- ... 更多分区
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

### 3. 数据库配置优化

#### MySQL配置建议
```ini
# my.cnf 配置
[mysqld]
# 基础配置
innodb_buffer_pool_size = 1G          # 缓冲池大小（建议为内存的70-80%）
innodb_log_file_size = 256M           # 日志文件大小
innodb_flush_log_at_trx_commit = 2    # 日志刷新策略
innodb_flush_method = O_DIRECT        # 刷新方法

# 查询缓存
query_cache_type = 1                  # 启用查询缓存
query_cache_size = 256M               # 查询缓存大小

# 连接配置
max_connections = 200                 # 最大连接数
max_connect_errors = 1000             # 最大连接错误数

# 字符集配置
character-set-server = utf8mb4        # 服务器字符集
collation-server = utf8mb4_unicode_ci # 排序规则
```

## 🔍 数据库维护

### 1. 定期维护脚本

```sql
-- 分析表统计信息
ANALYZE TABLE users, addresses, user_profiles, permissions, roles;

-- 优化表
OPTIMIZE TABLE users, addresses, operation_logs;

-- 检查表
CHECK TABLE users, addresses, user_profiles;
```

### 2. 数据备份策略

```bash
#!/bin/bash
# 数据库备份脚本

DB_NAME="springweb"
DB_USER="springweb"
DB_PASS="springweb123"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 全量备份
mysqldump -u$DB_USER -p$DB_PASS --single-transaction --routines --triggers $DB_NAME > $BACKUP_DIR/full_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/full_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "full_backup_*.sql.gz" -mtime +7 -delete
```

### 3. 监控查询

```sql
-- 查看表大小
SELECT
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables
WHERE table_schema = 'springweb'
ORDER BY (data_length + index_length) DESC;

-- 查看索引使用情况
SELECT
    table_name,
    index_name,
    cardinality,
    sub_part,
    packed,
    nullable,
    index_type
FROM information_schema.statistics
WHERE table_schema = 'springweb'
ORDER BY table_name, seq_in_index;

-- 查看慢查询
SELECT
    query_time,
    lock_time,
    rows_sent,
    rows_examined,
    sql_text
FROM mysql.slow_log
WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 DAY)
ORDER BY query_time DESC
LIMIT 10;
```

## ✅ 检查点

完成本节学习后，您应该能够：

- [ ] 理解数据库设计原则
- [ ] 设计合理的数据库表结构
- [ ] 编写DDL语句创建表
- [ ] 设计合适的索引策略
- [ ] 了解数据库优化方法

## 🚀 下一步

数据库设计完成后，接下来我们将进入：
[业务层开发 - 创建Service层](../03-业务层开发/01-Service层设计.md)

---

**提示**: 数据库设计是整个系统的基础，良好的设计能够提高系统性能和可维护性。建议在设计阶段充分考虑业务需求和扩展性。