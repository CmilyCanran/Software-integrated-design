# å®ä½“ç±»Entityè®¾è®¡

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- ç†è§£JPAå®ä½“ç±»çš„æ¦‚å¿µå’Œä½œç”¨
- æŒæ¡JPAå¸¸ç”¨æ³¨è§£çš„ä½¿ç”¨
- å­¦ä¼šè®¾è®¡åˆç†çš„å®ä½“ç±»ç»“æ„
- äº†è§£å®ä½“å…³ç³»æ˜ å°„ï¼ˆä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šï¼‰

## ğŸ—ï¸ å®ä½“ç±»åŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å®ä½“ç±»ï¼Ÿ
å®ä½“ç±»ï¼ˆEntityï¼‰æ˜¯æ˜ å°„åˆ°æ•°æ®åº“è¡¨çš„Javaç±»ï¼Œæ¯ä¸ªå®ä½“ç±»å®ä¾‹å¯¹åº”æ•°æ®åº“è¡¨ä¸­çš„ä¸€è¡Œè®°å½•ã€‚

### JPA (Java Persistence API)
JPAæ˜¯JavaæŒä¹…åŒ–APIï¼Œæä¾›äº†ä¸€å¥—æ ‡å‡†çš„ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰è§„èŒƒã€‚

## ğŸ“ åŸºç¡€å®ä½“ç±»è®¾è®¡

### 1. ç”¨æˆ·å®ä½“ç±» (User)

```java
package com.cmliy.springweb.entity;

import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;

import java.time.LocalDateTime;
import java.util.List;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "users")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true, length = 50)
    private String username;

    @Column(nullable = false, length = 100)
    private String password;

    @Column(nullable = false, unique = true, length = 100)
    private String email;

    @Column(name = "full_name", length = 100)
    private String fullName;

    @Column(name = "phone_number", length = 20)
    private String phoneNumber;

    @Enumerated(EnumType.STRING)
    private Gender gender;

    @Temporal(TemporalType.DATE)
    @Column(name = "birth_date")
    private java.util.Date birthDate;

    @Column(name = "avatar_url", length = 255)
    private String avatarUrl;

    @Column(nullable = false)
    private Boolean enabled = true;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Role role = Role.USER;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    // ä¸€å¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªåœ°å€
    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<Address> addresses;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}
```

### 2. åœ°å€å®ä½“ç±» (Address)

```java
package com.cmliy.springweb.entity;

import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "addresses")
public class Address {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, length = 200)
    private String street;

    @Column(nullable = false, length = 100)
    private String city;

    @Column(nullable = false, length = 100)
    private String province;

    @Column(name = "postal_code", length = 20)
    private String postalCode;

    @Column(length = 100)
    private String country = "ä¸­å›½";

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private AddressType type;

    @Column(nullable = false)
    private Boolean isDefault = false;

    // å¤šå¯¹ä¸€å…³ç³»ï¼šå¤šä¸ªåœ°å€å±äºä¸€ä¸ªç”¨æˆ·
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;
}
```

### 3. æšä¸¾ç±»å‹å®šä¹‰

#### æ€§åˆ«æšä¸¾
```java
package com.cmliy.springweb.entity.enums;

public enum Gender {
    MALE("ç”·"),
    FEMALE("å¥³"),
    OTHER("å…¶ä»–");

    private final String displayName;

    Gender(String displayName) {
        this.displayName = displayName;
    }

    public String getDisplayName() {
        return displayName;
    }
}
```

#### ç”¨æˆ·è§’è‰²æšä¸¾
```java
package com.cmliy.springweb.entity.enums;

public enum Role {
    USER("æ™®é€šç”¨æˆ·"),
    ADMIN("ç®¡ç†å‘˜"),
    SUPER_ADMIN("è¶…çº§ç®¡ç†å‘˜");

    private final String displayName;

    Role(String displayName) {
        this.displayName = displayName;
    }

    public String getDisplayName() {
        return displayName;
    }
}
```

#### åœ°å€ç±»å‹æšä¸¾
```java
package com.cmliy.springweb.entity.enums;

public enum AddressType {
    HOME("å®¶åº­åœ°å€"),
    WORK("å·¥ä½œåœ°å€"),
    SHIPPING("æ”¶è´§åœ°å€"),
    BILLING("è´¦å•åœ°å€");

    private final String displayName;

    AddressType(String displayName) {
        this.displayName = displayName;
    }

    public String getDisplayName() {
        return displayName;
    }
}
```

## ğŸ“š JPAæ³¨è§£è¯¦è§£

### 1. ç±»çº§åˆ«æ³¨è§£

#### @Entity
```java
@Entity
public class User {
    // æ ‡è®°è¿™ä¸ªç±»ä¸ºJPAå®ä½“ç±»
}
```

#### @Table
```java
@Entity
@Table(name = "users",
       schema = "public",
       indexes = @Index(name = "idx_username", columnList = "username"))
public class User {
    // æŒ‡å®šæ•°æ®åº“è¡¨åã€æ¨¡å¼ã€ç´¢å¼•ç­‰
}
```

### 2. å­—æ®µçº§åˆ«æ³¨è§£

#### @Id å’Œ @GeneratedValue
```java
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

// ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼š
// IDENTITY - æ•°æ®åº“è‡ªå¢ï¼ˆMySQLæ¨èï¼‰
// SEQUENCE - åºåˆ—ï¼ˆPostgreSQLæ¨èï¼‰
// TABLE - è¡¨ç”Ÿæˆ
// AUTO - è‡ªåŠ¨é€‰æ‹©
```

#### @Column
```java
@Column(name = "user_name",
        nullable = false,
        unique = true,
        length = 50,
        columnDefinition = "VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å'")
private String username;
```

**å¸¸ç”¨å±æ€§**:
- `name`: åˆ—å
- `nullable`: æ˜¯å¦å…è®¸ä¸ºç©º
- `unique`: æ˜¯å¦å”¯ä¸€
- `length`: å­—ç¬¦ä¸²é•¿åº¦
- `columnDefinition`: å®Œæ•´çš„åˆ—å®šä¹‰

#### @Temporal
```java
@Temporal(TemporalType.DATE)    // åªä¿å­˜æ—¥æœŸ
private Date birthDate;

@Temporal(TemporalType.TIME)    // åªä¿å­˜æ—¶é—´
private Date loginTime;

@Temporal(TemporalType.TIMESTAMP) // ä¿å­˜æ—¥æœŸå’Œæ—¶é—´
private Date createdAt;
```

#### @Enumerated
```java
@Enumerated(EnumType.ORDINAL)   // ä¿å­˜æšä¸¾çš„åºå·ï¼ˆé»˜è®¤ï¼‰
private Gender gender;

@Enumerated(EnumType.STRING)    // ä¿å­˜æšä¸¾çš„åç§°ï¼ˆæ¨èï¼‰
private Role role;
```

### 3. å…³ç³»æ˜ å°„æ³¨è§£

#### @OneToOne (ä¸€å¯¹ä¸€)
```java
@OneToOne(fetch = FetchType.LAZY, cascade = CascadeType.ALL)
@JoinColumn(name = "profile_id")
private UserProfile profile;
```

#### @OneToMany (ä¸€å¯¹å¤š)
```java
@OneToMany(mappedBy = "user",
           cascade = CascadeType.ALL,
           fetch = FetchType.LAZY)
private List<Address> addresses;
```

#### @ManyToOne (å¤šå¯¹ä¸€)
```java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "department_id")
private Department department;
```

#### @ManyToMany (å¤šå¯¹å¤š)
```java
@ManyToMany(fetch = FetchType.LAZY)
@JoinTable(name = "user_roles",
           joinColumns = @JoinColumn(name = "user_id"),
           inverseJoinColumns = @JoinColumn(name = "role_id"))
private Set<Role> roles;
```

## ğŸ”„ å®ä½“å…³ç³»æ˜ å°„

### 1. ä¸€å¯¹ä¸€å…³ç³»ç¤ºä¾‹

ç”¨æˆ·æ¡£æ¡ˆæ‰©å±•ä¿¡æ¯ï¼š
```java
@Entity
@Table(name = "user_profiles")
public class UserProfile {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @OneToOne(fetch = FetchType.LAZY)
    @MapsId
    @JoinColumn(name = "id")
    private User user;

    @Column(name = "bio", length = 500)
    private String bio;

    @Column(name = "website", length = 200)
    private String website;

    @Column(name = "github_username", length = 50)
    private String githubUsername;
}
```

### 2. ä¸€å¯¹å¤šå…³ç³»ç¤ºä¾‹

ç”¨æˆ·å’Œè®¢å•çš„å…³ç³»ï¼š
```java
// åœ¨Userå®ä½“ä¸­
@OneToMany(mappedBy = "user",
           cascade = CascadeType.REMOVE,
           fetch = FetchType.LAZY)
private List<Order> orders;

// åœ¨Orderå®ä½“ä¸­
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "user_id", nullable = false)
private User user;
```

### 3. å¤šå¯¹å¤šå…³ç³»ç¤ºä¾‹

ç”¨æˆ·å’Œæƒé™çš„å…³ç³»ï¼š
```java
@Entity
@Table(name = "permissions")
public class Permission {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true, length = 100)
    private String name;

    @Column(length = 200)
    private String description;

    @ManyToMany(mappedBy = "permissions")
    private Set<User> users;
}

// åœ¨Userå®ä½“ä¸­æ·»åŠ 
@ManyToMany(fetch = FetchType.LAZY)
@JoinTable(name = "user_permissions",
           joinColumns = @JoinColumn(name = "user_id"),
           inverseJoinColumns = @JoinColumn(name = "permission_id"))
private Set<Permission> permissions = new HashSet<>();
```

## ğŸ“‹ å®ä½“ç±»ç”Ÿå‘½å‘¨æœŸå›è°ƒ

### ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•
```java
@Entity
public class User {

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
        // åˆ›å»ºå‰æ‰§è¡Œ
    }

    @PostPersist
    protected void afterCreate() {
        // åˆ›å»ºåæ‰§è¡Œ
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
        // æ›´æ–°å‰æ‰§è¡Œ
    }

    @PostUpdate
    protected void afterUpdate() {
        // æ›´æ–°åæ‰§è¡Œ
    }

    @PreRemove
    protected void onDelete() {
        // åˆ é™¤å‰æ‰§è¡Œ
    }

    @PostRemove
    protected void afterDelete() {
        // åˆ é™¤åæ‰§è¡Œ
    }

    @PostLoad
    protected void onLoad() {
        // åŠ è½½åæ‰§è¡Œ
    }
}
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ
- ç±»åï¼šä½¿ç”¨å¸•æ–¯å¡å‘½åæ³•ï¼ˆPascalCaseï¼‰
- å­—æ®µåï¼šä½¿ç”¨é©¼å³°å‘½åæ³•ï¼ˆcamelCaseï¼‰
- æ•°æ®åº“è¡¨åï¼šä½¿ç”¨ä¸‹åˆ’çº¿å‘½åæ³•ï¼ˆsnake_caseï¼‰

### 2. å­—æ®µç±»å‹é€‰æ‹©
```java
// æ¨èä½¿ç”¨åŒ…è£…ç±»å‹ï¼Œå…è®¸nullå€¼
private Long id;           // ä¸æ˜¯long
private Integer age;       // ä¸æ˜¯int
private Boolean enabled;   // ä¸æ˜¯boolean

// æ—¥æœŸæ—¶é—´ç±»å‹
private LocalDateTime createdAt;  // æ¨è
private Date birthDate;           // ä¼ ç»Ÿæ–¹å¼
```

### 3. å…³ç³»æ˜ å°„å»ºè®®
- é»˜è®¤ä½¿ç”¨LAZYåŠ è½½ï¼Œé¿å…N+1é—®é¢˜
- åˆç†ä½¿ç”¨çº§è”æ“ä½œ
- åœ¨"ä¸€"çš„ä¸€æ–¹å®šä¹‰@OneToMany
- åœ¨"å¤š"çš„ä¸€æ–¹å®šä¹‰@ManyToOne

### 4. éªŒè¯æ³¨è§£
```java
@Entity
public class User {

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´")
    private String username;

    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    private String email;

    @Min(value = 18, message = "å¹´é¾„ä¸èƒ½å°äº18å²")
    @Max(value = 120, message = "å¹´é¾„ä¸èƒ½å¤§äº120å²")
    private Integer age;
}
```

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ç†è§£JPAå®ä½“ç±»çš„æ¦‚å¿µ
- [ ] æŒæ¡å¸¸ç”¨JPAæ³¨è§£çš„ä½¿ç”¨
- [ ] è®¾è®¡åˆç†çš„å®ä½“ç±»ç»“æ„
- [ ] ç†è§£å®ä½“å…³ç³»æ˜ å°„
- [ ] ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•

## ğŸš€ ä¸‹ä¸€æ­¥

å®ä½“ç±»è®¾è®¡å®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š
[åˆ›å»ºRepositoryæ¥å£](02-Repositoryå¼€å‘.md)

---

**æç¤º**: å®ä½“ç±»è®¾è®¡æ˜¯æ•°æ®å±‚çš„åŸºç¡€ï¼Œå»ºè®®å…ˆåœ¨çº¸ä¸Šè®¾è®¡å¥½æ•°æ®åº“è¡¨ç»“æ„ï¼Œå†è½¬æ¢ä¸ºå®ä½“ç±»ã€‚