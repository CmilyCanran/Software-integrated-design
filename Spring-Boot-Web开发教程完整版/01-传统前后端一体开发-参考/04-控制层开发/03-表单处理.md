# è¡¨å•å¤„ç†è¯¦è§£

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- æŒæ¡Spring MVCè¡¨å•å¤„ç†æœºåˆ¶
- å­¦ä¼šæ•°æ®ç»‘å®šå’ŒéªŒè¯
- äº†è§£è¡¨å•æ ‡ç­¾åº“çš„ä½¿ç”¨
- æŒæ¡æ–‡ä»¶ä¸Šä¼ å¤„ç†

## ğŸ—ï¸ è¡¨å•å¤„ç†åŸºç¡€æ¦‚å¿µ

### è¡¨å•å¤„ç†æµç¨‹
1. **æ˜¾ç¤ºè¡¨å•**: GETè¯·æ±‚è¿”å›è¡¨å•é¡µé¢
2. **æäº¤è¡¨å•**: POSTè¯·æ±‚æäº¤è¡¨å•æ•°æ®
3. **æ•°æ®éªŒè¯**: éªŒè¯è¡¨å•æ•°æ®çš„åˆæ³•æ€§
4. **å¤„ç†ç»“æœ**: æ ¹æ®éªŒè¯ç»“æœè¿›è¡Œç›¸åº”å¤„ç†

### Spring MVCè¡¨å•å¤„ç†ç»„ä»¶
- **æ•°æ®ç»‘å®š**: è‡ªåŠ¨å°†è¯·æ±‚å‚æ•°ç»‘å®šåˆ°å¯¹è±¡
- **æ•°æ®éªŒè¯**: ä½¿ç”¨éªŒè¯æ³¨è§£è¿›è¡Œæ•°æ®æ ¡éªŒ
- **è¡¨å•æ ‡ç­¾åº“**: ç®€åŒ–è¡¨å•é¡µé¢çš„å¼€å‘
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€å¤„ç†éªŒè¯é”™è¯¯

## ğŸ“ è¡¨å•å¤„ç†å®ç°

### 1. ç”¨æˆ·è¡¨å•æ§åˆ¶å™¨

```java
package com.cmliy.springweb.controller;

import com.cmliy.springweb.dto.*;
import com.cmliy.springweb.service.UserService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

/**
 * ç”¨æˆ·è¡¨å•æ§åˆ¶å™¨
 */
@Slf4j
@Controller
@RequestMapping("/users")
@RequiredArgsConstructor
public class UserFormController {

    private final UserService userService;

    // ==================== è¡¨å•æ˜¾ç¤º ====================

    /**
     * æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·è¡¨å•
     */
    @GetMapping("/new")
    public String showCreateForm(Model model) {
        log.debug("æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·è¡¨å•");

        // æ·»åŠ ç©ºçš„ç”¨æˆ·å¯¹è±¡åˆ°æ¨¡å‹
        model.addAttribute("user", new UserCreateDTO());

        // æ·»åŠ è¡¨å•æ‰€éœ€çš„é€‰é¡¹æ•°æ®
        model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
        model.addAttribute("title", "åˆ›å»ºç”¨æˆ·");
        model.addAttribute("action", "/users");

        return "user/form";
    }

    /**
     * æ˜¾ç¤ºç¼–è¾‘ç”¨æˆ·è¡¨å•
     */
    @GetMapping("/{id}/edit")
    public String showEditForm(@PathVariable Long id, Model model) {
        log.debug("æ˜¾ç¤ºç¼–è¾‘ç”¨æˆ·è¡¨å•: {}", id);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        UserDTO user = userService.getUserById(id)
                .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));

        // è½¬æ¢ä¸ºæ›´æ–°DTO
        UserUpdateDTO updateDTO = new UserUpdateDTO();
        updateDTO.setEmail(user.getEmail());
        updateDTO.setFullName(user.getFullName());
        updateDTO.setPhoneNumber(user.getPhoneNumber());
        updateDTO.setGender(user.getGender());
        updateDTO.setBirthDate(user.getBirthDate());
        updateDTO.setAvatarUrl(user.getAvatarUrl());

        model.addAttribute("user", updateDTO);
        model.addAttribute("userId", id);
        model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
        model.addAttribute("title", "ç¼–è¾‘ç”¨æˆ·");
        model.addAttribute("action", "/users/" + id + "?_method=PUT");

        return "user/form";
    }

    /**
     * æ˜¾ç¤ºå¯†ç ä¿®æ”¹è¡¨å•
     */
    @GetMapping("/{id}/password")
    public String showPasswordForm(@PathVariable Long id, Model model) {
        log.debug("æ˜¾ç¤ºå¯†ç ä¿®æ”¹è¡¨å•: {}", id);

        UserDTO user = userService.getUserById(id)
                .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));

        model.addAttribute("user", user);
        model.addAttribute("passwordForm", new PasswordUpdateDTO());
        model.addAttribute("title", "ä¿®æ”¹å¯†ç ");

        return "user/password";
    }

    // ==================== è¡¨å•æäº¤å¤„ç† ====================

    /**
     * å¤„ç†åˆ›å»ºç”¨æˆ·è¡¨å•æäº¤
     */
    @PostMapping
    public String processCreateForm(
            @Valid @ModelAttribute("user") UserCreateDTO userCreateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("å¤„ç†åˆ›å»ºç”¨æˆ·è¡¨å•: {}", userCreateDTO.getUsername());

        // è‡ªå®šä¹‰éªŒè¯
        if (!userCreateDTO.isPasswordMatching()) {
            bindingResult.rejectValue("confirmPassword", "user.password.mismatch", "ç¡®è®¤å¯†ç ä¸åŒ¹é…");
        }

        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (userService.getUserByUsername(userCreateDTO.getUsername()).isPresent()) {
            bindingResult.rejectValue("username", "user.username.exists", "ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
        if (userService.getUserByEmail(userCreateDTO.getEmail()).isPresent()) {
            bindingResult.rejectValue("email", "user.email.exists", "é‚®ç®±å·²å­˜åœ¨");
        }

        if (bindingResult.hasErrors()) {
            log.warn("è¡¨å•éªŒè¯å¤±è´¥: {}", bindingResult.getAllErrors());

            // é‡æ–°æ·»åŠ è¡¨å•æ‰€éœ€æ•°æ®
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            model.addAttribute("title", "åˆ›å»ºç”¨æˆ·");
            model.addAttribute("action", "/users");

            return "user/form";
        }

        try {
            // åˆ›å»ºç”¨æˆ·
            UserDTO createdUser = userService.createUser(userCreateDTO);

            // æ·»åŠ æˆåŠŸæ¶ˆæ¯
            redirectAttributes.addFlashAttribute("successMessage",
                "ç”¨æˆ· \"" + createdUser.getUsername() + "\" åˆ›å»ºæˆåŠŸ");

            // é‡å®šå‘åˆ°ç”¨æˆ·è¯¦æƒ…é¡µ
            return "redirect:/users/" + createdUser.getId();

        } catch (Exception e) {
            log.error("åˆ›å»ºç”¨æˆ·å¤±è´¥", e);

            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            model.addAttribute("errorMessage", "åˆ›å»ºç”¨æˆ·å¤±è´¥: " + e.getMessage());
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            model.addAttribute("title", "åˆ›å»ºç”¨æˆ·");
            model.addAttribute("action", "/users");

            return "user/form";
        }
    }

    /**
     * å¤„ç†ç¼–è¾‘ç”¨æˆ·è¡¨å•æäº¤
     */
    @PutMapping("/{id}")
    public String processEditForm(
            @PathVariable Long id,
            @Valid @ModelAttribute("user") UserUpdateDTO userUpdateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("å¤„ç†ç¼–è¾‘ç”¨æˆ·è¡¨å•: {}", id);

        // æ£€æŸ¥é‚®ç®±æ˜¯å¦è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
        UserDTO currentUser = userService.getUserById(id)
                .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));

        if (!currentUser.getEmail().equals(userUpdateDTO.getEmail())) {
            if (userService.getUserByEmail(userUpdateDTO.getEmail()).isPresent()) {
                bindingResult.rejectValue("email", "user.email.exists", "é‚®ç®±å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨");
            }
        }

        if (bindingResult.hasErrors()) {
            log.warn("è¡¨å•éªŒè¯å¤±è´¥: {}", bindingResult.getAllErrors());

            model.addAttribute("userId", id);
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            model.addAttribute("title", "ç¼–è¾‘ç”¨æˆ·");
            model.addAttribute("action", "/users/" + id + "?_method=PUT");

            return "user/form";
        }

        try {
            // æ›´æ–°ç”¨æˆ·
            UserDTO updatedUser = userService.updateUser(id, userUpdateDTO);

            redirectAttributes.addFlashAttribute("successMessage",
                "ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ");

            return "redirect:/users/" + updatedUser.getId();

        } catch (Exception e) {
            log.error("æ›´æ–°ç”¨æˆ·å¤±è´¥", e);

            model.addAttribute("errorMessage", "æ›´æ–°ç”¨æˆ·å¤±è´¥: " + e.getMessage());
            model.addAttribute("userId", id);
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            model.addAttribute("title", "ç¼–è¾‘ç”¨æˆ·");
            model.addAttribute("action", "/users/" + id + "?_method=PUT");

            return "user/form";
        }
    }

    /**
     * å¤„ç†å¯†ç ä¿®æ”¹è¡¨å•æäº¤
     */
    @PutMapping("/{id}/password")
    public String processPasswordForm(
            @PathVariable Long id,
            @Valid @ModelAttribute("passwordForm") PasswordUpdateDTO passwordUpdateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("å¤„ç†å¯†ç ä¿®æ”¹è¡¨å•: {}", id);

        // è‡ªå®šä¹‰éªŒè¯
        if (!passwordUpdateDTO.isNewPasswordMatching()) {
            bindingResult.rejectValue("confirmPassword", "password.mismatch", "ç¡®è®¤å¯†ç ä¸åŒ¹é…");
        }

        if (bindingResult.hasErrors()) {
            log.warn("å¯†ç è¡¨å•éªŒè¯å¤±è´¥: {}", bindingResult.getAllErrors());

            UserDTO user = userService.getUserById(id).orElse(null);
            model.addAttribute("user", user);
            model.addAttribute("title", "ä¿®æ”¹å¯†ç ");

            return "user/password";
        }

        try {
            // ä¿®æ”¹å¯†ç 
            userService.changePassword(id,
                passwordUpdateDTO.getCurrentPassword(),
                passwordUpdateDTO.getNewPassword());

            redirectAttributes.addFlashAttribute("successMessage", "å¯†ç ä¿®æ”¹æˆåŠŸ");

            return "redirect:/users/" + id;

        } catch (Exception e) {
            log.error("ä¿®æ”¹å¯†ç å¤±è´¥", e);

            model.addAttribute("errorMessage", "ä¿®æ”¹å¯†ç å¤±è´¥: " + e.getMessage());
            UserDTO user = userService.getUserById(id).orElse(null);
            model.addAttribute("user", user);
            model.addAttribute("title", "ä¿®æ”¹å¯†ç ");

            return "user/password";
        }
    }

    // ==================== AJAXè¡¨å•å¤„ç† ====================

    /**
     * AJAXéªŒè¯ç”¨æˆ·å
     */
    @GetMapping("/check-username")
    @ResponseBody
    public ResponseEntity<ValidationResult> checkUsername(@RequestParam String username) {
        log.debug("æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§: {}", username);

        boolean available = !userService.getUserByUsername(username).isPresent();

        ValidationResult result = ValidationResult.builder()
                .valid(available)
                .message(available ? "ç”¨æˆ·åå¯ç”¨" : "ç”¨æˆ·åå·²å­˜åœ¨")
                .build();

        return ResponseEntity.ok(result);
    }

    /**
     * AJAXéªŒè¯é‚®ç®±
     */
    @GetMapping("/check-email")
    @ResponseBody
    public ResponseEntity<ValidationResult> checkEmail(
            @RequestParam String email,
            @RequestParam(required = false) Long excludeId) {

        log.debug("æ£€æŸ¥é‚®ç®±å¯ç”¨æ€§: {}, excludeId={}", email, excludeId);

        Optional<UserDTO> existingUser = userService.getUserByEmail(email);
        boolean available = existingUser.isEmpty() ||
                           (excludeId != null && existingUser.get().getId().equals(excludeId));

        ValidationResult result = ValidationResult.builder()
                .valid(available)
                .message(available ? "é‚®ç®±å¯ç”¨" : "é‚®ç®±å·²è¢«ä½¿ç”¨")
                .build();

        return ResponseEntity.ok(result);
    }
}
```

### 2. åœ°å€è¡¨å•æ§åˆ¶å™¨

```java
package com.cmliy.springweb.controller;

import com.cmliy.springweb.dto.AddressCreateDTO;
import com.cmliy.springweb.dto.AddressDTO;
import com.cmliy.springweb.dto.AddressUpdateDTO;
import com.cmliy.springweb.entity.enums.AddressType;
import com.cmliy.springweb.service.AddressService;
import com.cmliy.springweb.service.UserService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

/**
 * åœ°å€è¡¨å•æ§åˆ¶å™¨
 */
@Slf4j
@Controller
@RequestMapping("/addresses")
@RequiredArgsConstructor
public class AddressFormController {

    private final AddressService addressService;
    private final UserService userService;

    /**
     * æ˜¾ç¤ºåˆ›å»ºåœ°å€è¡¨å•
     */
    @GetMapping("/new")
    public String showCreateForm(
            @RequestParam Long userId,
            Model model) {

        log.debug("æ˜¾ç¤ºåˆ›å»ºåœ°å€è¡¨å•: userId={}", userId);

        // éªŒè¯ç”¨æˆ·å­˜åœ¨
        UserDTO user = userService.getUserById(userId)
                .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));

        AddressCreateDTO addressCreateDTO = new AddressCreateDTO();
        addressCreateDTO.setUserId(userId);

        model.addAttribute("address", addressCreateDTO);
        model.addAttribute("user", user);
        model.addAttribute("addressTypes", AddressType.values());
        model.addAttribute("title", "æ·»åŠ åœ°å€");
        model.addAttribute("action", "/addresses");

        return "address/form";
    }

    /**
     * å¤„ç†åˆ›å»ºåœ°å€è¡¨å•æäº¤
     */
    @PostMapping
    public String processCreateForm(
            @Valid @ModelAttribute("address") AddressCreateDTO addressCreateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("å¤„ç†åˆ›å»ºåœ°å€è¡¨å•: userId={}", addressCreateDTO.getUserId());

        // éªŒè¯ç”¨æˆ·å­˜åœ¨
        UserDTO user = userService.getUserById(addressCreateDTO.getUserId())
                .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨: " + addressCreateDTO.getUserId()));

        if (bindingResult.hasErrors()) {
            model.addAttribute("user", user);
            model.addAttribute("addressTypes", AddressType.values());
            model.addAttribute("title", "æ·»åŠ åœ°å€");
            model.addAttribute("action", "/addresses");
            return "address/form";
        }

        try {
            AddressDTO createdAddress = addressService.createAddress(addressCreateDTO);

            redirectAttributes.addFlashAttribute("successMessage", "åœ°å€æ·»åŠ æˆåŠŸ");
            return "redirect:/users/" + addressCreateDTO.getUserId();

        } catch (Exception e) {
            log.error("åˆ›å»ºåœ°å€å¤±è´¥", e);

            model.addAttribute("errorMessage", "åˆ›å»ºåœ°å€å¤±è´¥: " + e.getMessage());
            model.addAttribute("user", user);
            model.addAttribute("addressTypes", AddressType.values());
            model.addAttribute("title", "æ·»åŠ åœ°å€");
            model.addAttribute("action", "/addresses");
            return "address/form";
        }
    }

    /**
     * æ˜¾ç¤ºç¼–è¾‘åœ°å€è¡¨å•
     */
    @GetMapping("/{id}/edit")
    public String showEditForm(@PathVariable Long id, Model model) {
        log.debug("æ˜¾ç¤ºç¼–è¾‘åœ°å€è¡¨å•: {}", id);

        AddressDTO address = addressService.getAddressById(id)
                .orElseThrow(() -> new RuntimeException("åœ°å€ä¸å­˜åœ¨: " + id));

        AddressUpdateDTO updateDTO = new AddressUpdateDTO();
        updateDTO.setStreet(address.getStreet());
        updateDTO.setCity(address.getCity());
        updateDTO.setProvince(address.getProvince());
        updateDTO.setPostalCode(address.getPostalCode());
        updateDTO.setCountry(address.getCountry());
        updateDTO.setType(address.getType());
        updateDTO.setIsDefault(address.getIsDefault());

        model.addAttribute("address", updateDTO);
        model.addAttribute("addressId", id);
        model.addAttribute("addressTypes", AddressType.values());
        model.addAttribute("title", "ç¼–è¾‘åœ°å€");
        model.addAttribute("action", "/addresses/" + id + "?_method=PUT");

        return "address/form";
    }

    /**
     * å¤„ç†ç¼–è¾‘åœ°å€è¡¨å•æäº¤
     */
    @PutMapping("/{id}")
    public String processEditForm(
            @PathVariable Long id,
            @Valid @ModelAttribute("address") AddressUpdateDTO addressUpdateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("å¤„ç†ç¼–è¾‘åœ°å€è¡¨å•: {}", id);

        if (bindingResult.hasErrors()) {
            model.addAttribute("addressId", id);
            model.addAttribute("addressTypes", AddressType.values());
            model.addAttribute("title", "ç¼–è¾‘åœ°å€");
            model.addAttribute("action", "/addresses/" + id + "?_method=PUT");
            return "address/form";
        }

        try {
            AddressDTO updatedAddress = addressService.updateAddress(id, addressUpdateDTO);

            redirectAttributes.addFlashAttribute("successMessage", "åœ°å€æ›´æ–°æˆåŠŸ");
            return "redirect:/users/" + updatedAddress.getUserId();

        } catch (Exception e) {
            log.error("æ›´æ–°åœ°å€å¤±è´¥", e);

            model.addAttribute("errorMessage", "æ›´æ–°åœ°å€å¤±è´¥: " + e.getMessage());
            model.addAttribute("addressId", id);
            model.addAttribute("addressTypes", AddressType.values());
            model.addAttribute("title", "ç¼–è¾‘åœ°å€");
            model.addAttribute("action", "/addresses/" + id + "?_method=PUT");
            return "address/form";
        }
    }
}
```

## ğŸ¨ Thymeleafè¡¨å•é¡µé¢

### 1. ç”¨æˆ·è¡¨å•é¡µé¢

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
    <title th:text="${title}">ç”¨æˆ·è¡¨å•</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // å®æ—¶éªŒè¯ç”¨æˆ·å
            $('#username').on('blur', function() {
                var username = $(this).val();
                if (username.length >= 3) {
                    $.get('/users/check-username', {username: username}, function(result) {
                        if (result.valid) {
                            $('#username-feedback').removeClass('invalid-feedback').addClass('valid-feedback').text(result.message);
                            $('#username').removeClass('is-invalid').addClass('is-valid');
                        } else {
                            $('#username-feedback').removeClass('valid-feedback').addClass('invalid-feedback').text(result.message);
                            $('#username').removeClass('is-valid').addClass('is-invalid');
                        }
                    });
                }
            });

            // å®æ—¶éªŒè¯é‚®ç®±
            $('#email').on('blur', function() {
                var email = $(this).val();
                var excludeId = $('#userId').val();
                if (email) {
                    $.get('/users/check-email', {email: email, excludeId: excludeId}, function(result) {
                        if (result.valid) {
                            $('#email-feedback').removeClass('invalid-feedback').addClass('valid-feedback').text(result.message);
                            $('#email').removeClass('is-invalid').addClass('is-valid');
                        } else {
                            $('#email-feedback').removeClass('valid-feedback').addClass('invalid-feedback').text(result.message);
                            $('#email').removeClass('is-valid').addClass('is-invalid');
                        }
                    });
                }
            });

            // å¯†ç ç¡®è®¤éªŒè¯
            $('#confirmPassword').on('input', function() {
                var password = $('#password').val();
                var confirmPassword = $(this).val();

                if (password === confirmPassword) {
                    $('#confirmPassword-feedback').removeClass('invalid-feedback').addClass('valid-feedback').text('å¯†ç åŒ¹é…');
                    $('#confirmPassword').removeClass('is-invalid').addClass('is-valid');
                } else {
                    $('#confirmPassword-feedback').removeClass('valid-feedback').addClass('invalid-feedback').text('å¯†ç ä¸åŒ¹é…');
                    $('#confirmPassword').removeClass('is-valid').addClass('is-invalid');
                }
            });
        });
    </script>
</head>

<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 th:text="${title}">ç”¨æˆ·è¡¨å•</h3>
                    </div>
                    <div class="card-body">

                        <!-- æˆåŠŸæ¶ˆæ¯ -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- é”™è¯¯æ¶ˆæ¯ -->
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <form th:action="${action}" method="post" th:object="${user}" novalidate>
                            <!-- éšè—å­—æ®µ -->
                            <input type="hidden" th:if="${userId}" th:field="*{id}" id="userId">

                            <!-- ç”¨æˆ·å -->
                            <div class="mb-3">
                                <label for="username" class="form-label">ç”¨æˆ·å *</label>
                                <input type="text" class="form-control" th:field="*{username}" id="username"
                                       th:classappend="${#fields.hasErrors('username')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                                <div th:if="${#fields.hasErrors('username')}" class="invalid-feedback">
                                    <span th:errors="*{username}"></span>
                                </div>
                                <div id="username-feedback"></div>
                                <small class="form-text text-muted">ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</small>
                            </div>

                            <!-- å¯†ç ï¼ˆä»…åˆ›å»ºæ—¶æ˜¾ç¤ºï¼‰ -->
                            <div th:if="${user.class.name.contains('CreateDTO')}" class="mb-3">
                                <label for="password" class="form-label">å¯†ç  *</label>
                                <input type="password" class="form-control" th:field="*{password}" id="password"
                                       th:classappend="${#fields.hasErrors('password')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥å¯†ç ">
                                <div th:if="${#fields.hasErrors('password')}" class="invalid-feedback">
                                    <span th:errors="*{password}"></span>
                                </div>
                                <small class="form-text text-muted">å¯†ç é•¿åº¦6-20ä½</small>
                            </div>

                            <!-- ç¡®è®¤å¯†ç ï¼ˆä»…åˆ›å»ºæ—¶æ˜¾ç¤ºï¼‰ -->
                            <div th:if="${user.class.name.contains('CreateDTO')}" class="mb-3">
                                <label for="confirmPassword" class="form-label">ç¡®è®¤å¯†ç  *</label>
                                <input type="password" class="form-control" th:field="*{confirmPassword}" id="confirmPassword"
                                       th:classappend="${#fields.hasErrors('confirmPassword')} ? 'is-invalid' : ''"
                                       placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                                <div th:if="${#fields.hasErrors('confirmPassword')}" class="invalid-feedback">
                                    <span th:errors="*{confirmPassword}"></span>
                                </div>
                                <div id="confirmPassword-feedback"></div>
                            </div>

                            <!-- é‚®ç®± -->
                            <div class="mb-3">
                                <label for="email" class="form-label">é‚®ç®± *</label>
                                <input type="email" class="form-control" th:field="*{email}" id="email"
                                       th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
                                <div th:if="${#fields.hasErrors('email')}" class="invalid-feedback">
                                    <span th:errors="*{email}"></span>
                                </div>
                                <div id="email-feedback"></div>
                            </div>

                            <!-- å…¨å -->
                            <div class="mb-3">
                                <label for="fullName" class="form-label">å…¨å</label>
                                <input type="text" class="form-control" th:field="*{fullName}" id="fullName"
                                       th:classappend="${#fields.hasErrors('fullName')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                                <div th:if="${#fields.hasErrors('fullName')}" class="invalid-feedback">
                                    <span th:errors="*{fullName}"></span>
                                </div>
                            </div>

                            <!-- æ‰‹æœºå· -->
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">æ‰‹æœºå·</label>
                                <input type="tel" class="form-control" th:field="*{phoneNumber}" id="phoneNumber"
                                       th:classappend="${#fields.hasErrors('phoneNumber')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                                <div th:if="${#fields.hasErrors('phoneNumber')}" class="invalid-feedback">
                                    <span th:errors="*{phoneNumber}"></span>
                                </div>
                            </div>

                            <!-- æ€§åˆ« -->
                            <div class="mb-3">
                                <label class="form-label">æ€§åˆ«</label>
                                <div th:each="gender : ${genders}" class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" th:field="*{gender}"
                                           th:value="${gender}" th:id="'gender-' + ${gender.name()}">
                                    <label class="form-check-label" th:for="'gender-' + ${gender.name()}"
                                           th:text="${gender.displayName}">æ€§åˆ«</label>
                                </div>
                                <div th:if="${#fields.hasErrors('gender')}" class="invalid-feedback">
                                    <span th:errors="*{gender}"></span>
                                </div>
                            </div>

                            <!-- å‡ºç”Ÿæ—¥æœŸ -->
                            <div class="mb-3">
                                <label for="birthDate" class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                                <input type="date" class="form-control" th:field="*{birthDate}" id="birthDate"
                                       th:classappend="${#fields.hasErrors('birthDate')} ? 'is-invalid' : ''">
                                <div th:if="${#fields.hasErrors('birthDate')}" class="invalid-feedback">
                                    <span th:errors="*{birthDate}"></span>
                                </div>
                            </div>

                            <!-- å¤´åƒURL -->
                            <div class="mb-3">
                                <label for="avatarUrl" class="form-label">å¤´åƒURL</label>
                                <input type="url" class="form-control" th:field="*{avatarUrl}" id="avatarUrl"
                                       th:classappend="${#fields.hasErrors('avatarUrl')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥å¤´åƒå›¾ç‰‡URL">
                                <div th:if="${#fields.hasErrors('avatarUrl')}" class="invalid-feedback">
                                    <span th:errors="*{avatarUrl}"></span>
                                </div>
                            </div>

                            <!-- æäº¤æŒ‰é’® -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a th:href="'/users' + ${userId != null ? '/' + userId : ''}"
                                   class="btn btn-secondary me-md-2">å–æ¶ˆ</a>
                                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
```

### 2. å¯†ç ä¿®æ”¹è¡¨å•é¡µé¢

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
    <title th:text="${title}">ä¿®æ”¹å¯†ç </title>
    <script>
        $(document).ready(function() {
            // å¯†ç å¼ºåº¦æ£€æµ‹
            $('#newPassword').on('input', function() {
                var password = $(this).val();
                var strength = checkPasswordStrength(password);
                updatePasswordStrength(strength);
            });

            // å¯†ç ç¡®è®¤éªŒè¯
            $('#confirmPassword').on('input', function() {
                var newPassword = $('#newPassword').val();
                var confirmPassword = $(this).val();

                if (newPassword === confirmPassword && confirmPassword) {
                    $('#confirmPassword-feedback').removeClass('invalid-feedback').addClass('valid-feedback').text('å¯†ç åŒ¹é…');
                    $('#confirmPassword').removeClass('is-invalid').addClass('is-valid');
                } else {
                    $('#confirmPassword-feedback').removeClass('valid-feedback').addClass('invalid-feedback').text('å¯†ç ä¸åŒ¹é…');
                    $('#confirmPassword').removeClass('is-valid').addClass('is-invalid');
                }
            });
        });

        function checkPasswordStrength(password) {
            var strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]+/)) strength++;
            if (password.match(/[A-Z]+/)) strength++;
            if (password.match(/[0-9]+/)) strength++;
            if (password.match(/[$@#&!]+/)) strength++;
            return strength;
        }

        function updatePasswordStrength(strength) {
            var $strengthBar = $('#password-strength');
            var $strengthText = $('#password-strength-text');

            $strengthBar.removeClass().addClass('progress-bar');

            switch(strength) {
                case 0:
                case 1:
                    $strengthBar.addClass('bg-danger').css('width', '20%');
                    $strengthText.text('å¼±').removeClass().addClass('text-danger');
                    break;
                case 2:
                    $strengthBar.addClass('bg-warning').css('width', '40%');
                    $strengthText.text('è¾ƒå¼±').removeClass().addClass('text-warning');
                    break;
                case 3:
                    $strengthBar.addClass('bg-info').css('width', '60%');
                    $strengthText.text('ä¸­ç­‰').removeClass().addClass('text-info');
                    break;
                case 4:
                    $strengthBar.addClass('bg-primary').css('width', '80%');
                    $strengthText.text('è¾ƒå¼º').removeClass().addClass('text-primary');
                    break;
                case 5:
                    $strengthBar.addClass('bg-success').css('width', '100%');
                    $strengthText.text('å¼º').removeClass().addClass('text-success');
                    break;
            }
        }
    </script>
</head>

<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 th:text="${title}">ä¿®æ”¹å¯†ç </h3>
                    </div>
                    <div class="card-body">

                        <!-- æˆåŠŸæ¶ˆæ¯ -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- é”™è¯¯æ¶ˆæ¯ -->
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <form th:action="@{'/users/' + ${user.id} + '/password'}" method="post"
                              th:object="${passwordForm}" novalidate>

                            <!-- å½“å‰å¯†ç  -->
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">å½“å‰å¯†ç  *</label>
                                <input type="password" class="form-control" th:field="*{currentPassword}" id="currentPassword"
                                       th:classappend="${#fields.hasErrors('currentPassword')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
                                <div th:if="${#fields.hasErrors('currentPassword')}" class="invalid-feedback">
                                    <span th:errors="*{currentPassword}"></span>
                                </div>
                            </div>

                            <!-- æ–°å¯†ç  -->
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">æ–°å¯†ç  *</label>
                                <input type="password" class="form-control" th:field="*{newPassword}" id="newPassword"
                                       th:classappend="${#fields.hasErrors('newPassword')} ? 'is-invalid' : ''"
                                       placeholder="è¯·è¾“å…¥æ–°å¯†ç " required>
                                <div th:if="${#fields.hasErrors('newPassword')}" class="invalid-feedback">
                                    <span th:errors="*{newPassword}"></span>
                                </div>

                                <!-- å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ -->
                                <div class="mt-2">
                                    <div class="progress" style="height: 5px;">
                                        <div id="password-strength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="password-strength-text" class="form-text text-muted">å¯†ç å¼ºåº¦</small>
                                </div>

                                <small class="form-text text-muted">
                                    å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦6-20ä½
                                </small>
                            </div>

                            <!-- ç¡®è®¤æ–°å¯†ç  -->
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç  *</label>
                                <input type="password" class="form-control" th:field="*{confirmPassword}" id="confirmPassword"
                                       th:classappend="${#fields.hasErrors('confirmPassword')} ? 'is-invalid' : ''"
                                       placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                                <div th:if="${#fields.hasErrors('confirmPassword')}" class="invalid-feedback">
                                    <span th:errors="*{confirmPassword}"></span>
                                </div>
                                <div id="confirmPassword-feedback"></div>
                            </div>

                            <!-- æäº¤æŒ‰é’® -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a th:href="@{'/users/' + ${user.id}}" class="btn btn-secondary me-md-2">å–æ¶ˆ</a>
                                <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
```

## ğŸ“ æ–‡ä»¶ä¸Šä¼ å¤„ç†

### 1. æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™¨

```java
package com.cmliy.springweb.controller;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.UUID;

/**
 * æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™¨
 */
@Slf4j
@Controller
@RequestMapping("/upload")
public class FileUploadController {

    private final String UPLOAD_DIR = "uploads/";

    /**
     * æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ è¡¨å•
     */
    @GetMapping
    public String showUploadForm(Model model) {
        return "upload/form";
    }

    /**
     * å¤„ç†æ–‡ä»¶ä¸Šä¼ 
     */
    @PostMapping
    public String handleFileUpload(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "description", required = false) String description,
            RedirectAttributes redirectAttributes) {

        log.info("å¤„ç†æ–‡ä»¶ä¸Šä¼ : {}, å¤§å°: {}", file.getOriginalFilename(), file.getSize());

        if (file.isEmpty()) {
            redirectAttributes.addFlashAttribute("errorMessage", "è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶");
            return "redirect:/upload";
        }

        try {
            // åˆ›å»ºä¸Šä¼ ç›®å½•
            Path uploadPath = Paths.get(UPLOAD_DIR);
            if (!Files.exists(uploadPath)) {
                Files.createDirectories(uploadPath);
            }

            // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
            String originalFilename = file.getOriginalFilename();
            String extension = originalFilename.substring(originalFilename.lastIndexOf("."));
            String newFilename = UUID.randomUUID().toString() + extension;

            // ä¿å­˜æ–‡ä»¶
            Path filePath = uploadPath.resolve(newFilename);
            Files.copy(file.getInputStream(), filePath);

            // è¿”å›æˆåŠŸæ¶ˆæ¯
            redirectAttributes.addFlashAttribute("successMessage",
                "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: " + originalFilename);
            redirectAttributes.addFlashAttribute("filename", newFilename);
            redirectAttributes.addFlashAttribute("description", description);

            return "redirect:/upload";

        } catch (IOException e) {
            log.error("æ–‡ä»¶ä¸Šä¼ å¤±è´¥", e);
            redirectAttributes.addFlashAttribute("errorMessage", "æ–‡ä»¶ä¸Šä¼ å¤±è´¥: " + e.getMessage());
            return "redirect:/upload";
        }
    }

    /**
     * AJAXæ–‡ä»¶ä¸Šä¼ 
     */
    @PostMapping("/ajax")
    @ResponseBody
    public ResponseEntity<UploadResult> handleAjaxFileUpload(
            @RequestParam("file") MultipartFile file) {

        log.info("å¤„ç†AJAXæ–‡ä»¶ä¸Šä¼ : {}", file.getOriginalFilename());

        try {
            if (file.isEmpty()) {
                return ResponseEntity.badRequest()
                        .body(UploadResult.failure("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶"));
            }

            // æ–‡ä»¶éªŒè¯
            if (!isAllowedFileType(file.getOriginalFilename())) {
                return ResponseEntity.badRequest()
                        .body(UploadResult.failure("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹"));
            }

            if (file.getSize() > 10 * 1024 * 1024) { // 10MBé™åˆ¶
                return ResponseEntity.badRequest()
                        .body(UploadResult.failure("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB"));
            }

            // ä¿å­˜æ–‡ä»¶é€»è¾‘...
            String savedFilename = saveFile(file);

            return ResponseEntity.ok(UploadResult.success(savedFilename));

        } catch (Exception e) {
            log.error("AJAXæ–‡ä»¶ä¸Šä¼ å¤±è´¥", e);
            return ResponseEntity.internalServerError()
                    .body(UploadResult.failure("ä¸Šä¼ å¤±è´¥: " + e.getMessage()));
        }
    }

    private boolean isAllowedFileType(String filename) {
        String[] allowedExtensions = {".jpg", ".jpeg", ".png", ".gif", ".pdf", ".doc", ".docx"};
        for (String ext : allowedExtensions) {
            if (filename.toLowerCase().endsWith(ext)) {
                return true;
            }
        }
        return false;
    }

    private String saveFile(MultipartFile file) throws IOException {
        // å®ç°æ–‡ä»¶ä¿å­˜é€»è¾‘
        return UUID.randomUUID().toString();
    }
}
```

### 2. æ–‡ä»¶ä¸Šä¼ è¡¨å•é¡µé¢

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>æ–‡ä»¶ä¸Šä¼ </title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <!-- æ™®é€šè¡¨å•ä¸Šä¼  -->
                <form method="post" enctype="multipart/form-data" th:action="@{/upload}">
                    <div class="mb-3">
                        <label for="file" class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">ä¸Šä¼ </button>
                </form>
            </div>

            <div class="col-md-6">
                <!-- AJAXä¸Šä¼  -->
                <h4>AJAXä¸Šä¼ </h4>
                <form id="ajaxUploadForm">
                    <div class="mb-3">
                        <label for="ajaxFile" class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                        <input type="file" class="form-control" id="ajaxFile" name="file">
                        <div class="progress mt-2" id="uploadProgress" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-success" onclick="uploadFile()">AJAXä¸Šä¼ </button>
                </form>

                <div id="uploadResult"></div>
            </div>
        </div>
    </div>

    <script>
        function uploadFile() {
            var fileInput = document.getElementById('ajaxFile');
            var file = fileInput.files[0];

            if (!file) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            var formData = new FormData();
            formData.append('file', file);

            // æ˜¾ç¤ºè¿›åº¦æ¡
            $('#uploadProgress').show();

            $.ajax({
                url: '/upload/ajax',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function(evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total * 100;
                            $('.progress-bar').css('width', percentComplete + '%');
                        }
                    }, false);
                    return xhr;
                },
                success: function(result) {
                    if (result.success) {
                        $('#uploadResult').html('<div class="alert alert-success">ä¸Šä¼ æˆåŠŸ: ' + result.filename + '</div>');
                    } else {
                        $('#uploadResult').html('<div class="alert alert-danger">ä¸Šä¼ å¤±è´¥: ' + result.message + '</div>');
                    }
                    $('#uploadProgress').hide();
                },
                error: function() {
                    $('#uploadResult').html('<div class="alert alert-danger">ä¸Šä¼ å¤±è´¥</div>');
                    $('#uploadProgress').hide();
                }
            });
        }
    </script>
</body>
</html>
```

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] æŒæ¡Spring MVCè¡¨å•å¤„ç†æœºåˆ¶
- [ ] å®ç°æ•°æ®ç»‘å®šå’ŒéªŒè¯
- [ ] ä½¿ç”¨Thymeleafè¡¨å•æ ‡ç­¾åº“
- [ ] å¤„ç†AJAXè¡¨å•æäº¤
- [ ] å®ç°æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½

## ğŸš€ ä¸‹ä¸€æ­¥

è¡¨å•å¤„ç†å­¦ä¹ å®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›å…¥ï¼š
[å‰ç«¯é¡µé¢å¼€å‘ - ThymeleafåŸºç¡€](../05-å‰ç«¯é¡µé¢å¼€å‘/01-ThymeleafåŸºç¡€.md)

---

**æç¤º**: è‰¯å¥½çš„è¡¨å•å¤„ç†åº”è¯¥åŒ…å«å®Œå–„çš„æ•°æ®éªŒè¯ã€å‹å¥½çš„é”™è¯¯æç¤ºå’Œæµç•…çš„ç”¨æˆ·ä½“éªŒã€‚