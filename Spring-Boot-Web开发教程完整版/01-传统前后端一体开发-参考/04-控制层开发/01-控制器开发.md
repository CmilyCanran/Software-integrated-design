# æ§åˆ¶å™¨å¼€å‘è¯¦è§£

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- ç†è§£Controllerå±‚çš„ä½œç”¨å’ŒèŒè´£
- æŒæ¡Spring MVCå¸¸ç”¨æ³¨è§£çš„ä½¿ç”¨
- å­¦ä¼šå¤„ç†HTTPè¯·æ±‚å’Œå“åº”
- äº†è§£æ§åˆ¶å™¨çš„è®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µ

## ğŸ—ï¸ ControlleråŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯Controllerï¼Ÿ
Controlleræ˜¯æ§åˆ¶å±‚ï¼Œè´Ÿè´£å¤„ç†HTTPè¯·æ±‚ï¼Œè°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶è¿”å›å“åº”ç»“æœã€‚å®ƒæ˜¯Webåº”ç”¨çš„å…¥å£ç‚¹ã€‚

### Controllerçš„èŒè´£
- **è¯·æ±‚å¤„ç†**: æ¥æ”¶å’Œè§£æHTTPè¯·æ±‚
- **å‚æ•°ç»‘å®š**: å°†è¯·æ±‚å‚æ•°ç»‘å®šåˆ°æ–¹æ³•å‚æ•°
- **ä¸šåŠ¡è°ƒç”¨**: è°ƒç”¨Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
- **å“åº”æ„å»º**: æ„å»ºå¹¶è¿”å›HTTPå“åº”
- **å¼‚å¸¸å¤„ç†**: å¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­çš„å¼‚å¸¸

## ğŸ“ æ§åˆ¶å™¨åŸºç¡€å®ç°

### 1. ç”¨æˆ·æ§åˆ¶å™¨ (UserController)

```java
package com.cmliy.springweb.controller;

import com.cmliy.springweb.dto.*;
import com.cmliy.springweb.service.UserService;
import com.cmliy.springweb.service.AddressService;
import com.cmliy.springweb.exception.UserNotFoundException;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import java.util.List;

/**
 * ç”¨æˆ·æ§åˆ¶å™¨
 * æä¾›ç”¨æˆ·ç›¸å…³çš„Webé¡µé¢å’ŒAPIæ¥å£
 */
@Slf4j
@Controller
@RequiredArgsConstructor
@RequestMapping("/users")
public class UserController {

    private final UserService userService;
    private final AddressService addressService;

    // ==================== é¡µé¢è·¯ç”± ====================

    /**
     * ç”¨æˆ·åˆ—è¡¨é¡µé¢
     */
    @GetMapping
    public String listUsers(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String sortDir,
            @RequestParam(required = false) String keyword,
            Model model) {

        log.debug("è®¿é—®ç”¨æˆ·åˆ—è¡¨é¡µé¢: page={}, size={}, keyword={}", page, size, keyword);

        // æ„å»ºåˆ†é¡µå‚æ•°
        Sort sort = sortDir.equalsIgnoreCase("desc") ?
            Sort.by(sortBy).descending() : Sort.by(sortBy).ascending();
        Pageable pageable = PageRequest.of(page, size, sort);

        Page<UserDTO> users;
        if (keyword != null && !keyword.trim().isEmpty()) {
            // æœç´¢ç”¨æˆ·
            UserSearchCriteria criteria = new UserSearchCriteria();
            criteria.setKeyword(keyword);
            users = userService.searchUsers(criteria, pageable);
        } else {
            // è·å–æ‰€æœ‰ç”¨æˆ·
            users = userService.getUsers(pageable);
        }

        model.addAttribute("users", users);
        model.addAttribute("keyword", keyword);
        model.addAttribute("currentPage", page);
        model.addAttribute("totalPages", users.getTotalPages());
        model.addAttribute("totalElements", users.getTotalElements());

        return "user/list";
    }

    /**
     * ç”¨æˆ·è¯¦æƒ…é¡µé¢
     */
    @GetMapping("/{id}")
    public String viewUser(@PathVariable Long id, Model model) {
        log.debug("æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…: {}", id);

        UserDTO user = userService.getUserById(id)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));

        List<AddressDTO> addresses = addressService.getUserAddresses(id);

        model.addAttribute("user", user);
        model.addAttribute("addresses", addresses);

        return "user/detail";
    }

    /**
     * åˆ›å»ºç”¨æˆ·é¡µé¢
     */
    @GetMapping("/new")
    public String createUserForm(Model model) {
        log.debug("è®¿é—®åˆ›å»ºç”¨æˆ·é¡µé¢");

        model.addAttribute("user", new UserCreateDTO());
        model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());

        return "user/form";
    }

    /**
     * ç¼–è¾‘ç”¨æˆ·é¡µé¢
     */
    @GetMapping("/{id}/edit")
    public String editUserForm(@PathVariable Long id, Model model) {
        log.debug("è®¿é—®ç¼–è¾‘ç”¨æˆ·é¡µé¢: {}", id);

        UserDTO user = userService.getUserById(id)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));

        UserUpdateDTO updateDTO = new UserUpdateDTO();
        updateDTO.setEmail(user.getEmail());
        updateDTO.setFullName(user.getFullName());
        updateDTO.setPhoneNumber(user.getPhoneNumber());
        updateDTO.setGender(user.getGender());
        updateDTO.setBirthDate(user.getBirthDate());
        updateDTO.setAvatarUrl(user.getAvatarUrl());

        model.addAttribute("user", updateDTO);
        model.addAttribute("userId", id);
        model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());

        return "user/form";
    }

    /**
     * ä¿®æ”¹å¯†ç é¡µé¢
     */
    @GetMapping("/{id}/password")
    public String changePasswordForm(@PathVariable Long id, Model model) {
        log.debug("è®¿é—®ä¿®æ”¹å¯†ç é¡µé¢: {}", id);

        UserDTO user = userService.getUserById(id)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + id));

        model.addAttribute("user", user);
        model.addAttribute("passwordForm", new PasswordUpdateDTO());

        return "user/password";
    }

    // ==================== è¡¨å•å¤„ç† ====================

    /**
     * åˆ›å»ºç”¨æˆ·å¤„ç†
     */
    @PostMapping
    public String createUser(
            @Valid @ModelAttribute("user") UserCreateDTO userCreateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("åˆ›å»ºç”¨æˆ·è¯·æ±‚: {}", userCreateDTO.getUsername());

        // è‡ªå®šä¹‰éªŒè¯
        if (!userCreateDTO.isPasswordMatching()) {
            bindingResult.rejectValue("confirmPassword", "password.mismatch", "ç¡®è®¤å¯†ç ä¸åŒ¹é…");
        }

        if (bindingResult.hasErrors()) {
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            return "user/form";
        }

        try {
            UserDTO createdUser = userService.createUser(userCreateDTO);

            redirectAttributes.addFlashAttribute("successMessage",
                "ç”¨æˆ·åˆ›å»ºæˆåŠŸ: " + createdUser.getUsername());
            redirectAttributes.addAttribute("id", createdUser.getId());

            return "redirect:/users/{id}";

        } catch (Exception e) {
            log.error("åˆ›å»ºç”¨æˆ·å¤±è´¥", e);
            model.addAttribute("errorMessage", "åˆ›å»ºç”¨æˆ·å¤±è´¥: " + e.getMessage());
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            return "user/form";
        }
    }

    /**
     * æ›´æ–°ç”¨æˆ·å¤„ç†
     */
    @PutMapping("/{id}")
    public String updateUser(
            @PathVariable Long id,
            @Valid @ModelAttribute("user") UserUpdateDTO userUpdateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("æ›´æ–°ç”¨æˆ·è¯·æ±‚: {}", id);

        if (bindingResult.hasErrors()) {
            model.addAttribute("userId", id);
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            return "user/form";
        }

        try {
            UserDTO updatedUser = userService.updateUser(id, userUpdateDTO);

            redirectAttributes.addFlashAttribute("successMessage",
                "ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ");
            redirectAttributes.addAttribute("id", updatedUser.getId());

            return "redirect:/users/{id}";

        } catch (Exception e) {
            log.error("æ›´æ–°ç”¨æˆ·å¤±è´¥", e);
            model.addAttribute("errorMessage", "æ›´æ–°ç”¨æˆ·å¤±è´¥: " + e.getMessage());
            model.addAttribute("userId", id);
            model.addAttribute("genders", com.cmliy.springweb.entity.enums.Gender.values());
            return "user/form";
        }
    }

    /**
     * ä¿®æ”¹å¯†ç å¤„ç†
     */
    @PutMapping("/{id}/password")
    public String changePassword(
            @PathVariable Long id,
            @Valid @ModelAttribute("passwordForm") PasswordUpdateDTO passwordUpdateDTO,
            BindingResult bindingResult,
            Model model,
            RedirectAttributes redirectAttributes) {

        log.info("ä¿®æ”¹å¯†ç è¯·æ±‚: {}", id);

        // è‡ªå®šä¹‰éªŒè¯
        if (!passwordUpdateDTO.isNewPasswordMatching()) {
            bindingResult.rejectValue("confirmPassword", "password.mismatch", "ç¡®è®¤å¯†ç ä¸åŒ¹é…");
        }

        if (bindingResult.hasErrors()) {
            UserDTO user = userService.getUserById(id).orElse(null);
            model.addAttribute("user", user);
            return "user/password";
        }

        try {
            userService.changePassword(id,
                passwordUpdateDTO.getCurrentPassword(),
                passwordUpdateDTO.getNewPassword());

            redirectAttributes.addFlashAttribute("successMessage", "å¯†ç ä¿®æ”¹æˆåŠŸ");

            return "redirect:/users/{id}";

        } catch (Exception e) {
            log.error("ä¿®æ”¹å¯†ç å¤±è´¥", e);
            model.addAttribute("errorMessage", "ä¿®æ”¹å¯†ç å¤±è´¥: " + e.getMessage());
            UserDTO user = userService.getUserById(id).orElse(null);
            model.addAttribute("user", user);
            return "user/password";
        }
    }

    /**
     * åˆ é™¤ç”¨æˆ·å¤„ç†
     */
    @DeleteMapping("/{id}")
    public String deleteUser(
            @PathVariable Long id,
            RedirectAttributes redirectAttributes) {

        log.info("åˆ é™¤ç”¨æˆ·è¯·æ±‚: {}", id);

        try {
            userService.deleteUser(id);
            redirectAttributes.addFlashAttribute("successMessage", "ç”¨æˆ·åˆ é™¤æˆåŠŸ");

        } catch (Exception e) {
            log.error("åˆ é™¤ç”¨æˆ·å¤±è´¥", e);
            redirectAttributes.addFlashAttribute("errorMessage", "åˆ é™¤ç”¨æˆ·å¤±è´¥: " + e.getMessage());
        }

        return "redirect:/users";
    }

    /**
     * åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
     */
    @PostMapping("/{id}/toggle-status")
    public String toggleUserStatus(
            @PathVariable Long id,
            @RequestParam boolean enabled,
            RedirectAttributes redirectAttributes) {

        log.info("åˆ‡æ¢ç”¨æˆ·çŠ¶æ€: {} -> {}", id, enabled);

        try {
            userService.toggleUserStatus(id, enabled);
            String status = enabled ? "å¯ç”¨" : "ç¦ç”¨";
            redirectAttributes.addFlashAttribute("successMessage",
                "ç”¨æˆ·" + status + "æˆåŠŸ");

        } catch (Exception e) {
            log.error("åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥", e);
            redirectAttributes.addFlashAttribute("errorMessage",
                "æ“ä½œå¤±è´¥: " + e.getMessage());
        }

        return "redirect:/users";
    }

    // ==================== APIæ¥å£ ====================

    /**
     * è·å–ç”¨æˆ·API
     */
    @GetMapping("/{id}/api")
    @ResponseBody
    public ResponseEntity<ApiResponse<UserDTO>> getUserApi(@PathVariable Long id) {
        log.debug("APIè·å–ç”¨æˆ·: {}", id);

        return userService.getUserById(id)
                .map(user -> ResponseEntity.ok(ApiResponse.success(user)))
                .orElse(ResponseEntity.status(HttpStatus.NOT_FOUND)
                        .body(ApiResponse.error("ç”¨æˆ·ä¸å­˜åœ¨")));
    }

    /**
     * æœç´¢ç”¨æˆ·API
     */
    @GetMapping("/search/api")
    @ResponseBody
    public ResponseEntity<ApiResponse<PageResponse<UserDTO>>> searchUsersApi(
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String sortDir) {

        log.debug("APIæœç´¢ç”¨æˆ·: keyword={}, page={}, size={}", keyword, page, size);

        try {
            UserSearchCriteria criteria = new UserSearchCriteria();
            criteria.setKeyword(keyword);

            Sort sort = sortDir.equalsIgnoreCase("desc") ?
                Sort.by(sortBy).descending() : Sort.by(sortBy).ascending();
            Pageable pageable = PageRequest.of(page, size, sort);

            Page<UserDTO> users = userService.searchUsers(criteria, pageable);
            PageResponse<UserDTO> response = PageResponse.of(users);

            return ResponseEntity.ok(ApiResponse.success(response));

        } catch (Exception e) {
            log.error("æœç´¢ç”¨æˆ·å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("æœç´¢å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * æ‰¹é‡æ“ä½œAPI
     */
    @PostMapping("/batch/api")
    @ResponseBody
    public ResponseEntity<ApiResponse<BatchOperationResult>> batchOperationApi(
            @RequestBody BatchOperationRequest request) {

        log.info("æ‰¹é‡æ“ä½œAPI: operation={}, userIds={}",
            request.getOperation(), request.getUserIds());

        try {
            BatchOperationResult result;

            switch (request.getOperation()) {
                case "enable":
                    result = userService.batchUpdateUserStatus(request.getUserIds(), true);
                    break;
                case "disable":
                    result = userService.batchUpdateUserStatus(request.getUserIds(), false);
                    break;
                case "delete":
                    result = userService.batchDeleteUsers(request.getUserIds());
                    break;
                default:
                    return ResponseEntity.badRequest()
                            .body(ApiResponse.error("ä¸æ”¯æŒçš„æ“ä½œç±»å‹: " + request.getOperation()));
            }

            return ResponseEntity.ok(ApiResponse.success(result));

        } catch (Exception e) {
            log.error("æ‰¹é‡æ“ä½œå¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("æ‰¹é‡æ“ä½œå¤±è´¥: " + e.getMessage()));
        }
    }
}
```

### 2. RESTful APIæ§åˆ¶å™¨

```java
package com.cmliy.springweb.controller.api;

import com.cmliy.springweb.dto.*;
import com.cmliy.springweb.service.UserService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * ç”¨æˆ·RESTful APIæ§åˆ¶å™¨
 */
@Slf4j
@RestController
@RequestMapping("/api/v1/users")
@RequiredArgsConstructor
public class UserApiController {

    private final UserService userService;

    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping
    public ResponseEntity<ApiResponse<PageResponse<UserDTO>>> getUsers(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String sortDir) {

        log.debug("APIè·å–ç”¨æˆ·åˆ—è¡¨: page={}, size={}", page, size);

        Sort sort = sortDir.equalsIgnoreCase("desc") ?
            Sort.by(sortBy).descending() : Sort.by(sortBy).ascending();
        Pageable pageable = PageRequest.of(page, size, sort);

        Page<UserDTO> users = userService.getUsers(pageable);
        PageResponse<UserDTO> response = PageResponse.of(users);

        return ResponseEntity.ok(ApiResponse.success(response));
    }

    /**
     * æœç´¢ç”¨æˆ·
     */
    @GetMapping("/search")
    public ResponseEntity<ApiResponse<PageResponse<UserDTO>>> searchUsers(
            @ModelAttribute UserSearchCriteria criteria,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {

        log.debug("APIæœç´¢ç”¨æˆ·: criteria={}", criteria);

        Sort sort = Sort.by(Sort.Direction.fromString(criteria.getSortDirection()),
                          criteria.getSortBy());
        Pageable pageable = PageRequest.of(page, size, sort);

        Page<UserDTO> users = userService.searchUsers(criteria, pageable);
        PageResponse<UserDTO> response = PageResponse.of(users);

        return ResponseEntity.ok(ApiResponse.success(response));
    }

    /**
     * æ ¹æ®IDè·å–ç”¨æˆ·
     */
    @GetMapping("/{id}")
    public ResponseEntity<ApiResponse<UserDTO>> getUser(@PathVariable Long id) {
        log.debug("APIè·å–ç”¨æˆ·: {}", id);

        return userService.getUserById(id)
                .map(user -> ResponseEntity.ok(ApiResponse.success(user)))
                .orElse(ResponseEntity.status(HttpStatus.NOT_FOUND)
                        .body(ApiResponse.error("ç”¨æˆ·ä¸å­˜åœ¨", "USER_NOT_FOUND")));
    }

    /**
     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·
     */
    @GetMapping("/username/{username}")
    public ResponseEntity<ApiResponse<UserDTO>> getUserByUsername(@PathVariable String username) {
        log.debug("APIæ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·: {}", username);

        return userService.getUserByUsername(username)
                .map(user -> ResponseEntity.ok(ApiResponse.success(user)))
                .orElse(ResponseEntity.status(HttpStatus.NOT_FOUND)
                        .body(ApiResponse.error("ç”¨æˆ·ä¸å­˜åœ¨", "USER_NOT_FOUND")));
    }

    /**
     * åˆ›å»ºç”¨æˆ·
     */
    @PostMapping
    public ResponseEntity<ApiResponse<UserDTO>> createUser(
            @Valid @RequestBody UserCreateDTO userCreateDTO) {

        log.info("APIåˆ›å»ºç”¨æˆ·: {}", userCreateDTO.getUsername());

        if (!userCreateDTO.isPasswordMatching()) {
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("ç¡®è®¤å¯†ç ä¸åŒ¹é…", "PASSWORD_MISMATCH"));
        }

        try {
            UserDTO createdUser = userService.createUser(userCreateDTO);
            return ResponseEntity.status(HttpStatus.CREATED)
                    .body(ApiResponse.success("ç”¨æˆ·åˆ›å»ºæˆåŠŸ", createdUser));

        } catch (Exception e) {
            log.error("APIåˆ›å»ºç”¨æˆ·å¤±è´¥", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("åˆ›å»ºç”¨æˆ·å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * æ›´æ–°ç”¨æˆ·
     */
    @PutMapping("/{id}")
    public ResponseEntity<ApiResponse<UserDTO>> updateUser(
            @PathVariable Long id,
            @Valid @RequestBody UserUpdateDTO userUpdateDTO) {

        log.info("APIæ›´æ–°ç”¨æˆ·: {}", id);

        try {
            UserDTO updatedUser = userService.updateUser(id, userUpdateDTO);
            return ResponseEntity.ok(ApiResponse.success("ç”¨æˆ·æ›´æ–°æˆåŠŸ", updatedUser));

        } catch (Exception e) {
            log.error("APIæ›´æ–°ç”¨æˆ·å¤±è´¥", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("æ›´æ–°ç”¨æˆ·å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * éƒ¨åˆ†æ›´æ–°ç”¨æˆ·
     */
    @PatchMapping("/{id}")
    public ResponseEntity<ApiResponse<UserDTO>> patchUser(
            @PathVariable Long id,
            @RequestBody UserUpdateDTO userUpdateDTO) {

        log.info("APIéƒ¨åˆ†æ›´æ–°ç”¨æˆ·: {}", id);

        try {
            UserDTO existingUser = userService.getUserById(id)
                    .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));

            // åªæ›´æ–°éç©ºå­—æ®µ
            if (userUpdateDTO.getEmail() != null) existingUser.setEmail(userUpdateDTO.getEmail());
            if (userUpdateDTO.getFullName() != null) existingUser.setFullName(userUpdateDTO.getFullName());
            // ... å…¶ä»–å­—æ®µ

            UserDTO updatedUser = userService.updateUser(id, userUpdateDTO);
            return ResponseEntity.ok(ApiResponse.success("ç”¨æˆ·éƒ¨åˆ†æ›´æ–°æˆåŠŸ", updatedUser));

        } catch (Exception e) {
            log.error("APIéƒ¨åˆ†æ›´æ–°ç”¨æˆ·å¤±è´¥", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("æ›´æ–°ç”¨æˆ·å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * åˆ é™¤ç”¨æˆ·
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<ApiResponse<Void>> deleteUser(@PathVariable Long id) {
        log.info("APIåˆ é™¤ç”¨æˆ·: {}", id);

        try {
            userService.deleteUser(id);
            return ResponseEntity.ok(ApiResponse.success("ç”¨æˆ·åˆ é™¤æˆåŠŸ", null));

        } catch (Exception e) {
            log.error("APIåˆ é™¤ç”¨æˆ·å¤±è´¥", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("åˆ é™¤ç”¨æˆ·å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * æ‰¹é‡åˆ é™¤ç”¨æˆ·
     */
    @DeleteMapping("/batch")
    public ResponseEntity<ApiResponse<BatchOperationResult>> batchDeleteUsers(
            @RequestBody List<Long> userIds) {

        log.info("APIæ‰¹é‡åˆ é™¤ç”¨æˆ·: count={}", userIds.size());

        try {
            BatchOperationResult result = userService.batchDeleteUsers(userIds);
            return ResponseEntity.ok(ApiResponse.success("æ‰¹é‡åˆ é™¤å®Œæˆ", result));

        } catch (Exception e) {
            log.error("APIæ‰¹é‡åˆ é™¤ç”¨æˆ·å¤±è´¥", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("æ‰¹é‡åˆ é™¤å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * é‡ç½®ç”¨æˆ·å¯†ç 
     */
    @PostMapping("/{id}/reset-password")
    public ResponseEntity<ApiResponse<Void>> resetPassword(
            @PathVariable Long id,
            @RequestBody PasswordResetDTO resetDTO) {

        log.info("APIé‡ç½®ç”¨æˆ·å¯†ç : {}", id);

        try {
            userService.resetPassword(id, resetDTO.getNewPassword());
            return ResponseEntity.ok(ApiResponse.success("å¯†ç é‡ç½®æˆåŠŸ", null));

        } catch (Exception e) {
            log.error("APIé‡ç½®å¯†ç å¤±è´¥", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("é‡ç½®å¯†ç å¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
     */
    @PostMapping("/{id}/toggle-status")
    public ResponseEntity<ApiResponse<Void>> toggleUserStatus(
            @PathVariable Long id,
            @RequestBody UserStatusToggleDTO toggleDTO) {

        log.info("APIåˆ‡æ¢ç”¨æˆ·çŠ¶æ€: {} -> {}", id, toggleDTO.getEnabled());

        try {
            userService.toggleUserStatus(id, toggleDTO.getEnabled());
            String status = toggleDTO.getEnabled() ? "å¯ç”¨" : "ç¦ç”¨";
            return ResponseEntity.ok(ApiResponse.success("ç”¨æˆ·" + status + "æˆåŠŸ", null));

        } catch (Exception e) {
            log.error("APIåˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("æ“ä½œå¤±è´¥: " + e.getMessage()));
        }
    }

    /**
     * è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
     */
    @GetMapping("/stats")
    public ResponseEntity<ApiResponse<UserStatsDTO>> getUserStats() {
        log.debug("APIè·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯");

        try {
            UserStatsDTO stats = UserStatsDTO.builder()
                    .totalCount(userService.getTotalUserCount())
                    .enabledCount(userService.getEnabledUserCount())
                    .disabledCount(userService.getTotalUserCount() - userService.getEnabledUserCount())
                    .roleDistribution(userService.getUserCountByRole())
                    .build();

            return ResponseEntity.ok(ApiResponse.success(stats));

        } catch (Exception e) {
            log.error("APIè·å–ç”¨æˆ·ç»Ÿè®¡å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: " + e.getMessage()));
        }
    }
}
```

## ğŸ“š Spring MVCå¸¸ç”¨æ³¨è§£

### 1. è¯·æ±‚æ˜ å°„æ³¨è§£

```java
@RestController
public class AnnotationExampleController {

    // åŸºç¡€æ˜ å°„
    @GetMapping("/users")           // GETè¯·æ±‚
    @PostMapping("/users")          // POSTè¯·æ±‚
    @PutMapping("/users/{id}")      // PUTè¯·æ±‚
    @DeleteMapping("/users/{id}")   // DELETEè¯·æ±‚
    @PatchMapping("/users/{id}")    // PATCHè¯·æ±‚

    // ç±»çº§åˆ«æ˜ å°„
    @RequestMapping("/api/users")   // æ”¯æŒæ‰€æœ‰HTTPæ–¹æ³•
    @RequestMapping(value = "/users", method = RequestMethod.GET)

    // è·¯å¾„å˜é‡
    @GetMapping("/users/{id}")
    public String getUser(@PathVariable Long id) { }

    // è¯·æ±‚å‚æ•°
    @GetMapping("/users")
    public String listUsers(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(required = false) String keyword) { }

    // è¯·æ±‚å¤´
    @GetMapping("/users")
    public String getUsers(
            @RequestHeader("Authorization") String auth,
            @RequestHeader(value = "User-Agent", defaultValue = "") String userAgent) { }

    // Cookieå€¼
    @GetMapping("/users")
    public String getUsers(
            @CookieValue(value = "sessionId", required = false) String sessionId) { }
}
```

### 2. è¯·æ±‚ä½“å’Œå‚æ•°ç»‘å®š

```java
@RestController
public class RequestBindingController {

    // JSONè¯·æ±‚ä½“
    @PostMapping("/users")
    public String createUser(@RequestBody UserCreateDTO userDTO) { }

    // è¡¨å•æ•°æ®
    @PostMapping("/users")
    public String createUserFromForm(@ModelAttribute UserCreateDTO userDTO) { }

    // æ–‡ä»¶ä¸Šä¼ 
    @PostMapping("/upload")
    public String uploadFile(@RequestParam("file") MultipartFile file) { }

    // å¤šæ–‡ä»¶ä¸Šä¼ 
    @PostMapping("/upload-multiple")
    public String uploadFiles(@RequestParam("files") MultipartFile[] files) { }

    // è·¯å¾„å˜é‡å’Œè¯·æ±‚å‚æ•°ç»„åˆ
    @GetMapping("/users/{userId}/orders/{orderId}")
    public String getUserOrder(
            @PathVariable Long userId,
            @PathVariable Long orderId,
            @RequestParam(defaultValue = "false") boolean includeDetails) { }
}
```

### 3. å“åº”ç›¸å…³æ³¨è§£

```java
@RestController
public class ResponseController {

    // ç›´æ¥è¿”å›å­—ç¬¦ä¸²
    @GetMapping("/hello")
    public String hello() {
        return "Hello, World!";
    }

    // è¿”å›JSONå¯¹è±¡
    @GetMapping("/user")
    public UserDTO getUser() {
        return new UserDTO();
    }

    // è®¾ç½®å“åº”çŠ¶æ€ç 
    @PostMapping("/users")
    @ResponseStatus(HttpStatus.CREATED)
    public UserDTO createUser(@RequestBody UserCreateDTO dto) {
        return userService.createUser(dto);
    }

    // è®¾ç½®å“åº”å¤´
    @GetMapping("/download")
    public ResponseEntity<Resource> downloadFile() {
        Resource file = new FileSystemResource("path/to/file.pdf");
        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=file.pdf")
                .contentType(MediaType.APPLICATION_PDF)
                .body(file);
    }

    // å®Œæ•´çš„ResponseEntity
    @GetMapping("/users/{id}")
    public ResponseEntity<UserDTO> getUser(@PathVariable Long id) {
        Optional<UserDTO> user = userService.getUserById(id);

        if (user.isPresent()) {
            return ResponseEntity.ok(user.get());
        } else {
            return ResponseEntity.notFound().build();
        }
    }
}
```

## ğŸ¯ æ§åˆ¶å™¨è®¾è®¡æœ€ä½³å®è·µ

### 1. èŒè´£åˆ†ç¦»

```java
// âœ… å¥½çš„åšæ³•ï¼šæ§åˆ¶å™¨åªè´Ÿè´£è¯·æ±‚å¤„ç†
@Controller
public class UserController {

    @GetMapping("/users/{id}")
    public String getUser(@PathVariable Long id, Model model) {
        // åªè°ƒç”¨Serviceå±‚ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
        UserDTO user = userService.getUserById(id)
                .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        model.addAttribute("user", user);
        return "user/detail";
    }
}

// âŒ é¿å…çš„åšæ³•ï¼šåœ¨æ§åˆ¶å™¨ä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘
@Controller
public class BadUserController {

    @GetMapping("/users/{id}")
    public String getUser(@PathVariable Long id, Model model) {
        // é”™è¯¯ï¼šåœ¨æ§åˆ¶å™¨ä¸­è¿›è¡Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¤„ç†
        User user = userRepository.findById(id).orElse(null);
        if (user != null && user.getEnabled() && !user.isExpired()) {
            // å¤æ‚çš„ä¸šåŠ¡åˆ¤æ–­é€»è¾‘
            if (user.getRole() == Role.ADMIN || user.getPermissions().contains("READ_USER")) {
                model.addAttribute("user", user);
                return "user/detail";
            }
        }
        return "error/404";
    }
}
```

### 2. å¼‚å¸¸å¤„ç†

```java
@Controller
public class UserController {

    @GetMapping("/users/{id}")
    public String getUser(@PathVariable Long id, Model model) {
        try {
            UserDTO user = userService.getUserById(id)
                    .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

            model.addAttribute("user", user);
            return "user/detail";

        } catch (UserNotFoundException e) {
            log.warn("ç”¨æˆ·ä¸å­˜åœ¨: {}", id);
            return "error/404";
        } catch (Exception e) {
            log.error("è·å–ç”¨æˆ·å¤±è´¥", e);
            return "error/500";
        }
    }
}
```

### 3. æ•°æ®éªŒè¯

```java
@Controller
public class UserValidationController {

    @PostMapping("/users")
    public String createUser(
            @Valid @ModelAttribute UserCreateDTO userDTO,
            BindingResult bindingResult,
            Model model) {

        if (bindingResult.hasErrors()) {
            // éªŒè¯å¤±è´¥ï¼Œè¿”å›è¡¨å•é¡µé¢
            model.addAttribute("errors", bindingResult.getAllErrors());
            return "user/form";
        }

        // è‡ªå®šä¹‰éªŒè¯
        if (!userDTO.isPasswordMatching()) {
            bindingResult.rejectValue("confirmPassword", "password.mismatch", "ç¡®è®¤å¯†ç ä¸åŒ¹é…");
            return "user/form";
        }

        // éªŒè¯é€šè¿‡ï¼Œåˆ›å»ºç”¨æˆ·
        UserDTO createdUser = userService.createUser(userDTO);
        return "redirect:/users/" + createdUser.getId();
    }
}
```

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ç†è§£Controllerå±‚çš„ä½œç”¨å’ŒèŒè´£
- [ ] æŒæ¡Spring MVCå¸¸ç”¨æ³¨è§£çš„ä½¿ç”¨
- [ ] å®ç°Webé¡µé¢è·¯ç”±å’ŒAPIæ¥å£
- [ ] å¤„ç†è¡¨å•æäº¤å’Œæ•°æ®éªŒè¯
- [ ] äº†è§£æ§åˆ¶å™¨è®¾è®¡çš„æœ€ä½³å®è·µ

## ğŸš€ ä¸‹ä¸€æ­¥

æ§åˆ¶å™¨å¼€å‘å®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š
[RESTful APIè®¾è®¡](02-RESTful-API.md)

---

**æç¤º**: æ§åˆ¶å™¨æ˜¯Webåº”ç”¨çš„å…¥å£ï¼Œåº”è¯¥ä¿æŒç®€æ´ï¼Œä¸“æ³¨äºè¯·æ±‚å¤„ç†å’Œå“åº”æ„å»ºï¼Œå¤æ‚ä¸šåŠ¡é€»è¾‘åº”è¯¥åœ¨Serviceå±‚å®ç°ã€‚