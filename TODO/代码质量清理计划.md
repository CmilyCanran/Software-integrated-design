# 代码质量清理计划 - TODO清单

## 🎯 分析总结

通过全面分析Spring Boot + Vue 3服装电商项目，发现了以下主要问题类别：

### 🚨 **关键安全风险**
- **硬编码敏感信息**: JWT密钥、数据库密码直接写在代码中
- **CORS配置过于宽松**: 允许所有来源访问
- **输入验证缺失**: 控制器直接接收参数未验证
- **信息泄露**: 生产环境暴露堆栈跟踪

### 💻 **代码冗余与重复**
- **认证逻辑重复**: 多个控制器中重复的用户认证检查
- **错误响应格式不统一**: 混合使用原始异常和ApiResponse包装
- **DTO转换逻辑重复**: 相似的实体转换模式在多处重复
- **前端错误处理重复**: request.ts和各API调用中重复的错误处理

### 🐛 **错误与易错模式**
- **类型安全违规**: 前端大量使用`as any`绕过类型检查
- **内存泄漏风险**: SearchBox组件未正确清理事件监听器
- **复杂的条件逻辑**: ProductForm规格处理逻辑混乱
- **空指针风险**: AuthController中直接访问Map元素未做null检查

### 🔧 **配置与环境问题**
- **硬编码配置**: API基础URL、超时时间等硬编码
- **日志不一致**: 混用System.out/err和log框架
- **性能问题**: N+1查询风险、缺少缓存策略

---

## 📋 清理任务清单

### 🚪 **第一阶段：立即处理（关键安全）**

#### ✅ 任务1.1：移动敏感配置到环境变量
- [ ] **后端 application.yml**
  - [ ] 将数据库密码移至环境变量 `${DB_PASSWORD}`
  - [ ] 将数据库用户名移至环境变量 `${DB_USERNAME}`
  - [ ] 将数据库URL移至环境变量 `${DB_URL}`
  - [ ] 创建 `.env.example` 文件作为模板

- [ ] **后端 JwtUtil.java**
  - [ ] 将硬编码JWT密钥移至环境变量 `${JWT_SECRET}`
  - [ ] 将JWT过期时间移至配置文件 `${JWT_EXPIRATION}`

- [ ] **前端 request.ts**
  - [ ] 将API基础URL移至环境变量 `VITE_API_BASE_URL`
  - [ ] 将超时时间移至环境变量 `VITE_REQUEST_TIMEOUT`
  - [ ] 创建 `.env.example` 文件作为模板

#### ✅ 任务1.2：修复CORS配置
- [ ] **WebSecurityConfig.java**
  - [ ] 限制允许的域名，禁止通配符 `*`
  - [ ] 区分开发环境和生产环境配置
  - [ ] 添加CORS配置的环境变量支持

#### ✅ 任务1.3：添加输入验证
- [ ] **AuthController.java**
  - [ ] 为登录请求添加 `@Valid` 注解
  - [ ] 创建 `LoginRequest` DTO类
  - [ ] 添加字段验证注解（@NotNull, @NotBlank, @Size）

- [ ] **ProductController.java**
  - [ ] 为所有请求参数添加验证
  - [ ] 创建相应的DTO类
  - [ ] 添加业务逻辑验证

---

### ⚡ **第二阶段：短期处理（高优先级）**

#### ✅ 任务2.1：统一错误处理
- [ ] **后端统一化**
  - [ ] 确保所有控制器使用 `ApiResponse` 格式
  - [ ] 移除所有 `System.out.println()` 和 `System.err.println()`
  - [ ] 统一使用 SLF4J 日志框架
  - [ ] 在 `GlobalExceptionHandler.java` 中移除堆栈跟踪暴露

- [ ] **前端统一化**
  - [ ] 在 `request.ts` 中统一错误处理逻辑
  - [ ] 创建全局错误处理组件
  - [ ] 移除各组件中重复的错误处理代码

#### ✅ 任务2.2：消除代码重复
- [ ] **后端重构**
  - [ ] 创建 `BaseController` 基类，包含通用认证逻辑
  - [ ] 提取通用DTO转换工具类
  - [ ] 创建通用的响应包装工具

- [ ] **前端重构**
  - [ ] 整理 `types/` 目录，共享类型定义
  - [ ] 提取通用API调用逻辑
  - [ ] 创建通用的表单验证逻辑

#### ✅ 任务2.3：修复类型安全问题
- [ ] **前端类型修复**
  - [ ] 移除所有 `as any` 使用，添加正确类型定义
  - [ ] 修复 `SearchBox.vue` 内存泄漏问题
  - [ ] 为所有组件添加正确的Props类型定义
  - [ ] 修复未处理的Promise rejection

- [ ] **ProductForm.vue 重构**
  - [ ] 简化规格处理逻辑
  - [ ] 将复杂逻辑拆分为独立函数
  - [ ] 添加适当的类型定义

---

### 🔄 **第三阶段：中期处理（性能优化）**

#### ✅ 任务3.1：性能优化
- [ ] **后端优化**
  - [ ] 实现Redis缓存策略
  - [ ] 优化数据库查询，避免N+1问题
  - [ ] 添加分页支持到所有列表端点
  - [ ] 实现请求去重机制

- [ ] **前端优化**
  - [ ] 实现Element Plus按需加载
  - [ ] 添加HTTP请求缓存
  - [ ] 优化组件渲染性能
  - [ ] 实现虚拟滚动（如需要）

#### ✅ 任务3.2：测试覆盖
- [ ] **后端测试**
  - [ ] 添加JWT认证流程测试
  - [ ] 添加GlobalExceptionHandler测试
  - [ ] 创建集成测试（使用TestContainers）
  - [ ] 添加API契约测试

- [ ] **前端测试**
  - [ ] 使用Vitest添加单元测试
  - [ ] 添加组件测试
  - [ ] 创建E2E测试

---

## 🎯 具体文件修改清单

### 后端关键文件
- [ ] `src/main/resources/application.yml` - 移除硬编码配置
- [ ] `src/main/java/com/cmliy/springweb/security/JwtUtil.java` - 移除硬编码密钥
- [ ] `src/main/java/com/cmliy/springweb/controller/AuthController.java` - 添加输入验证
- [ ] `src/main/java/com/cmliy/springweb/controller/ProductController.java` - 简化认证逻辑
- [ ] `src/main/java/com/cmliy/springweb/exception/GlobalExceptionHandler.java` - 移除堆栈跟踪暴露
- [ ] `src/main/java/com/cmliy/springweb/security/WebSecurityConfig.java` - 修复CORS配置

### 前端关键文件
- [ ] `frontend/src/api/request.ts` - 移除硬编码URL，统一错误处理
- [ ] `frontend/src/components/ProductForm.vue` - 简化规格处理逻辑
- [ ] `frontend/src/components/SearchBox.vue` - 修复内存泄漏
- [ ] `frontend/src/stores/auth.ts` - 统一状态管理模式
- [ ] `frontend/src/types/` - 整理和共享类型定义

### 新增文件
- [ ] `.env.example` - 环境变量模板
- [ ] `src/main/java/com/cmliy/springweb/controller/BaseController.java` - 基础控制器
- [ ] `src/main/java/com/cmliy/springweb/util/DtoConverter.java` - DTO转换工具
- [ ] `frontend/src/types/common.ts` - 通用类型定义
- [ ] `frontend/src/utils/errorHandler.ts` - 错误处理工具

---

## 📊 预期收益

### 安全性提升
- [x] 消除硬编码敏感信息风险
- [x] 加强输入验证和CORS保护
- [x] 统一错误处理避免信息泄露

### 代码质量提升
- [x] 减少30%以上的重复代码
- [x] 提高类型安全性
- [x] 统一编码规范和模式

### 性能优化
- [x] 减少不必要的API调用
- [x] 优化前端资源加载
- [x] 提升数据库查询效率

### 可维护性提升
- [x] 清晰的错误处理流程
- [x] 统一的代码结构
- [x] 更好的测试覆盖率

---

## 📝 执行说明

### 执行顺序
1. **严格按照阶段顺序执行**，先解决安全问题
2. **每个阶段内任务可以并行执行**
3. **每个任务完成后进行测试验证**
4. **定期提交代码，保持版本控制**

### 验证标准
- [ ] 所有安全配置必须通过安全扫描
- [ ] 所有代码必须通过ESLint/Checkstyle检查
- [ ] 所有测试必须通过
- [ ] 功能回归测试必须通过

### 注意事项
- **备份重要文件** before making changes
- **测试环境先行**，再应用到生产环境
- **文档同步更新**，记录所有变更
- **团队沟通**，确保所有成员了解变更

---

## 🚀 开始执行

### 今日任务（建议）
1. 完成 **任务1.1** - 移动敏感配置到环境变量
2. 完成 **任务1.2** - 修复CORS配置
3. 测试验证安全配置是否生效

### 本周目标
- 完成第一阶段所有任务
- 开始第二阶段的前两个任务
- 建立代码质量监控机制

---

*最后更新时间: 2025-11-30*
*负责人: 开发团队*
*预计完成时间: 2-3周*